<!DOCTYPE html>
<html>
<head>
  <!-- Replace the mock Vue implementation with the actual Vue.js library -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
  <!-- Loading indicator -->
  <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100vh;">
    Loading...
  </div>

  <!-- Main app -->
  <div id="app">
    <div v-cloak class="plugin-container">
      <div class="content-section">
        <!-- First section content (selection and settings) -->
        <div class="scan-section">
          <div class="step-container">
            <div class="step-content">
              <div class="step-header">
                <h3 class="step-title">Select frames or components</h3>
                <button 
                  class="watch-toggle" 
                  :class="{ 
                    active: isWatching,
                    disabled: !scanEntirePage 
                  }"
                  @click="toggleWatch"
                  :disabled="!scanEntirePage"
                  :title="watchButtonTitle"
                >
                  <div class="watch-toggle-content">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path v-if="isWatching && scanEntirePage" d="M8 3.33333C11.3333 3.33333 14.1667 5.33333 15.3333 8C14.1667 10.6667 11.3333 12.6667 8 12.6667C4.66667 12.6667 1.83333 10.6667 0.666667 8C1.83333 5.33333 4.66667 3.33333 8 3.33333Z" fill="currentColor"/>
                      <g v-else>
                        <path d="M2.66667 2L13.3333 14" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M8 3.33333C11.3333 3.33333 14.1667 5.33333 15.3333 8C14.1667 10.6667 11.3333 12.6667 8 12.6667C4.66667 12.6667 1.83333 10.6667 0.666667 8C1.83333 5.33333 4.66667 3.33333 8 3.33333Z" fill="currentColor" fill-opacity="0.5"/>
                      </g>
                    </svg>
                    <span class="watch-toggle-text">{{ isWatching && scanEntirePage ? 'Watching' : 'Watch changes' }}</span>
                  </div>
                </button>
              </div>

              <!-- After the scan-scope-selector div -->
              <div class="scan-settings">
                <div class="settings-header">
                  <h4 class="settings-title">Scan Settings</h4>
                  <button 
                    class="settings-toggle"
                    @click="showSettings = !showSettings"
                  >
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path 
                        :d="showSettings 
                          ? 'M4 10L8 6L12 10' 
                          : 'M4 6L8 10L12 6'" 
                        stroke="currentColor" 
                        stroke-width="1.5" 
                        stroke-linecap="round" 
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>
                </div>
                
                <div class="settings-content" v-show="showSettings">
                  <!-- Move Scan Entire Page here -->
                  <div class="setting-item">
                    <label class="toggle-label">
                      <div class="toggle-label-content">
                        <span>Scan Entire Page</span>
                        <span v-if="scanEntirePage" class="slow-badge">slow</span>
                        <span class="info-badge" title="Scan the entire page instead of selected frames">ⓘ</span>
                      </div>
                      <div class="toggle-wrapper">
                        <input 
                          type="checkbox" 
                          v-model="scanEntirePage"
                          class="toggle-input"
                          @change="handleScanScopeChange"
                        >
                        <div class="toggle-slider"></div>
                      </div>
                    </label>
                  </div>

                  <!-- Existing Ignore Hidden Layers setting -->
                  <div class="setting-item">
                    <label class="toggle-label">
                      <div class="toggle-label-content">
                        <span>Ignore Hidden Layers</span>
                        <span class="info-badge" title="Hidden layers will be excluded from the scan">ⓘ</span>
                      </div>
                      <div class="toggle-wrapper">
                        <input 
                          type="checkbox" 
                          v-model="ignoreHiddenLayers"
                          class="toggle-input"
                        >
                        <div class="toggle-slider"></div>
                      </div>
                    </label>
                  </div>
                </div>
              </div>

              <div class="selection-container">
                <div v-if="!hasSelection && !scanEntirePage" class="toast warning">
                  <div class="toast-icon">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33337L14.6667 13.3334H1.33334L8 1.33337ZM8 4.00004L3.73334 12H12.2667L8 4.00004ZM7.33334 6.66671H8.66668V9.33337H7.33334V6.66671ZM7.33334 10.6667H8.66668V12H7.33334V10.6667Z" fill="currentColor"/>
                    </svg>
                  </div>
                  <span class="toast-message">Select frames or sections to start scanning</span>
                </div>
                <div v-else-if="hasSelection && !scanEntirePage" class="toast success">
                  <div class="toast-icon">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33334C4.31811 1.33334 1.33334 4.31811 1.33334 8C1.33334 11.6819 4.31811 14.6667 8 14.6667C11.6819 14.6667 14.6667 11.6819 14.6667 8C14.6667 4.31811 11.6819 1.33334 8 1.33334ZM11.0607 6.27274L7.39401 9.93941L5.27274 7.81814L6.06069 7.03019L7.39401 8.36351L10.2727 5.48479L11.0607 6.27274Z" fill="currentColor"/>
                    </svg>
                  </div>
                  <span class="toast-message">{{ selectedCount }} {{ selectedCount === 1 ? 'item' : 'items' }} selected</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Results section -->
        <div class="results-section">
          <!-- Tab Navigation -->
          <div class="tab-navigation">
            <button 
              class="tab-button" 
              :class="{ active: activeTab === 'tokens' }"
              @click="activeTab = 'tokens'"
            >
              Unlinked Values
            </button>
            <button 
              class="tab-button tab-button-disabled"
              disabled
              @click.prevent
              style="pointer-events: none;"
            >
              <div class="tab-button-content">
                <span>Unlinked Tokens</span>
                <svg class="lock-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M3.5 4V3.5C3.5 2.11929 4.61929 1 6 1C7.38071 1 8.5 2.11929 8.5 3.5V4" stroke="currentColor"/>
                  <rect x="2.5" y="4" width="7" height="6" rx="1" stroke="currentColor"/>
                </svg>
              </div>
            </button>
          </div>

          <!-- Design Tokens Tab -->
          <div v-if="activeTab === 'tokens'" class="tab-content">
            <!-- Scan Type Selection -->
            <div class="step-container">
              <div class="step-content">
                <h3 class="step-title">Choose what to scan for</h3>
                <div class="scan-cards">
                  <div 
                    v-for="option in tokenScanOptions" 
                    :key="option.value"
                    class="scan-card"
                    :class="{ 'selected': selectedScanType === option.value }"
                    @click="selectedScanType = option.value"
                  >
                    <div class="scan-card-icon" v-html="icons[option.icon]"></div>
                    <div class="scan-card-content">
                      <div class="scan-card-title">{{ option.label }}</div>
                      <div class="scan-card-description">{{ option.description }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Scan Controls -->
            <div class="divider"></div>

            <div class="step-container">
              <div class="step-content">
                <h3 class="step-title">Start scanning</h3>
                <!-- Move progress bar here, right after the title -->
                <div class="progress-container">
                  <div class="progress-bar">
                    <div 
                      class="progress-fill" 
                      :style="{ 
                        width: isScanning ? `${scanProgress}%` : scanProgress === 100 ? '100%' : '0%',
                        opacity: isScanning ? 1 : scanProgress === 100 ? 1 : 0.3,
                        background: scanProgress === 100 && !isScanning ? 'var(--figma-color-bg-success)' : 'var(--figma-color-bg-brand)'
                      }"
                    ></div>
                    <div class="progress-text">
                      {{ scanProgress === 100 && !isScanning && Object.keys(groupedReferences).length === 0 ? 'Scan complete - No issues found' :
                         scanProgress === 100 && !isScanning ? 'Scan complete' :
                         isScanning ? `${Math.round(scanProgress)}%` : '0%' }}
                    </div>
                  </div>
                </div>
                <div class="scan-controls" style="margin-top: 8px;">
                  <button 
                    @click="(e) => startScan(false, e)" 
                    :disabled="isScanning || (!hasSelection && !scanEntirePage)" 
                    class="button primary-button"
                  >
                    Start Scan
                  </button>
                  <button 
                    @click="(e) => startScan(true, e)"
                    :disabled="!hasResults"
                    :class="{ 
                      'button': true,
                      'secondary-button': true,
                      'button-disabled': !hasResults 
                    }"
                    class="button secondary-button"
                  >
                    Rescan
                  </button>
                  <button 
                    v-if="isScanning" 
                    @click="stopScan" 
                    class="button secondary-button"
                  >
                    Stop
                  </button>
                </div>
              </div>
            </div>

            <!-- Add a new section for scan results with consistent styling -->
            <template v-if="!isScanning && Object.keys(groupedReferences).length > 0">
              <div class="divider"></div>
              
              <div class="step-container">
                <div class="step-content">
                  <div class="results-header">
                    <div class="step-title-with-badge">
                      <h3 class="step-title">Scan results</h3>
                      <span class="results-badge">
                        {{ Object.values(groupedByValue).reduce((sum, group) => sum + group.refs.length, 0) }}
                      </span>
                    </div>
                    <div class="results-actions">
                      <button 
                        class="button secondary-button"
                        @click="clearResults"
                      >
                        Clear
                      </button>
                    </div>
                  </div>
                  <div class="results-container">
                    <div v-for="(group, groupKey) in groupedByValue" :key="groupKey" class="value-group">
                      <!-- Value Group Header -->
                      <div class="value-group-header" @click="toggleGroup(groupKey)">
                        <div class="header-left">
                          <span class="expand-icon">{{ isGroupExpanded(groupKey) ? '▼' : '▶' }}</span>
                          <!-- Special handling for typography items -->
                          <template v-if="group.refs[0]?.type === 'typography'">
                            <div class="typography-info">
                              <div class="typography-tags">
                                <span class="typography-tag font-family">{{ group.refs[0].currentValue.fontFamily }}</span>
                                <span class="typography-tag weight">{{ group.refs[0].currentValue.fontWeight }}</span>
                                <span class="typography-tag size">{{ group.refs[0].currentValue.fontSize }}px</span>
                              </div>
                            </div>
                          </template>
                          <template v-else-if="group.refs[0]?.type === 'fill' || group.refs[0]?.type === 'stroke'">
                            <color-preview :color="group.value" />
                          </template>
                          <template v-else-if="group.refs[0]?.type === 'gap'">
                            <span class="value-label">{{ formatGapValue(group.value, group.refs[0]) }}</span>
                          </template>
                          <template v-else>
                            <span class="value-label">{{ formatValue(group.value) }}</span>
                          </template>
                        </div>
                        <div class="header-right">
                          <span class="total-count">{{ group.refs.length }} instances</span>
                          <button 
                            class="select-button" 
                            :class="{ 'loading': isSelecting(groupKey) }"
                            @click.stop="selectGroup(group.refs, groupKey)"
                            :disabled="isSelecting(groupKey)"
                          >
                            <span v-if="!isSelecting(groupKey)">Select All</span>
                            <span v-else class="loading-spinner"></span>
                          </button>
                        </div>
                      </div>

                      <!-- Expanded Content -->
                      <div v-if="isGroupExpanded(groupKey)" class="reference-details">
                        <div v-for="ref in group.refs" :key="ref.nodeId" class="reference-item">
                          <!-- Special handling for typography items -->
                          <template v-if="ref.type === 'typography'">
                            <div class="typography-details">
                              <div class="typography-preview">{{ ref.currentValue.content }}</div>
                              <div class="typography-specs">
                                <div class="typography-tags">
                                  <span class="typography-tag font-family">{{ ref.currentValue.fontFamily }}</span>
                                  <span class="typography-tag weight">{{ ref.currentValue.fontWeight }}</span>
                                  <span class="typography-tag size">{{ ref.currentValue.fontSize }}px</span>
                                  <span v-if="ref.currentValue.lineHeight" class="typography-tag">LH: {{ ref.currentValue.lineHeight }}</span>
                                  <span v-if="ref.currentValue.letterSpacing" class="typography-tag">LS: {{ ref.currentValue.letterSpacing }}</span>
                                </div>
                              </div>
                            </div>
                          </template>
                          <template v-else>
                            <div class="reference-name">{{ ref.nodeName }}</div>
                            <div class="reference-location">{{ ref.location }}</div>
                          </template>
                          <button 
                            class="select-button"
                            :class="{ 'loading': isSelecting(ref.nodeId) }"
                            @click="selectGroup([ref], ref.nodeId)"
                            :disabled="isSelecting(ref.nodeId)"
                          >
                            <span v-if="!isSelecting(ref.nodeId)">Select</span>
                            <span v-else class="loading-spinner"></span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- Unlinked Library Tab -->
          <div v-if="activeTab === 'libraries'" class="tab-content">
            <div class="first-section">
              <div class="step-container">
                <div class="step-content">
                  <h3 class="step-title">Library Variables</h3>
                  <p class="description">
                    Analyze and list all variables in the current document, including their library status.
                  </p>
                  <div class="library-actions">
                    <button 
                      @click="listVariables" 
                      class="button primary-button"
                      :disabled="isAnalyzing"
                    >
                      {{ isAnalyzing ? 'Analyzing...' : 'Analyze Variables' }}
                    </button>
                    <button 
                      @click="startLibraryScan"
                      :disabled="isScanning || (!hasSelection && !scanEntirePage)" 
                      class="button secondary-button"
                    >
                      Scan for Unlinked
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="content">
              <!-- Loading State -->
              <div v-if="isAnalyzing" class="analysis-loading">
                <div class="loading-spinner"></div>
                <span>Analyzing variables...</span>
              </div>
              
              <!-- Variables Analysis Results -->
              <div v-if="variableAnalysis" class="analysis-results">
                <div class="analysis-summary">
                  <div class="summary-item">
                    <span class="summary-label">Total Variables:</span>
                    <span class="summary-value">{{ variableAnalysis.totalVariables }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Library Variables:</span>
                    <span class="summary-value">{{ variableAnalysis.libraryVariables }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Local Variables:</span>
                    <span class="summary-value">{{ variableAnalysis.localVariables }}</span>
                  </div>
                </div>
                
                <!-- Libraries List -->
                <div class="libraries-list">
                  <h4 class="section-subtitle">Libraries</h4>
                  <div v-for="lib in variableAnalysis.libraries" :key="lib.key" class="library-item">
                    <div class="library-header">
                      <span class="library-name">{{ lib.name }}</span>
                      <span :class="['library-status', lib.enabled ? 'enabled' : 'disabled']">
                        {{ lib.enabled ? 'Enabled' : 'Disabled' }}
                      </span>
                    </div>
                    <div class="library-details">
                      <span class="variable-count">{{ lib.variableCount }} variables</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Library Scan Results -->
              <template v-if="!isScanning && Object.keys(libraryResults).length > 0">
                <div class="divider"></div>
                
                <div class="step-container">
                  <div class="step-content">
                    <div class="results-header">
                      <h3 class="step-title">Library scan results</h3>
                      <div class="results-actions">
                        <button 
                          class="button secondary-button"
                          @click="clearLibraryResults"
                        >
                          Clear
                        </button>
                      </div>
                    </div>
                    <div class="results-container">
                      <div v-for="(group, groupKey) in libraryResults" :key="groupKey" class="value-group">
                        <!-- Value Group Header -->
                        <div class="value-group-header" @click="toggleGroup(groupKey)">
                          <div class="header-left">
                            <span class="expand-icon">{{ isGroupExpanded(groupKey) ? '▼' : '▶' }}</span>
                            <template v-if="group.refs[0]?.type === 'fill' || group.refs[0]?.type === 'stroke'">
                              <color-preview :color="group.value" />
                            </template>
                            <template v-else-if="group.refs[0]?.type === 'gap'">
                              <span class="value-label">{{ formatGapValue(group.value, group.refs[0]) }}</span>
                            </template>
                            <template v-else>
                              <span class="value-label">{{ formatValue(group.value) }}</span>
                            </template>
                          </div>
                          <div class="header-right">
                            <span class="total-count">{{ group.refs.length }} instances</span>
                            <button 
                              class="select-button" 
                              :class="{ 'loading': isSelecting(groupKey) }"
                              @click.stop="selectGroup(group.refs, groupKey)"
                              :disabled="isSelecting(groupKey)"
                            >
                              <span v-if="!isSelecting(groupKey)">Select All</span>
                              <span v-else class="loading-spinner"></span>
                            </button>
                          </div>
                        </div>

                        <!-- Expanded Content -->
                        <div v-if="isGroupExpanded(groupKey)" class="reference-details">
                          <div v-for="ref in group.refs" :key="ref.nodeId" class="reference-item">
                            <!-- Special handling for typography items -->
                            <template v-if="ref.type === 'typography'">
                              <div class="typography-details">
                                <div class="typography-preview">{{ ref.currentValue.content }}</div>
                                <div class="typography-specs">
                                  <div class="typography-tags">
                                    <span class="typography-tag font-family">{{ ref.currentValue.fontFamily }}</span>
                                    <span class="typography-tag weight">{{ ref.currentValue.fontWeight }}</span>
                                    <span class="typography-tag size">{{ ref.currentValue.fontSize }}px</span>
                                    <span v-if="ref.currentValue.lineHeight" class="typography-tag">LH: {{ ref.currentValue.lineHeight }}</span>
                                    <span v-if="ref.currentValue.letterSpacing" class="typography-tag">LS: {{ ref.currentValue.letterSpacing }}</span>
                                  </div>
                                </div>
                              </div>
                            </template>
                            <template v-else>
                              <div class="reference-name">{{ ref.nodeName }}</div>
                              <div class="reference-location">{{ ref.location }}</div>
                            </template>
                            <button 
                              class="select-button"
                              :class="{ 'loading': isSelecting(ref.nodeId) }"
                              @click="selectGroup([ref], ref.nodeId)"
                              :disabled="isSelecting(ref.nodeId)"
                            >
                              <span v-if="!isSelecting(ref.nodeId)">Select</span>
                              <span v-else class="loading-spinner"></span>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- Sticky footer -->
      <div class="sticky-footer">
        <div class="version-info">
          <span>v</span>
          <span class="version-number">1.0.0</span>
        </div>
        <button class="donate-button" @click="openStripePayment">
          <span class="cat-icon">🐱</span>
          <span>Feed my cats</span>
        </button>
        <div class="resize-handle"></div>
      </div>
    </div>

    <!-- Success Toast -->
    <div 
      class="success-toast" 
      :class="{ 
        visible: showSuccessToast,
        warning: successMessage === 'Scanning the entire page may take longer'
      }"
      v-if="showSuccessToast"
    >
      <div class="success-toast-content">
        <div class="success-toast-icon">
          <svg v-if="successMessage !== 'Scanning the entire page may take longer'" 
            width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33334C4.31811 1.33334 1.33334 4.31811 1.33334 8C1.33334 11.6819 4.31811 14.6667 8 14.6667C11.6819 14.6667 14.6667 11.6819 14.6667 8C14.6667 4.31811 11.6819 1.33334 8 1.33334ZM11.0607 6.27274L7.39401 9.93941L5.27274 7.81814L6.06069 7.03019L7.39401 8.36351L10.2727 5.48479L11.0607 6.27274Z" fill="currentColor"/>
          </svg>
          <svg v-else width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1L14.6667 13H1.33334L8 1ZM8 3.66667L3.73334 11.6667H12.2667L8 3.66667ZM7.33334 6H8.66668V8.66667H7.33334V6ZM7.33334 10H8.66668V11.3333H7.33334V10Z" fill="currentColor"/>
          </svg>
        </div>
        <span class="success-toast-message">{{ successMessage }}</span>
        <button class="success-toast-close" @click="dismissToast">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M12.6667 4.27337L11.7267 3.33337L8.00001 7.06004L4.27334 3.33337L3.33334 4.27337L7.06001 8.00004L3.33334 11.7267L4.27334 12.6667L8.00001 8.94004L12.6667 4.27337Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <style>
    /* Add Figma's font stack at the top of your styles */
    :root {
      --font-stack: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
    }

    [v-cloak] { display: none; }
    
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #2C2C2C;
      color: #FFFFFF;
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
    }

    #app {
      position: relative;
      height: 100vh;
      overflow: hidden;
    }

    /* Disable text selection globally */
    body {
      user-select: none;
      -webkit-user-select: none; /* Safari */
      -moz-user-select: none; /* Firefox */
      -ms-user-select: none; /* IE/Edge */
    }

    /* Allow text selection in specific areas if needed */
    .code, .selectable-text {
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
    }

    .plugin-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .content-section {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 32px; /* Height of sticky footer */
    }

    .scan-section {
      background: var(--figma-color-bg);
    }

    .results-section {
      padding-bottom: 16px;
    }

    .header {
      flex-shrink: 0;
      padding: 16px;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .header h2 {
      font-family: var(--font-stack);
      font-weight: 600;
      font-size: 13px;
      line-height: 24px;
      margin: 0;
    }

    .scan-type-selector {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .scan-type-selector label {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 4px;
    }

    .select-input {
      padding: 8px 8px 8px 12px;
      height: 32px;
      border: 1px solid var(--figma-color-border);
      border-radius: 2px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      appearance: none;
      cursor: pointer;
    }

    .scan-controls {
      display: flex;
      gap: 8px;
    }

    .button {
      padding: 5px 12px;
      height: 32px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 90px;
    }

    .primary-button {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .primary-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .secondary-button {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
    }

    .secondary-button:not(.button-disabled):hover {
      background: var(--figma-color-bg-hover);
    }

    .progress-container {
      position: relative;
      min-height: 20px;
    }
    
    .progress-bar {
      height: 20px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);  /* Add subtle inner shadow */
    }
    
    .progress-fill {
      height: 100%;
      transition: all 0.2s ease;
      animation: pulse 2s infinite;
      border-radius: 6px;
      background-size: 30px 30px;
      background-image: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.15) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.15) 50%,
        rgba(255, 255, 255, 0.15) 75%,
        transparent 75%,
        transparent
      );
      animation: 
        pulse 2s infinite,
        progress-bar-stripes 1s linear infinite;
    }

    @keyframes progress-bar-stripes {
      from { background-position: 30px 0; }
      to { background-position: 0 0; }
    }

    .progress-fill:not(.complete) {
      background: linear-gradient(
        90deg,
        var(--figma-color-bg-brand) 0%,
        var(--figma-color-bg-brand-hover) 100%
      );
    }

    .progress-text {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      margin: 0;
      font-size: 11px;
      font-weight: 500;
      color: var(--figma-color-text-onbrand);
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      padding: 0 4px;
      min-width: 40px;
      text-align: right;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.9;
      }
      100% {
        opacity: 1;
      }
    }

    .references-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }

    .reference-card {
      padding: 0;
      background: var(--figma-color-bg-secondary);
      border-radius: 2px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .reference-info {
      flex: 1;
      padding: 12px;
    }

    .reference-header {
      cursor: pointer;
      user-select: none;
      padding: 4px 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .expand-icon {
      color: var(--figma-color-text-secondary);
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.1s ease;
      margin: -4px;
    }

    .current-value-label {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }

    .reference-header:hover {
      background: var(--figma-color-bg-hover);
    }

    .parameter-name {
      font-family: var(--font-stack);
      font-weight: 500;
      font-size: 11px;
    }

    .missing-count {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
    }

    .variable-details {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--figma-color-border);
    }

    .variable-item {
      padding: 8px 12px;
      background: var(--figma-color-bg-tertiary);
      border-radius: 2px;
    }

    .node-info,
    .location-info {
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      margin-top: 2px;
    }

    .select-button {
      padding: 5px 12px;
      height: 32px;
      min-width: 64px;
    }

    .empty-state {
      padding: 16px;
      text-align: center;
      color: var(--figma-color-text-secondary);
    }

    .empty-state p {
      margin: 0 0 16px 0;
    }

    .empty-state-steps {
      text-align: left;
      display: inline-block;
      line-height: 24px;
    }

    .value-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .value-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      min-height: 40px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .expand-icon {
      color: var(--figma-color-text-secondary);
    }

    .reference-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: var(--figma-color-bg-tertiary);
      border-radius: 4px;
      margin-top: 4px;
    }

    .select-button {
      padding: 4px 8px;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }

    .select-button:hover {
      background: var(--figma-color-bg-brand-hover);
    }

    .scan-scope-selector {
      padding: 2px 0;
      width: 100%;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      padding: 2px 0;
      width: 100%;
    }

    .toggle-wrapper {
      position: relative;
      width: 28px;
      height: 16px;
      flex-shrink: 0;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      user-select: none;
      color: var(--figma-color-text);
      width: 100%;
      justify-content: space-between;
      padding: 2px 0;
    }

    .toggle-label-content {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .slow-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--figma-color-bg-warning);
      color: white;
      border-radius: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .toggle-input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--figma-color-bg-disabled);
      transition: .2s;
      border-radius: 16px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 12px;
      width: 12px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .2s;
      border-radius: 50%;
    }

    .toggle-input:checked + .toggle-slider {
      background-color: var(--figma-color-bg-brand);
    }

    .toggle-input:checked + .toggle-slider:before {
      transform: translateX(12px);
    }

    .toggle-input:disabled + .toggle-slider {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .selection-count {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }

    .warning-message,
    .info-message {
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .warning-message {
      background-color: var(--figma-color-bg-warning-secondary);
      color: white;
      border: 1px solid var(--figma-color-border-warning);
      background: var(--figma-color-bg-warning);
    }

    .info-message {
      background-color: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
    }

    .warning-icon,
    .info-icon {
      width: 12px;
      height: 12px;
      flex-shrink: 0;
      color: white;
    }

    /* Add icon components */
    .icon-warning {
      color: var(--figma-color-text-warning);
    }

    .icon-info {
      color: var(--figma-color-text-secondary);
    }

    /* Update existing styles */
    .toggle-label {
      width: 100%;
      justify-content: space-between;
    }

    .button.primary-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Add these styles */
    .typography-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
    }

    .typography-preview {
      font-family: system-ui;
      color: var(--figma-color-text);
      opacity: 0.8;
      font-style: italic;
    }

    .typography-specs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 4px;
      font-size: 12px;
      color: var(--figma-color-text-secondary);
    }

    /* Add these styles */
    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--figma-color-text);
    }

    .scan-cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .scan-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }

    .scan-card:hover {
      background: var(--figma-color-bg-hover);
    }

    .scan-card.selected {
      background: var(--figma-color-bg-brand-tertiary);
      border-color: var(--figma-color-border-brand);
    }

    .scan-card-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--figma-color-text);
      flex-shrink: 0;
    }

    .scan-card.selected .scan-card-icon {
      color: var(--figma-color-text-brand);
    }

    .scan-card-content {
      flex: 1;
      min-width: 0; /* Prevent content from pushing card wider */
    }

    .scan-card-title {
      font-weight: 500;
      margin-bottom: 4px;
      color: var(--figma-color-text);
    }

    .scan-card-description {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      line-height: 14px;
    }

    .scan-card.selected .scan-card-icon {
      color: var(--figma-color-text-brand);
    }

    .scan-card.selected .scan-card-title {
      color: var(--figma-color-text-brand);
    }

    .toast {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 4px;
      background-color: var(--figma-color-bg-warning-tertiary);
      color: var(--figma-color-text-onwarning-tertiary);
      border: 1px solid var(--figma-color-border-warning);
    }

    .toast-icon {
      margin-right: 8px;
      opacity: 0.8;
      color: white;
    }

    .toast-message {
      font-size: 11px;
      font-weight: 500;
      opacity: 0.9;
      color: white;
    }

    .toast.success {
      background: var(--figma-color-bg-success-tertiary);
      color: white;
      border: 1px solid var(--figma-color-border-success);
    }

    .toast.success .toast-icon {
      margin-right: 8px;
      opacity: 1;
      color: white;
    }

    .toast.success .toast-message {
      font-size: 11px;
      font-weight: 500;
      opacity: 1;
      color: white;
    }

    .divider {
      height: 1px;
      background-color: var(--figma-color-border);
      margin: 0;
    }

    .first-section {
      background: var(--figma-color-bg);
      padding: 0;
      /* Tighter vertical spacing for first section */
      & .step-content {
        gap: 4px;  /* Reduce gap between elements */
      }
      
      & .selection-container {
        margin-bottom: 2px;  /* Reduce margin */
      }
      
      & .progress-container {
        padding: 2px 0;  /* Reduce padding */
      }
    }

    .step-container {
      padding: 16px;
      padding-top: 8px;  /* Reduce top padding to tighten spacing with tabs */
    }

    .step-content {
      display: flex;
      flex-direction: column;
      gap: 8px;  /* Reduce gap for tighter vertical spacing */
    }

    .step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .step-title {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
    }

    .watch-toggle {
      background: none;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .watch-toggle-content {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .watch-toggle-text {
      font-size: 11px;
      font-weight: 500;
    }

    .watch-toggle:hover {
      &:not(.disabled) {
        background: var(--figma-color-bg-hover);
        color: var(--figma-color-text);
      }
    }

    .watch-toggle.active {
      &:not(.disabled) {
        color: var(--figma-color-text-brand);
        background: var(--figma-color-bg-brand-tertiary);
      }
    }

    .watch-toggle.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
    }

    .watch-toggle.disabled:hover {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .results-actions {
      display: flex;
      gap: 8px;
    }

    .results-actions .button {
      min-width: unset;
      padding: 5px 12px;
      height: 28px;
    }

    .rescan {
      background: none;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      font-weight: 500;
    }

    .clear-results {
      background: none;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      font-weight: 500;
    }

    .selection-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .results-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Add these styles to match Figma's scrollbar */
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--figma-color-bg-tertiary);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--figma-color-bg-secondary);
    }

    .select-button.loading {
      position: relative !important;
      color: transparent !important;
      pointer-events: none !important;
    }
    
    /* Update the loading spinner styles */
    .select-button.loading {
      position: relative;
      color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .select-button .loading-spinner {
      width: 12px;
      height: 12px;
      border-width: 2px;
      border-top-color: var(--figma-color-text-onbrand);
      border-right-color: var(--figma-color-text-onbrand);
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: auto;
    }

    /* Add specific styles for analysis loading spinner */
    .analysis-loading .loading-spinner {
      width: 24px;
      height: 24px;
      border-width: 2.5px;
      margin: 8px auto;
    }

    .select-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .success-toast.warning {
      background: var(--figma-color-bg-warning);
      border: 1px solid var(--figma-color-border-warning);
    }

    .success-toast.warning .success-toast-message,
    .success-toast.warning .success-toast-icon {
      color: white;
    }

    .watch-toggle.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
    }

    .watch-toggle.disabled:hover {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
    }

    .watch-toggle:hover {
      &:not(.disabled) {
        background: var(--figma-color-bg-hover);
        color: var(--figma-color-text);
      }
    }

    .watch-toggle.active {
      &:not(.disabled) {
        color: var(--figma-color-text-brand);
        background: var(--figma-color-bg-brand-tertiary);
      }
    }

    .tab-navigation {
      display: flex;
      margin: 16px 16px 8px 16px;  /* Add horizontal padding and reduce bottom margin */
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      padding: 4px;
      gap: 4px;
    }

    .tab-button {
      flex: 1;
      padding: 8px 12px;  /* Increase vertical padding slightly */
      background: var(--figma-color-bg);
      border: none;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-radius: 4px;
      font-weight: 500;
    }

    .tab-button-disabled {
      flex: 1;
      padding: 8px 12px;  /* Match active tab padding */
      background: transparent;
      border: none;
      color: var(--figma-color-text-disabled);
      font-size: 11px;
      cursor: not-allowed;
      opacity: 0.5;
      border-radius: 4px;
      font-weight: 500;
    }

    .tab-button.active {
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      box-shadow: var(--figma-color-shadow);
    }

    .tab-button:not(.active):hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }

    .tab-button-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      opacity: 0.8;
    }

    .lock-icon {
      opacity: 0.7;
    }

    .tab-content {
      padding: 0;
    }

    .description {
      color: var(--figma-color-text-secondary);
      margin: 8px 0 16px;
    }

    .library-scan-controls {
      margin-top: 16px;
    }

    .library-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .analysis-results {
      margin: 0;
      padding: 16px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
    }

    .analysis-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-label {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }

    .summary-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--figma-color-text);
    }

    .section-subtitle {
      font-size: 12px;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: var(--figma-color-text);
    }

    .libraries-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .library-item {
      padding: 8px;
      background: var(--figma-color-bg);
      border-radius: 4px;
    }

    .library-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .library-name {
      font-weight: 500;
    }

    .library-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .library-status.enabled {
      background: var(--figma-color-bg-success);
      color: var(--figma-color-text-onbrand);
    }

    .library-status.disabled {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-secondary);
    }

    .library-details {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }

    .analysis-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      margin: 0;
      color: var(--figma-color-text-secondary);
    }

    .loading-spinner {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: var(--figma-color-bg-brand);
      border-right-color: var(--figma-color-bg-brand);
      animation: spinner 0.6s linear infinite;
    }
    
    @keyframes spinner {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    /* Add specific styles for button loading spinner */
    .select-button .loading-spinner {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: auto;
      width: 12px;
      height: 12px;
      border-width: 2px;
      border-top-color: var(--figma-color-text-onbrand);
      border-right-color: var(--figma-color-text-onbrand);
    }

    /* Add specific styles for analysis loading spinner */
    .analysis-loading .loading-spinner {
      width: 24px;
      height: 24px;
      border-width: 2.5px;
      margin: 8px auto;
    }

    /* Container for select button spinner */
    .select-button.loading {
      position: relative;
      color: transparent;
    }

    .button.button-disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
    }

    .sticky-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 16px;
      background: var(--figma-color-bg);
      border-top: 1px solid var(--figma-color-border);
      height: 32px;
      z-index: 100;
      position: relative; /* For resize handle positioning */
    }

    .version-info {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }

    .version-number {
      color: var(--figma-color-text-tertiary);
    }

    .donate-button {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-tertiary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      margin-right: 12px; /* Adjust donate button margin */
    }

    .donate-button:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
      transform: scale(1.02);
    }

    .cat-icon {
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .donate-button:hover .cat-icon {
      transform: scale(1.1);
    }

    /* Add these styles */
    .scan-settings {
      margin-top: 8px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      overflow: hidden;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
    }

    .settings-title {
      margin: 0;
      font-size: 11px;
      font-weight: 500;
      color: var(--figma-color-text);
    }

    .settings-toggle {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.1s ease;
      border-radius: 6px;
      margin: -4px;
    }

    .settings-toggle:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }

    .settings-toggle:active {
      background: var(--figma-color-bg-pressed);
      color: var(--figma-color-text);
    }

    .settings-content {
      padding: 0 12px 12px;
    }

    .setting-item {
      margin-bottom: 8px;
    }

    .setting-item:last-child {
      margin-bottom: 0;
    }

    .toggle-label-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-badge {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      cursor: help;
    }

    /* Add these styles */
    .color-preview {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: var(--figma-color-bg);
      border-radius: 2px;
      max-width: fit-content;
      border: 1px solid var(--figma-color-border);
    }

    .color-swatch-container {
      width: 20px;
      height: 20px;
      padding: 0;
      background: var(--figma-color-bg-secondary);
      border-radius: 3px;
      overflow: hidden;
      border: 1px solid var(--figma-color-border);
    }

    .color-swatch {
      width: 100%;
      height: 100%;
      border: none;
    }

    .color-info {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-family: var(--font-stack);
      color: var(--figma-color-text);
    }

    .color-hex {
      font-family: var(--font-stack);
      font-weight: 400;
    }

    .color-opacity {
      color: var(--figma-color-text-secondary);
      padding-left: 4px;
      border-left: 1px solid var(--figma-color-border);
      font-family: var(--font-stack);
      font-weight: 400;
    }

    /* Update color preview styles for results */
    .value-group-header .color-preview {
      background: transparent;
      padding: 4px 8px;
      font-family: var(--font-stack);
      border: none;
    }

    /* Resize handle styles */
    .resize-handle {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 16px;
      height: 16px;
      cursor: nwse-resize;
      z-index: 1000;
      touch-action: none; /* Prevent touch scrolling while resizing */
    }

    .resize-handle::after {
      content: '';
      position: absolute;
      right: 4px;
      bottom: 4px;
      width: 8px;
      height: 8px;
      border-right: 2px solid var(--figma-color-border);
      border-bottom: 2px solid var(--figma-color-border);
      pointer-events: none; /* Ensure handle doesn't interfere with resize */
    }

    /* Add visual feedback on hover */
    .resize-handle:hover::after {
      border-color: var(--figma-color-border-brand);
    }

    .icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .icon svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Add specific styles for the scan card icons */
    .scan-card-icon .icon {
      opacity: 0.8;
    }

    .scan-card:hover .icon,
    .scan-card.selected .icon {
      opacity: 1;
    }

    /* Add these styles */
    .step-title-with-badge {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .results-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: var(--figma-color-bg-secondary);
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
      color: var(--figma-color-text);
    }

    /* Update typography styles */
    .typography-info {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    .typography-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      min-width: 0;
    }

    .typography-tag {
      padding: 2px 6px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
      height: 20px;
      display: flex;
      align-items: center;
    }

    .typography-tag.font-family {
      background: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-text-brand);
      font-weight: 600;
    }

    .typography-tag.weight {
      background: var(--figma-color-bg-secondary);
    }

    .typography-tag.size {
      background: var(--figma-color-bg-secondary);
      min-width: 35px;
      justify-content: center;
    }

    .typography-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .typography-preview {
      font-family: var(--font-stack);
      color: var(--figma-color-text);
      opacity: 0.8;
      font-size: 11px;
      line-height: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .typography-specs {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* Update reference item styles for typography */
    .reference-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      margin-bottom: 4px;
    }

    .reference-item:last-child {
      margin-bottom: 0;
    }
  </style>

  <!-- Add color preview template outside of style tag -->
  <template id="color-preview">
    <div class="color-preview">
      <div class="color-swatch-container">
        <div 
          class="color-swatch" 
          :style="{
            backgroundColor: `rgba(${color.r * 255}, ${color.g * 255}, ${color.b * 255}, ${color.a || 1})`
          }"
        ></div>
      </div>
      <div class="color-info">
        <span class="color-hex">RGB({{ Math.round(color.r * 255) }}, {{ Math.round(color.g * 255) }}, {{ Math.round(color.b * 255) }})</span>
        <span v-if="color.a !== 1" class="color-opacity">{{ Math.round(color.a * 100) }}%</span>
      </div>
    </div>
  </template>

  <script>
    function initializeApp() {
      const { createApp } = Vue;
      
      // Add the SuccessToast component definition
      const SuccessToast = {
        template: '#success-toast',
        props: {
          message: String,
          show: Boolean
        },
        methods: {
          close() {
            this.$emit('close');
          }
        }
      };

      // Create new icon components that use the imported SVGs
      const Icon = {
        props: {
          name: {
            type: String,
            required: true
          }
        },
        template: `
          <div class="icon" v-html="getIcon"></div>
        `,
        computed: {
          getIcon() {
            const icon = this.$root.icons[this.name];
            console.log('Loading icon:', this.name, icon ? 'found' : 'not found');
            console.log('Icon content:', icon);
            return icon;
          }
        }
      };

      createApp({
        components: {
          Icon,
          SuccessToast,
          ColorPreview: {
            template: '#color-preview',
            props: {
              color: {
                type: Object,
                required: true
              }
            },
            methods: {
              formatColorToHex({ r, g, b }) {
                const toHex = (n) => {
                  const hex = Math.round(n * 255).toString(16);
                  return hex.length === 1 ? '0' + hex : hex;
                };
                return `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();
              }
            }
          }
        },
        data() {
          return {
            activeTab: 'tokens',
            selectedScanType: 'gap',
            scanEntirePage: false,
            isScanning: false,
            scanProgress: 0,
            groupedReferences: {},
            expandedGroups: new Set(),
            hasSelection: false,
            selectedCount: 0,
            isWatching: false,
            tokenScanOptions: [
              {
                value: 'typography',
                label: 'Typography',
                description: 'Find text layers missing text style variables',
                icon: 'typography'
              },
              {
                value: 'vertical-padding',
                label: 'Vertical Padding',
                description: 'Find frames with unlinked vertical padding',
                icon: 'vertical-padding'
              },
              {
                value: 'horizontal-padding',
                label: 'Horizontal Padding',
                description: 'Find frames with unlinked horizontal padding',
                icon: 'horizontal-padding'
              },
              {
                value: 'gap',
                label: 'Auto-layout Gaps',
                description: 'Find frames with unlinked vertical or horizontal gaps',
                icon: 'spacing'
              },
              {
                value: 'corner-radius',
                label: 'Corner Radius',
                description: 'Find shapes with unlinked corner radius',
                icon: 'radius'
              },
              {
                value: 'fill',
                label: 'Fill Colors',
                description: 'Find layers with unlinked fill colors',
                icon: 'fill'
              },
              {
                value: 'stroke',
                label: 'Stroke Colors',
                description: 'Find layers with unlinked stroke colors',
                icon: 'stroke'
              }
            ],
            showSuccessToast: false,
            successMessage: '',
            selectingNodeIds: new Set(), // Track which groups are being selected
            libraryResults: {},  // Separate results for library scan
            variableAnalysis: null,
            isAnalyzing: false,
            showSettings: false,
            ignoreHiddenLayers: false,
            icons: {
              'typography': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="type">
                  <path d="M19.9567 8.71249V9.97212H14.9434V8.71249H19.9567ZM16.4045 6.39478H17.8909V15.6153C17.8909 16.0351 17.9518 16.35 18.0735 16.56C18.1995 16.7657 18.3591 16.9043 18.5522 16.9757C18.7495 17.0428 18.9574 17.0764 19.1757 17.0764C19.3395 17.0764 19.4738 17.068 19.5788 17.0512C19.6838 17.0302 19.7677 17.0134 19.8307 17.0009L20.133 18.3361C20.0323 18.3738 19.8916 18.4116 19.7111 18.4494C19.5305 18.4914 19.3017 18.5124 19.0246 18.5124C18.6047 18.5124 18.1932 18.4221 17.7901 18.2416C17.3912 18.061 17.0595 17.786 16.795 17.4165C16.5347 17.047 16.4045 16.581 16.4045 16.0183V6.39478Z M3.8667 6.87338V5.48779H13.5406V6.87338H9.48464V18.3864H7.9227V6.87338H3.8667Z" fill="currentColor"/>
                </g>
              </svg>`,
              
              'stroke': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="stroke">
                  <path d="M17.1266 17.1267L6.87317 6.87329" stroke="currentColor" stroke-linecap="round"/>
                  <rect x="3.84668" y="3.84668" width="16.3066" height="16.3066" rx="2.5" stroke="currentColor" stroke-linecap="round"/>
                </g>
              </svg>`,
              
              'spacing': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="Gap">
                  <path d="M20.7651 3.39014H19C17.3431 3.39014 16 4.73328 16 6.39014V17.6096C16 19.2665 17.3431 20.6096 19 20.6096H20.7651" stroke="currentColor" stroke-linecap="round"/>
                  <path d="M3.23486 3.39014H4.99998C6.65683 3.39014 7.99998 4.73328 7.99998 6.39014V17.6096C7.99998 19.2665 6.65683 20.6096 4.99998 20.6096H3.23486" stroke="currentColor" stroke-linecap="round"/>
                  <path d="M12 6.92114V17.2227" stroke="currentColor" stroke-linecap="round"/>
                </g>
              </svg>`,
              
              'radius': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="corner">
                  <path d="M3.34302 20.8875V10.1124C3.34302 6.24643 6.47703 3.11243 10.343 3.11243H22.4347" stroke="currentColor"/>
                </g>
              </svg>`,
              
              'vertical-padding': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="vertical">
                  <path d="M20.7102 3.80981H3.34668" stroke="currentColor" stroke-linecap="round"/>
                  <path d="M20.7102 20.3337H3.34668" stroke="currentColor" stroke-linecap="round"/>
                  <rect x="7.87646" y="7.87646" width="8.24707" height="8.24707" rx="2.5" stroke="currentColor" stroke-linecap="round"/>
                </g>
              </svg>`,
              
              'horizontal-padding': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="horizontal">
                  <path d="M3.76648 3.39014L3.76648 20.7537" stroke="currentColor" stroke-linecap="round"/>
                  <path d="M20.2904 3.39014L20.2904 20.7537" stroke="currentColor" stroke-linecap="round"/>
                  <rect x="7.87646" y="7.87646" width="8.24707" height="8.24707" rx="2.5" stroke="currentColor" stroke-linecap="round"/>
                </g>
              </svg>`,
              
              'fill': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="fill">
                  <rect x="3.78979" y="3.78979" width="16.4204" height="16.4204" rx="2.5" stroke="currentColor" stroke-linecap="round"/>
                  <rect x="5.51733" y="5.51733" width="12.9653" height="12.9653" rx="1" fill="currentColor"/>
                </g>
              </svg>`
            },
            windowSize: {
              width: 400,
              height: 600
            },
            isResizing: false,
            selectedFrameIds: [],
          }
        },
        computed: {
          scanScope() {
            return this.scanEntirePage ? 'entire-page' : 'selected-frames';
          },
          canStartScan() {
            return this.hasSelection || this.scanEntirePage;
          },
          hasResults() {
            return Object.keys(this.groupedReferences).length > 0;
          },
          groupedByValue() {
            const valueGroups = {};
            
            Object.entries(this.groupedReferences).forEach(([key, refs]) => {
              try {
                // Split the key safely
                const [property, ...valueParts] = key.split(':');
                const valueStr = valueParts.join(':'); // Rejoin in case value contains colons
                
                // Parse the value safely
                let value;
                try {
                  value = JSON.parse(valueStr);
                } catch {
                  value = valueStr; // Use raw string if parsing fails
                }
                
                const groupKey = typeof value === 'object' ? JSON.stringify(value) : String(value);
                
                if (!valueGroups[groupKey]) {
                  valueGroups[groupKey] = {
                    value,
                    properties: new Set(),
                    refs: []
                  };
                }
                
                valueGroups[groupKey].properties.add(property);
                valueGroups[groupKey].refs.push(...refs);
              } catch (err) {
                console.warn('Error processing group:', key, err);
              }
            });
            
            return valueGroups;
          },
          watchButtonTitle() {
            if (!this.scanEntirePage) {
              return 'Enable "Scan Entire Page" to use watch mode';
            }
            return this.isWatching ? 'Stop watching for changes' : 'Watch for changes';
          },
          canWatch() {
            return this.scanEntirePage;
          }
        },
        methods: {
          handleScanScopeChange() {
            if (this.scanEntirePage) {
              this.successMessage = 'Scanning the entire page may take longer';
              this.showSuccessToast = true;
              setTimeout(() => {
                if (this.successMessage === 'Scanning the entire page may take longer') {
                  this.showSuccessToast = false;
                }
              }, 3000);
            } else {
              this.stopWatching();
            }
            // Store the user's preference
            this.userPrefersScanEntirePage = this.scanEntirePage;
          },
          stopWatching() {
            this.isWatching = false;
            parent.postMessage({ 
              pluginMessage: { 
                type: 'stop-watching'
              }
            }, '*');
          },
          async startScan(isRescan = false, event) {
            if (event) {
              event.preventDefault();
            }
            
            this.isScanning = true;
            this.scanProgress = 0;
            
            // Get the current selection if we're not scanning the entire page
            const selectedFrameIds = !this.scanEntirePage ? [...this.selectedFrameIds] : [];
            
            console.log('Starting scan with:', {
              scanEntirePage: this.scanEntirePage,
              selectedFrameIds,
              hasSelection: this.hasSelection
            });
            
            parent.postMessage({
              pluginMessage: {
                type: 'scan-for-tokens',
                scanType: this.selectedScanType,
                scanEntirePage: this.scanEntirePage,
                selectedFrameIds: selectedFrameIds,
                isRescan
              }
            }, '*');
          },
          async getSelectedFrameIds() {
            return new Promise((resolve) => {
              parent.postMessage({ 
                pluginMessage: { type: 'get-selected-frame-ids' }
              }, '*');

              const handler = (event) => {
                const msg = event.data.pluginMessage;
                if (msg.type === 'selected-frame-ids') {
                  window.removeEventListener('message', handler);
                  resolve(msg.ids);
                }
              };
              window.addEventListener('message', handler);
            });
          },
          stopScan() {
            console.log('Stopping scan...');
            // Send stop message to plugin
            parent.postMessage({ 
              pluginMessage: { 
                type: 'stop-scan'
              } 
            }, '*');
            
            // Update UI state immediately
            this.isScanning = false;
            this.scanProgress = 0;
          },
          async selectGroup(refs, groupId) {
            this.selectingNodeIds.add(groupId);
            const nodeIds = refs.map(ref => ref.nodeId);
            parent.postMessage({ 
              pluginMessage: { 
                type: 'select-group',
                nodeIds
              }
            }, '*');
            
            setTimeout(() => {
              this.selectingNodeIds.delete(groupId);
            }, 500);
          },
          formatValue(value) {
            if (!value) return 'None';
            if (typeof value === 'object') {
              if ('r' in value && 'g' in value && 'b' in value) {
                return `RGB(${Math.round(value.r * 255)}, ${Math.round(value.g * 255)}, ${Math.round(value.b * 255)})`;
              }
              return JSON.stringify(value);
            }
            return String(value);
          },
          formatGapValue(value, ref) {
            if (ref.type === 'gap') {
              const direction = ref.isVertical ? 'Vertical' : 'Horizontal';
              return `${direction} Gap: ${value}px`;
            }
            return formatValue(value);
          },
          toggleGroup(key) {
            if (this.expandedGroups.has(key)) {
              this.expandedGroups.delete(key);
            } else {
              this.expandedGroups.add(key);
            }
          },
          isGroupExpanded(key) {
            return this.expandedGroups.has(key);
          },
          getPropertyName(key) {
            return key.split(':')[0];
          },
          toggleWatch() {
            if (!this.canWatch) return;
            
            this.isWatching = !this.isWatching;
            parent.postMessage({ 
              pluginMessage: { 
                type: this.isWatching ? 'start-watching' : 'stop-watching',
                scanType: this.selectedScanType,
                scanScope: this.scanScope,
                scanEntirePage: this.scanEntirePage
              }
            }, '*');
          },
          clearResults() {
            this.groupedReferences = {};
          },
          dismissToast() {
            this.showSuccessToast = false;
          },
          handleResize(msg) {
            if (msg.type === 'resize' && msg.width && msg.height) {
              const width = Number(msg.width);
              const height = Number(msg.height);
              
              if (!isNaN(width) && !isNaN(height)) {
                this.windowSize = { width, height };
              }
            }
          },
          updateProgress(newProgress) {
            const progress = Math.min(Math.max(0, Number(newProgress) || 0), 100);
            console.log(`Updating progress bar: ${progress}%`);
            this.scanProgress = progress;
          },
          isSelecting(id) {
            return this.selectingNodeIds.has(id);
          },
          async startLibraryScan() {
            this.isScanning = true;
            this.scanProgress = 0;
            
            const selectedFrameIds = !this.scanEntirePage  // Use the same scanEntirePage state
              ? await this.getSelectedFrameIds()
              : undefined;
            
            parent.postMessage({ 
              pluginMessage: { 
                type: 'scan-for-tokens',
                scanType: 'inactive-tokens',
                scanScope: this.scanEntirePage ? 'entire-page' : 'selected-frames',
                selectedFrameIds
              }
            }, '*');
          },
          clearLibraryResults() {
            this.libraryResults = {};
          },
          async listVariables() {
            this.isAnalyzing = true;
            this.variableAnalysis = null;  // Reset previous results
            parent.postMessage({ 
              pluginMessage: { 
                type: 'list-variables'
              }
            }, '*');
          },
          openStripePayment() {
            window.open('https://buy.stripe.com/8wM7wb49NeFD5UYcMM', '_blank');
          },
          startResize(e) {
            this.isResizing = true;
            
            const startX = e.clientX;
            const startY = e.clientY;
            const startWidth = this.windowSize.width;
            const startHeight = this.windowSize.height;
            
            const onMouseMove = (e) => {
              if (!this.isResizing) return;
              
              const newWidth = startWidth + (e.clientX - startX);
              const newHeight = startHeight + (e.clientY - startY);
              
              // Set minimum sizes
              const width = Math.max(300, newWidth);
              const height = Math.max(400, newHeight);
              
              this.windowSize = { width, height };
              
              // Send resize message to plugin
              parent.postMessage({ 
                pluginMessage: { 
                  type: 'resize', 
                  width,
                  height
                }
              }, '*');
            };
            
            const onMouseUp = () => {
              this.isResizing = false;
              document.removeEventListener('mousemove', onMouseMove);
              document.removeEventListener('mouseup', onMouseUp);
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
          },
          handlePluginMessage(msg) {
            console.log('Received message:', msg);
            
            switch (msg.type) {
              case 'scan-progress':
                this.scanProgress = msg.progress;
                this.isScanning = msg.isScanning ?? true;
                console.log('Progress updated:', this.scanProgress);
                break;
                
              case 'scan-status':
                this.isScanning = msg.isScanning ?? true;
                this.scanProgress = 0;
                break;
                
              case 'scan-cancelled':
                this.isScanning = false;
                this.scanProgress = 0;
                console.log('Scan was cancelled');
                break;
                
              case 'missing-references-result':
                this.isScanning = false;
                this.scanProgress = 100;
                this.groupedReferences = msg.references;
                break;
                
              case 'watch-status':
                this.isWatching = msg.isWatching && this.scanEntirePage;
                if (!msg.isWatching) {
                  this.isScanning = false;
                  this.scanProgress = 0;
                }
                break;
                
              case 'error':
                this.isScanning = false;
                this.scanProgress = 0;
                console.error('Scan error:', msg.message);
                break;
                
              case 'window-size':
                this.windowSize = {
                  width: msg.width,
                  height: msg.height
                };
                break;
                
              case 'init-icons':
                this.icons = msg.icons;
                console.log('Received icons:', this.icons);
                break;
              case 'selection-updated':
                this.updateSelection(msg);
                break;
              case 'selected-frame-ids':
                this.selectedFrameIds = msg.ids;
                this.selectedCount = msg.count;
                this.hasSelection = msg.ids.length > 0;
                break;
            }
          },
          updateSelection(msg) {
            this.hasSelection = msg.hasSelection;
            this.selectedCount = msg.count;
            if (msg.selectedFrameIds) {
              this.selectedFrameIds = msg.selectedFrameIds;
            }
          },
          getStyleData(key) {
            try {
              // Extract the JSON data from the textStyleId string
              const styleMatch = key.match(/textStyleId:({.*?})/);
              if (!styleMatch) return this.getDefaultStyle();
              
              const styleData = JSON.parse(styleMatch[1]);
              
              // Clean up the font family name
              styleData.fontFamily = styleData.fontFamily.split(' ')[0];
              
              return styleData;
            } catch (err) {
              console.warn('Error parsing style data:', err);
              return this.getDefaultStyle();
            }
          },
          getDefaultStyle() {
            return {
              fontFamily: 'Unknown',
              fontWeight: 'Regular',
              fontSize: 14
            };
          }
        },
        mounted() {
          console.log('Vue app mounted');
          console.log('Available icons:', Object.keys(this.icons));

          // Listen for icons from the main plugin code
          window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (msg) {
              this.handlePluginMessage(msg);
            }
          };

          // Request initial selection state
          parent.postMessage({ 
            pluginMessage: { 
              type: 'get-selected-frame-ids' 
            }
          }, '*');
        },
        created() {
          // Ensure we stay on the tokens tab
          this.activeTab = 'tokens';
        }
      }).mount('#app');

      // Hide loading indicator
      document.getElementById('loading').style.display = 'none';
    }

    // Resize handling
    let isResizing = false;
    let initialWidth, initialHeight, initialX, initialY;

    const MIN_WIDTH = 320;
    const MIN_HEIGHT = 400;
    const MAX_WIDTH = 800;
    const MAX_HEIGHT = 900;

    function initResizeHandle() {
      const resizeHandle = document.querySelector('.resize-handle');
      if (!resizeHandle) return;
      
      resizeHandle.addEventListener('mousedown', startResize);
    }

    function startResize(e) {
      isResizing = true;
      initialWidth = window.innerWidth;
      initialHeight = window.innerHeight;
      initialX = e.clientX;
      initialY = e.clientY;

      document.addEventListener('mousemove', handleResize);
      document.addEventListener('mouseup', stopResize);
      e.preventDefault(); // Prevent text selection while resizing
    }

    function handleResize(e) {
      if (!isResizing) return;

      const deltaX = e.clientX - initialX;
      const deltaY = e.clientY - initialY;

      const newWidth = Math.min(Math.max(initialWidth + deltaX, MIN_WIDTH), MAX_WIDTH);
      const newHeight = Math.min(Math.max(initialHeight + deltaY, MIN_HEIGHT), MAX_HEIGHT);

      // Send resize message to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'resize',
          width: newWidth,
          height: newHeight
        }
      }, '*');
    }

    function stopResize() {
      isResizing = false;
      document.removeEventListener('mousemove', handleResize);
      document.removeEventListener('mouseup', stopResize);
    }

    // Single window.onload handler
    window.onload = () => {
      initializeApp();
      initResizeHandle();
    };
  </script>
</body>
</html>
