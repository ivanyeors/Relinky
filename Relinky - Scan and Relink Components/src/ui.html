<!DOCTYPE html>
<html>
  <head>
  <!-- Replace the mock Vue implementation with the actual Vue.js library -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  </head>

<body>
  <!-- Loading indicator -->
  <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100vh;">
    Loading...
  </div>
  <!-- Main app -->
  <div id="app">
    <div v-cloak class="plugin-container">
      <div class="content-section">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
          <button 
            class="tab-button" 
            :class="{ 
              'active': activeTab === 'tokens',
              'inactive': activeTab !== 'tokens'
            }"
            @click="switchTab('tokens')"
          >
            <span>Values</span>
          </button>
          <button 
            class="tab-button" 
            :class="{ 
              'active': activeTab === 'library-tokens',
              'inactive': activeTab !== 'library-tokens',
              'disabled': true
            }"
            disabled
          >
            <div class="tab-label">
              <span>Variables</span>
              <span class="beta-badge">SOON</span>
            </div>
            <span v-if="inactiveLibraryTokens.length" class="tab-badge">
              {{ inactiveLibraryTokens.length }}
            </span>
          </button>
      </div>

      <!-- Section content -->
      <div class="scan-section">
          <div class="step-container">
            <div class="step-content">
              <!-- 1. Title and Watch button -->
              <div class="step-header">
                <h3 class="step-title">Select frames or components</h3>
                <button 
                  class="watch-toggle" 
                  :class="{ 
                    active: isWatching,
                    disabled: !scanEntirePage 
                  }"
                  @click="toggleWatch"
                  :disabled="!scanEntirePage"
                  :title="watchButtonTitle"
                >
                  <div class="watch-toggle-content">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path v-if="isWatching && scanEntirePage" d="M8 3.33333C11.3333 3.33333 14.1667 5.33333 15.3333 8C14.1667 10.6667 11.3333 12.6667 8 12.6667C4.66667 12.6667 1.83333 10.6667 0.666667 8C1.83333 5.33333 4.66667 3.33333 8 3.33333Z" fill="currentColor"/>
                      <g v-else>
                        <path d="M2.66667 2L13.3333 14" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M8 3.33333C11.3333 3.33333 14.1667 5.33333 15.3333 8C14.1667 10.6667 11.3333 12.6667 8 12.6667C4.66667 12.6667 1.83333 10.6667 0.666667 8C1.83333 5.33333 4.66667 3.33333 8 3.33333Z" fill="currentColor" fill-opacity="0.5"/>
                      </g>
                    </svg>
                    <span class="watch-toggle-text">{{ isWatching && scanEntirePage ? 'Watching' : 'Watch changes' }}</span>
                  </div>
                </button>
              </div>

              <!-- 2. Scan Settings dropdown (move this before selection status) -->
              <div class="scan-settings">
                <div class="settings-header">
                  <h4 class="settings-title">Scan Settings</h4>
                  <button 
                    class="settings-toggle"
                    @click="showSettings = !showSettings"
                  >
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path 
                        :d="showSettings 
                          ? 'M4 10L8 6L12 10' 
                          : 'M4 6L8 10L12 6'" 
                        stroke="currentColor" 
                        stroke-width="1.5" 
                        stroke-linecap="round" 
                        stroke-linejoin="round"
                      />
                    </svg>
                  </button>
                </div>
                
              <div class="settings-content" v-show="showSettings">
              <!-- Move Scan Entire Page here -->
                <div class="setting-item">
                    <label class="toggle-label">
                      <div class="toggle-label-content">
                        <span>Scan Entire Page</span>
                        <span v-if="scanEntirePage" class="slow-badge">slow</span>
                        <span class="info-badge" title="Scan the entire page instead of selected frames">‚ìò</span>
                      </div>
                      <div class="toggle-wrapper">
                        <input 
                          type="checkbox" 
                          v-model="scanEntirePage"
                          class="toggle-input"
                          @change="handleScanScopeChange"
                        >
                        <div class="toggle-slider"></div>
                      </div>
                    </label>
                </div>

              <!-- Existing Ignore Hidden Layers setting -->
                <div class="setting-item">
                    <label class="toggle-label">
                      <div class="toggle-label-content">
                        <span>Ignore Hidden Layers</span>
                        <span class="beta-badge">Beta</span>
                        <span class="info-badge" title="Hidden layers will be excluded from the scan">‚ìò</span>
                      </div>
                      <div class="toggle-wrapper">
                        <input 
                          type="checkbox" 
                          v-model="ignoreHiddenLayers"
                          class="toggle-input"
                        >
                        <div class="toggle-slider"></div>
                      </div>
                    </label>
                </div>
                </div>
              </div>

              <!-- 3. Selection status -->
              <div class="selection-container">
                <!-- Warning for instances -->
                <div v-if="hasInstances" class="toast warning">
                  <div class="toast-icon">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33337L14.6667 13.3334H1.33334L8 1.33337ZM8 4.00004L3.73334 12H12.2667L8 4.00004ZM7.33334 6.66671H8.66668V9.33337H7.33334V6.66671ZM7.33334 10.6667H8.66668V12H7.33334V10.6667Z" fill="currentColor"/>
                    </svg>
                  </div>
                  <span class="toast-message">Instances cannot be scanned. Please select frames, components, or sections instead.</span>
                </div>
                <!-- Existing selection messages -->
                <div v-else-if="!hasSelection && !scanEntirePage" class="toast warning">
                  <div class="toast-icon">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33337L14.6667 13.3334H1.33334L8 1.33337ZM8 4.00004L3.73334 12H12.2667L8 4.00004ZM7.33334 6.66671H8.66668V9.33337H7.33334V6.66671ZM7.33334 10.6667H8.66668V12H7.33334V10.6667Z" fill="currentColor"/>
                    </svg>
                  </div>
                  <span class="toast-message">Select frames or sections to start scanning</span>
                </div>
                <div v-else-if="hasSelection && !scanEntirePage" class="toast success">
                  <div class="toast-icon">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33334C4.31811 1.33334 1.33334 4.31811 1.33334 8C1.33334 11.6819 4.31811 14.6667 8 14.6667C11.6819 14.6667 14.6667 11.6819 14.6667 8C14.6667 4.31811 11.6819 1.33334 8 1.33334ZM11.0607 6.27274L7.39401 9.93941L5.27274 7.81814L6.06069 7.03019L7.39401 8.36351L10.2727 5.48479L11.0607 6.27274Z" fill="currentColor"/>
                    </svg>
                  </div>
                  <span class="toast-message">{{ selectedCount }} {{ selectedCount === 1 ? 'item' : 'items' }} selected</span>
                </div>
                </div>
              </div>
          </div>
      </div>
      <!-- divider -->
      <div class="divider"></div>
      <!-- Results section -->
      <div class="results-section">
          <!-- Design Tokens Tab -->
          <div v-if="activeTab === 'tokens'" class="tab-content">
            <!-- Scan Type Selection -->
            <div class="step-container">
              <div class="step-content">
                <!-- 1. Title -->
                <h3 class="step-title">Choose what to scan for</h3>

                <!-- 2. Scan Selection cards -->
                <div class="scan-cards">
                  <div v-for="option in tokenScanOptions"
                       :key="option.value"
                       class="scan-card"
                       :class="{ 
                         'selected': selectedScanType === option.value,
                         'interactive': true
                       }"
                       role="option"
                       :aria-selected="selectedScanType === option.value"
                       tabindex="0"
                       @click="selectScanType(option.value)"
                  >
                    <div class="scan-card-icon">
                      <div class="icon" v-html="icons[option.icon]"></div>
                    </div>
                    
                    <div class="scan-card-content">
                      <div class="scan-card-text">
                        <div class="scan-card-title">{{ option.label }}</div>
                        <div class="scan-card-description">{{ option.description }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Scan Controls -->
            <div class="divider"></div>

            <!-- Scanning Section - Following Hierarchy -->
            <div class="step-container">
              <div class="step-content">
                <!-- 1. Title -->
                <h3 class="step-title">Start scanning</h3>

                <!-- 2. Progress Bar -->
                <div class="progress-container">
                  <div class="progress-bar">
                    <!-- Remove progress track -->
                    <div class="progress-fill" 
                         :style="{ 
                           width: `${scanProgress}%`,
                           background: getProgressBarColor()
                         }"
                    ></div>
                    <span class="progress-text" v-if="canStartScan || isScanning">{{ getProgressStatus() }}</span>
                  </div>
                </div>

                <!-- 3. Buttons -->
                <div class="scan-buttons">
                  <!-- Start/Rescan button -->
                  <button 
                    v-if="!isScanning"
                    @click="startScan(showRescanButton)" 
                    class="button"
                    :class="{
                      'primary-button': !showRescanButton,
                      'secondary-button rescan': showRescanButton
                    }"
                    :disabled="!canStartScan"
                    :title="getStartScanButtonTitle()"
                  >
                    {{ showRescanButton ? 'Rescan' : 'Start Scan' }}
                  </button>
                  
                  <!-- Stop button - only show when actively scanning -->
                  <button 
                    v-if="showStopButton"
                    @click="stopScan()" 
                    class="button warning-button"
                  >
                    Stop
                  </button>
                </div>
              </div>
            </div>

            <!-- Add a new section for scan results with consistent styling -->
            <template v-if="showScanResults">
              <div class="divider"></div>
              
              <div class="step-container">
                <div class="step-content">
                  <!-- Results Header -->
                  <div class="results-header">
                    <div class="step-title-with-badge">
                      <h3 class="step-title">Scan results</h3>
                      <span class="results-badge">{{ getTotalResultsCount() }}</span>
                    </div>
                    <div class="results-actions">
                      <button 
                        class="button secondary-button"
                        @click="clearResults"
                      >
                        Clear
                      </button>
                    </div>
                  </div>

                  <!-- Results Container -->
                  <div class="results-container">
                    <div v-for="(group, groupKey) in groupedByValue" 
                         :key="groupKey" 
                         class="value-group"
                    >
                      <!-- Group Header -->
                      <div class="value-group-header" 
                           @click="toggleGroup(groupKey)"
                           :class="{ 'expanded': isGroupExpanded(groupKey) }"
                      >
                        <div class="group-info">
                          <span class="expand-icon">
                            {{ isGroupExpanded(groupKey) ? '‚ñº' : '‚ñ∂' }}
                          </span>
                          <!-- Add typography-specific template -->
                          <template v-if="group.refs[0]?.type === 'typography'">
                            <div class="typography-labels">
                              <span class="label font-family" v-if="group.value.fontFamily">
                                {{ group.value.fontFamily }}
                              </span>
                              <span class="label font-weight" v-if="group.value.fontWeight">
                                {{ group.value.fontWeight }}
                              </span>
                              <span class="label font-size" v-if="group.value.fontSize">
                                {{ group.value.fontSize }}px
                              </span>
                            </div>
                          </template>
                          <!-- Keep existing templates for other types -->
                          <template v-else-if="group.refs[0]?.type === 'fill' || group.refs[0]?.type === 'stroke'">
                            <color-preview :color="group.value" />
                          </template>
                          <template v-else>
                            <div class="typography-labels">
                              <span class="label value">{{ formatValue(group.value) }}</span>
                              <span v-if="group.refs[0]?.type === 'gap'" class="label gap">{{ group.value }}px</span>
                              <span v-if="group.refs[0]?.type === 'verticalGap'" class="label vertical-gap">{{ group.value }}px</span>
                              <span v-if="group.refs[0]?.type === 'horizontalPadding'" class="label horizontal-padding">{{ group.value }}px</span>
                              <span v-if="group.refs[0]?.type === 'verticalPadding'" class="label vertical-padding">{{ group.value }}px</span>
                            </div>
                          </template>
                        </div>
                        <div class="group-actions">
                          <span class="label instance-count">{{ group.refs.length }}√ó</span>
                          <button 
                            class="button secondary-button"
                            @click.stop="selectGroup(group.refs, $event)"
                          >
                            Select All
                          </button>
                        </div>
                      </div>

                      <!-- Group Details -->
                      <div v-if="isGroupExpanded(groupKey)" 
                           class="value-group-details"
                           @click.stop
                      >
                        <div v-for="ref in group.refs" 
                             :key="ref.nodeId" 
                             class="reference-item"
                        >
                          <div class="reference-info">
                            <div class="reference-name">{{ ref.nodeName }}</div>
                            <div class="reference-location">{{ ref.location }}</div>
                          </div>
                          <button 
                            class="button secondary-button small"
                            @click="selectNode(ref.nodeId, $event)"
                          >
                            Select
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- Unlinked Library Tab -->
          <div v-if="activeTab === 'library-tokens'" class="tab-content">
            <div class="step-container">
              <div class="step-content">
                <!-- Scan Type Selection -->
                <h3 class="step-title">Choose what to scan for</h3>
                <!-- Restore icons in scan cards for Unlinked Tokens -->
                <div class="scan-cards library-scan-cards" 
                     role="listbox" 
                     tabindex="0"
                     @keydown="handleLibraryScanCardKeydown"
                >
                  <div v-for="(option, index) in libraryTokenScanOptions"
                       :key="option.value"
                       class="scan-card"
                       role="option"
                       :aria-selected="selectedLibraryTokenScanType === option.value"
                       :tabindex="selectedLibraryTokenScanType === option.value ? 0 : -1"
                       @click="selectLibraryScanType(option.value)"
                  >
                    <div class="scan-card-icon" v-html="icons[option.icon]"></div>
                    <div class="scan-card-content">
                      <span v-if="isLoadingOption === option.value" class="loading-spinner"></span>
                      <template v-else>
                        <div class="scan-card-title">{{ option.label }}</div>
                        <div class="scan-card-description">{{ option.description }}</div>
                      </template>
                    </div>
                  </div>
                </div>

                <div class="divider"></div>

                <!-- Scan Controls Section with improved UI -->
                <div class="scan-section">
                  <!-- Progress Bar - Always Visible -->
                  <div class="progress-container">
                    <div class="progress-bar">
                      <div class="progress-track"></div>
                      <div class="progress-fill" :style="{ width: getProgressWidth() }"></div>
                      <div class="progress-text">{{ getProgressStatus() }}</div>
                    </div>
                  </div>

                  <!-- Scan Buttons with improved layout -->
                  <div class="scan-buttons-wrapper">
                    <!-- Primary Action Buttons -->
                    <div class="primary-actions" v-if="!isLibraryScanning">
                      <button 
                        v-if="!isScanning"
                        @click="scanLibraryTokens" 
                        class="button primary-button"
                        :disabled="!canStartScan"
                        :title="getStartScanButtonTitle()"
                      >
                        Start Scan
                      </button>
                      <button 
                        v-if="hasLibraryResults"
                        @click="scanLibraryTokens" 
                        class="button secondary-button"
                      >
                        Rescan
                      </button>
                    </div>

                    <!-- Control Buttons -->
                    <div class="control-buttons" v-else>
                      <button 
                        v-if="!isPaused"
                        @click="pauseLibraryScan" 
                        class="button secondary-button"
                      >
                        <span class="button-icon">‚è∏</span>
                        Pause
                      </button>
                      <button 
                        v-else
                        @click="resumeLibraryScan" 
                        class="button primary-button"
                      >
                        <span class="button-icon">‚ñ∂Ô∏è</span>
                        Resume
                      </button>
                      <button 
                        @click="stopLibraryScan" 
                        class="button warning-button"
                      >
                        <span class="button-icon">‚èπ</span>
                        Stop
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Add scan results summary -->
                <div v-if="scanSummary" class="scan-summary">
                  <div class="summary-header">
                    <h4>Scan Summary</h4>
                    <span class="timestamp">{{ scanSummary.timestamp }}</span>
                  </div>
                  <div class="summary-stats">
                    <div class="stat-item">
                      <span class="stat-label">Nodes Scanned</span>
                      <span class="stat-value">{{ scanSummary.totalNodes }}</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-label">Variables Found</span>
                      <span class="stat-value">{{ scanSummary.totalTokens }}</span>
                    </div>
                  </div>
                </div>

                <!-- Results Section -->
                <div v-if="hasLibraryResults" class="library-results">
                  <!-- Summary -->
                  <div class="results-summary">
                    <div class="summary-item">
                      <span class="summary-label">Total Variables</span>
                      <span class="summary-value">{{ activeLibraryTokens.length + inactiveLibraryTokens.length }}</span>
                    </div>
                    <div class="summary-item warning" v-if="inactiveLibraryTokens.length">
                      <span class="summary-label">Inactive Libraries</span>
                      <span class="summary-value">{{ getUniqueLibraries(inactiveLibraryTokens).length }}</span>
                    </div>
                  </div>

                  <!-- Inactive Libraries Section -->
                  <div v-if="inactiveLibraryTokens.length > 0" class="token-section">
                    <div class="section-header warning">
                      <div class="header-content">
                        <h4 class="section-title">Inactive Library Tokens</h4>
                        <span class="token-count">{{ inactiveLibraryTokens.length }}</span>
                      </div>
                    </div>
                    
                    <!-- Group by Library -->
                    <div v-for="library in getUniqueLibraries(inactiveLibraryTokens)" 
                         :key="library"
                         class="library-group">
                      <div class="library-header">
                        <span class="library-name">{{ library }}</span>
                        <button class="button secondary-button"
                                @click="activateLibrary(library)">
                          Activate Library
                        </button>
                      </div>
                      
                      <div class="token-list">
                        <div v-for="token in getTokensByLibrary(inactiveLibraryTokens, library)" 
                             :key="token.id" 
                             class="token-item inactive">
                          <div class="token-info">
                            <span class="token-name">{{ token.name }}</span>
                            <div class="token-details">
                              <span class="token-type">{{ formatTokenType(token.type) }}</span>
                              <span class="token-usage">Used in {{ token.usages.length }} {{ token.usages.length === 1 ? 'place' : 'places' }}</span>
                            </div>
                          </div>
                          <button 
                            class="button text-button"
                            @click="showTokenUsages(token)"
                            :title="'Show where this token is used'"
                          >
                            <span class="button-icon">üëÅ</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- No Results State -->
                <div v-else-if="!isLibraryScanning" class="no-results">
                  <div class="no-results-icon">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                      <path d="M16 5.33334C22.6667 5.33334 28.3333 9.33334 30.6667 14.6667C28.3333 20 22.6667 24 16 24C9.33334 24 3.66668 20 1.33334 14.6667C3.66668 9.33334 9.33334 5.33334 16 5.33334Z" fill="currentColor" fill-opacity="0.3"/>
                    </svg>
                  </div>
                  <span class="no-results-text">No tokens found</span>
                </div>
              </div>
            </div>

            <!-- Inside library-tokens tab content -->
            <div v-if="activeTab === 'library-tokens'" class="tab-content">
              <!-- ... existing scan controls ... -->

              <!-- Variables Analysis Section -->
              <div v-if="hasLibraryResults" class="library-analysis">
                <!-- Collections Overview -->
                <div class="analysis-section">
                  <h3 class="section-title">Variable Collections</h3>
                  <div class="collections-list">
                    <div v-for="collection in variableCollections" 
                         :key="collection.id" 
                         class="collection-item"
                         :class="{ 'inactive': !collection.isActive }">
                      <div class="collection-header">
                        <div class="collection-info">
                          <span class="collection-name">{{ collection.name }}</span>
                          <span class="collection-status" :class="{ 'warning': !collection.isActive }">
                            {{ collection.isActive ? 'Active' : 'Inactive' }}
                          </span>
                        </div>
                        <span class="variable-count">
                          {{ collection.variablesCount }} variables
                        </span>
                      </div>
                      
                      <!-- Variables in Collection -->
                      <div class="variables-list">
                        <div v-for="variable in collection.variables" 
                             :key="variable.id" 
                             class="variable-item">
                          <div class="variable-header">
                            <span class="variable-name">{{ variable.name }}</span>
                            <span class="variable-type">{{ formatTokenType(variable.type) }}</span>
                          </div>
                          
                          <!-- Mode Information -->
                          <div class="mode-info">
                            <span class="mode-label">Current Mode:</span>
                            <span class="mode-value">{{ variable.currentMode }}</span>
                          </div>
                          
                          <!-- Usage Information -->
                          <div class="usage-info">
                            <div class="usage-header" @click="toggleUsageDetails(variable.id)">
                              <span>Used in {{ variable.usages.length }} {{ variable.usages.length === 1 ? 'place' : 'places' }}</span>
                              <span class="expand-icon">{{ isUsageExpanded(variable.id) ? '‚ñº' : '‚ñ∂' }}</span>
                            </div>
                            
                            <!-- Usage Details (Expandable) -->
                            <div v-if="isUsageExpanded(variable.id)" class="usage-details">
                              <div v-for="usage in variable.usages" 
                                   :key="`${usage.nodeId}-${usage.property}`" 
                                   class="usage-item">
                                <div class="usage-node-info">
                                  <span class="node-name">{{ usage.nodeName }}</span>
                                  <span class="property-name">{{ usage.property }}</span>
                                </div>
                                <button class="button text-button"
                                        @click="selectNode(usage.nodeId)"
                                        title="Select this instance">
                                  <span class="button-icon">üëÅ</span>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
      </div>
      </div>

      <!-- Sticky footer -->
      <div class="sticky-footer">
        <div class="version-info">
          <span>v</span>
          <span class="version-number">1.0.0</span>
        </div>
        <button class="donate-button" @click="openStripePayment">
          <span class="cat-icon">üê±</span>
          <span>Feed my cats</span>
        </button>
        <div class="resize-handle"></div>
      </div>
    </div>
    <!-- Success Toast -->
    <div class="success-toast" 
      :class="{ 
        visible: showSuccessToast,
        warning: successMessage === 'Scanning the entire page may take longer'
      }"
      v-if="showSuccessToast">

      <div class="success-toast-content">
        <div class="success-toast-icon">
          <svg v-if="successMessage !== 'Scanning the entire page may take longer'" 
            width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33334C4.31811 1.33334 1.33334 4.31811 1.33334 8C1.33334 11.6819 4.31811 14.6667 8 14.6667C11.6819 14.6667 14.6667 11.6819 14.6667 8C14.6667 4.31811 11.6819 1.33334 8 1.33334ZM11.0607 6.27274L7.39401 9.93941L5.27274 7.81814L6.06069 7.03019L7.39401 8.36351L10.2727 5.48479L11.0607 6.27274Z" fill="currentColor"/>
          </svg>
          <svg v-else width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1L14.6667 13H1.33334L8 1ZM8 3.66667L3.73334 11.6667H12.2667L8 3.66667ZM7.33334 6H8.66668V8.66667H7.33334V6ZM7.33334 10H8.66668V11.3333H7.33334V10Z" fill="currentColor"/>
        </svg>
        </div>
        <span class="success-toast-message">{{ successMessage }}</span>
        <button class="success-toast-close" @click="dismissToast">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M12.6667 4.27337L11.7267 3.33337L8.00001 7.06004L4.27334 3.33337L3.33334 4.27337L7.06001 8.00004L3.33334 11.7267L4.27334 12.6667L8.00001 8.94004L12.6667 4.27337Z" fill="currentColor"/>
        </svg>
        </button>
      </div>
    </div>
    <!-- Add error toast component -->
    <div class="error-toast" v-if="showErrorToast">
      <div class="error-toast-content">
        <div class="error-toast-icon">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33337L14.6667 13.3334H1.33334L8 1.33337ZM7.33334 6.66671H8.66668V9.33337H7.33334V6.66671ZM7.33334 10.6667H8.66668V12H7.33334V10.6667Z" fill="currentColor"/>
          </svg>
        </div>
        <span class="error-toast-message">{{ errorMessage }}</span>
        <button class="error-toast-close" @click="dismissErrorToast">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M12.6667 4.27337L11.7267 3.33337L8.00001 7.06004L4.27334 3.33337L3.33334 4.27337L7.06001 8.00004L3.33334 11.7267L4.27334 12.6667L8.00001 8.94004L12.6667 4.27337Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <style>
    /* Add Figma's font stack at the top of your styles */
    :root {
    --font-stack: 
    -apple-system, 
    BlinkMacSystemFont, 
    'Segoe UI', 
    Roboto, 
    Oxygen-Sans, 
    Ubuntu, 
    Cantarell, 
    'Helvetica Neue', 
    sans-serif;
    
    /* Add root spacing variables */
    --spacing-2xs: 2px;
    --spacing-xs: 4px;
    --spacing-s: 6px;
    --spacing-md: 12px;
    --spacing-lg: 16px;
    --spacing-xl: 20px;
    --spacing-2xl: 24px;
    }
    
    [v-cloak] { display: none; }
    
    html {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    background-color: #2C2C2C;
    color: #FFFFFF;
    font-family: var(--font-stack);
    font-size: 12px;
    line-height: 14px;
    }
    /* Disable text selection globally */
    body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    background-color: #2C2C2C;
    color: #FFFFFF;
    font-family: var(--font-stack);
    font-size: 12px;
    line-height: 14px;
    user-select: none;
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none; /* Firefox */
    -ms-user-select: none; /* IE/Edge */
    }
    #app {
    position: relative;
    height: 100vh;
    overflow: hidden;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
    width: 6px;
    }
    
    ::-webkit-scrollbar-track {
    background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
    background: var(--figma-color-bg-tertiary);
    border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
    background: var(--figma-color-bg-secondary);
    }
        
    @keyframes spinner {
    from {transform: rotate(0deg);}
    to {transform: rotate(360deg);}
    }

    @keyframes spin {
    to { transform: rotate(360deg);}
    }
    
    /* Allow text selection in specific areas if needed */
    .code {
    user-select: text;
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    }
    
    .selectable-text {
    -moz-user-select: text;
    -ms-user-select: text;
    -webkit-user-select: text;
    user-select: text;
    }
    
    /* Update plugin container spacing */
    .plugin-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    padding: 0;
    }
    

    /* Update step container spacing */
    .step-container {
    padding: var(--spacing-md);
    }
    
    /* Update step header spacing */
    .step-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-2xs);
    margin: var(--spacing-2xs);
    }
    
    /* Update step title spacing */
    .step-title {
    font-size: 14px;
    font-weight: 600;
    margin: 0;
    padding: var(--spacing-2xs);
    gap: var(--spacing-2xs);
    }

    .step-content {
    flex-direction: column;
    display: flex;
    }
    
    .step-title-with-badge {
    display: flex;
    align-items: center;
    }

    
    /* Update scan settings spacing */
    .scan-settings {
    margin-top: 4px;
    background: var(--figma-color-bg-secondary);
    border-radius: 6px;
    overflow: hidden;
    padding: 0;
    }
    
    /* Update settings header spacing */
    .settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    cursor: pointer;
    }
    
    /* Toast styles */
    .toast {
    display: flex;
    align-items: center;
    padding: 6px 8px;
    margin: 4px 0;
    border-radius: 6px;
    background-color: var(--figma-color-bg-warning-tertiary);
    color: var(--figma-color-text-onwarning-secondary);
    border: 1px solid var(--figma-color-border-warning);
    }
    .toast-icon {
    color: white;
    margin-right: 8px;
    opacity: 1;
    }
    .toast-message {
    color: white;
    font-size: 12px;
    font-weight: 500;
    opacity: 1;
    }

    .toast.success {
    font-size: 12px;
    background: var(--figma-color-bg-success-tertiary);
    color: white;
    border: 1px solid var(--figma-color-border-success);
    margin-right: 8px;
    font-weight: 500;
    opacity: 1;
    }

    .success-toast.warning {
    background: var(--figma-color-bg-warning-tertiary);
    border: 1px solid var(--figma-color-border-warning);
    color: var(--figma-color-text-onwarning-secondary);
    }
    
    .success-toast-message .success-toast.warning .success-toast-icon {
    color: white;
    }

    /* Container styles */
    .selection-container,
    .results-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin: 4px 0;
    }
    
    /* Update content section spacing */
    .content-section {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    }
    
    /* Update scan section spacing */
    .scan-section {
    background: var(--figma-color-bg);
    padding: 0;
    }
    
    /* Update divider spacing */
    .divider {
    height: 1px;
    background-color: var(--figma-color-border);
    margin: 8px 0;
    }
    
    /* Update watch toggle spacing */
    .watch-toggle {
    padding: 4px 6px;
    margin: -2px;
    }
  
    .results-section {
    padding-bottom: 16px;
    }
    
    .header {
    flex-shrink: 0;
    padding: 16px;
    border-bottom: 1px solid var(--figma-color-border);
    }
        
    .header-left {
    display: flex;
    align-items: center;
    gap: 8px;
    }
    
    .header-right {
    display: flex;
    align-items: center;
    gap: 8px;
    }

    .header h2 {
    font-family: var(--font-stack);
    font-weight: 600;
    font-size: 12px;
    line-height: 16px;
    margin: var(--spacing-2xs);
    }
    
    .select-input {
    padding: 8px 8px 8px 12px;
    height: 32px;
    border: 1px solid var(--figma-color-border);
    border-radius: 2px;
    background: var(--figma-color-bg);
    color: var(--figma-color-text);
    font-family: var(--font-stack);
    font-size: 11px;
    line-height: 16px;
    appearance: none;
    cursor: pointer;
    }
    
    /* Button Styles */
    .button {
    min-width: unset;
    flex: 1;
    border-radius: 6px;
    height: 32px;
    font-size: 12px;
    height: 32px;
    transition: all 0.2s ease;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0 16px;
    font-size: 11px;
    min-width: 90px;
    justify-content: center;
    cursor: pointer;
    font-weight: 500;
    border: none;
    display: inline-flex;
    padding: 0 var(--spacing-md);
    width: auto;
    }
    
    /* Hover state */
    .button:hover:not(:disabled) {
    background: var(--figma-color-bg-hover);
    }
    
    /* Focus state */
    .button:focus {
    outline: 2px solid var(--figma-color-bg-brand);
    outline-offset: 2px;
    }
    
    /* Disabled state */
    .button:disabled {
    background: var(--figma-color-bg-disabled);
    color: var(--figma-color-text-disabled);
    cursor: not-allowed;
    }
    
    /* Use the same loading style for all buttons */
    .button.loading {
    position: relative;
    color: transparent !important;
    }
    
    .loading-spinner {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    }
      
    .loading-spinner {
    width: 16px;
    height: 16px;
    margin: auto;
    position: absolute;
    border: 2px solid var(--figma-color-bg-brand);
    border-top-color: transparent;
    animation: spinner 0.6s linear infinite;
    border-width: 2px;
    border-radius: 50%;
    border-right-color: var(--figma-color-bg-brand);
    border-top-color: var(--figma-color-bg-brand);
    }

    /* Loading styles */
    .select-button.loading {
    position: relative;
    color: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    }
    
    .primary-buttons {
    display: flex;
    gap: 8px;
    }
    
    .primary-button {
    background: var(--figma-color-bg-brand);
    border: 1px solid var(--figma-color-border-brand-strong);
    color: white;
    }
    
    .primary-button:hover {
    background: var(--figma-color-bg-brand);
    filter: brightness(1.1);
    }
    /* Button styles */
    .primary-button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    }
    
    .secondary-button {
    color: var(--figma-color-text);
    background: var(--figma-color-bg-secondary);
    }

    .secondary-button.rescan {
    background: var(--figma-color-bg-brand-tertiary);
    color: var(--figma-color-text-brand);
    border: 1px solid var(--figma-color-border-brand-strong);
    }
    
    .secondary-button.rescan:hover {
    background: var(--figma-color-bg-brand);
    color: white;
    border-color: var(--figma-color-border-brand-strong);
    }

    /* Small variant for reference items */
    .button.secondary-button.small {
    font-size: 11px;
    min-height: 24px;
    padding: 4px 8px;
    }

    /* Add loading state for buttons */
    .button.secondary-button.loading {
    color: transparent;
    position: relative;
    }
    /* Update button styles in results section */
    .button.secondary-button {
    background: var(--figma-color-bg-secondary);
    position: relative;
    border-radius: 6px;
    border: 1px solid var(--figma-color-border);
    color: var(--figma-color-text);
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
    padding: 5px 12px;
    transition: all 0.1s ease;
    z-index: 1;
    }

    /* Active/Pressed state */
    .button.secondary-button:active {
    background: var(--figma-color-bg-pressed);
    border-color: var(--figma-color-border-strong);
    color: var(--figma-color-text);
    }
    /* Disabled state */
    .button.secondary-button:disabled {
    cursor: not-allowed;
    opacity: 0.4;
    pointer-events: none;
    }
    /* Hover state */
    .button.secondary-button:hover {
    background: var(--figma-color-bg-hover);
    border-color: var(--figma-color-highlight);
    }

    /* Focus state */
    .button.secondary-button:focus {
        box-shadow: 0 0 0 2px var(--figma-color-border-brand-strong);
        outline: none;
    }

    /* Progress Bar Styles */
    .progress-container {
    background: var(--figma-color-bg);
    }
    
    .progress-bar {
    height: 16px;
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 6px;
    background: var(--figma-color-bg-disabled);
    transition: background-color 0.3s ease;
    }

    .progress-text {
    color: var(--figma-color-text-secondary);
    height: 100%;
    font-size: 10px;
    bottom: 0;
    position: absolute;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    right: 8px;
    display: flex;
    align-items: center;
    font-weight: 500;
    justify-content: center;
    width: 100%;
    z-index: 1;
    }
    
    .progress-fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    min-width: 48px; /* Ensure text is always visible */
    padding: 0 12px;
    background: linear-gradient(90deg,
          var(--figma-color-bg-brand) 0%,
          var(--figma-color-bg-brand-hover) 100%);
    display: flex;
    align-items: center;
    transition: width 0.3s ease;
    filter: brightness(0.95);
    }
    
    .progress-bar.scanning {
    --progress-color: var(--figma-color-bg-brand); /* Scanning state */
    background: var(--figma-color-bg-brand);
    }
    
    .progress-bar.complete {
    background: var(--figma-color-bg-success);
    --progress-color: var(--figma-color-bg-success); /* Complete state */
    }
    
    .progress-bar.error {
    --progress-color: var(--figma-color-bg-danger); /* Error state */
    background: var(--figma-color-bg-danger);
    }
    
    .progress-track {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: var(--figma-color-bg-secondary);
    }

    .progress-info {
    justify-content: space-between;
    align-items: center;
    color: var(--figma-color-text-secondary);
    display: flex;
    font-size: 11px;
    }
    
    .scan-controls {
    margin: 0px;
    }
    
    /* Button Container Styles */
    .scan-buttons-container {
    display: flex;
    flex-direction: column;
    }
    /* Improved Button Layout Styles */
    .scan-buttons-wrapper {
    padding: 0 16px;
    }

    .scan-buttons {
    gap: var(--spacing-xs);
    display: flex;
    flex-wrap: wrap;
    }

    .scan-details {
    right: 12px;
    color: var(--figma-color-text-secondary);
    position: absolute;
    transform: translateY(-50%);
    color: var(--figma-color-text-secondary);
    top: 50%;
    font-size: 11px;
    }
    
    .references-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow-y: auto;
    }
    
    .reference-card {
    padding: 0;
    background: var(--figma-color-bg-secondary);
    border-radius: 2px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    }
    
    .reference-info {
    flex: 1;
    padding: 12px;
    }
    
    .reference-header {
    cursor: pointer;
    user-select: none;
    padding: 4px 0;
    }

    
    .expand-icon {
    color: var(--figma-color-text-secondary);
    width: 16px;
    height: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.1s ease;
    margin: -4px;
    }
    
    .current-value-label {
    color: var(--figma-color-text-secondary);
    font-size: 11px;
    }
    
    .reference-header:hover {
    background: var(--figma-color-bg-hover);
    }
    
    .parameter-name {
    font-family: var(--font-stack);
    font-weight: 500;
    font-size: 11px;
    }
    
    .missing-count {
    font-size: 12px;
    color: var(--figma-color-text-secondary);
    font-family: var(--font-stack);
    font-size: 11px;
    line-height: 16px;
    }
    
    .variable-details {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--figma-color-border);
    }
    
    .variable-item {
    border-radius: 4px;
    background: var(--figma-color-bg);
    background: var(--figma-color-bg-tertiary);
    margin-bottom: 8px;
    padding: 12px;
    border-radius: 2px;
    padding: 8px 12px;
    }
    
    .node-info,
    .location-info {
    font-family: var(--font-stack);
    font-size: 11px;
    line-height: 16px;
    margin-top: 2px;
    }
    
 
    .empty-state {
    padding: 16px;
    text-align: center;
    color: var(--figma-color-text-secondary);
    }
    
    .empty-state p {
    margin: 0 0 16px 0;
    }
    
    .empty-state-steps {
    text-align: left;
    display: inline-block;
    line-height: 24px;
    }
    
    .value-group {
    overflow: hidden;
    background: var(--figma-color-bg-secondary);
    flex-direction: column;
    border-radius: 6px;
    border: 1px solid var(--figma-color-border);
    display: flex;
    gap: 4px;
    }
    
    .value-group-header {
    padding: 8px 12px;
    cursor: pointer;
    user-select: none;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    transition: background-color 0.2s ease;
    transition: background 0.2s ease;
    border-radius: 6px;
    display: flex;
    min-height: 40px;
    }
    
    .value-group-header:hover {
    background: var(--figma-color-bg-hover);
    }

    
    .reference-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--figma-color-bg-secondary);
    border-radius: 6px;
    margin-bottom: 4px;
    transition: all 0.2s ease;
    }
    
    .reference-item:hover {
    background: var(--figma-color-bg-hover);
    transform: translateX(4px);
    }
    
    .scan-scope-selector {
    padding: 2px 0;
    width: 100%;
    }
    
    .toggle-container {
    display: flex;
    align-items: center;
    padding: 2px 0;
    width: 100%;
    }
    
    .toggle-wrapper {
    position: relative;
    width: 28px;
    height: 16px;
    flex-shrink: 0;
    }
    
    .toggle-label {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    user-select: none;
    color: var(--figma-color-text);
    width: 100%;
    justify-content: space-between;
    padding: 2px 0;
    }
    
    .toggle-label-content {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    }
    
    .slow-badge {
    font-size: 9px;
    padding: 1px 4px;
    background: var(--figma-color-bg-warning-tertiary);
    color: var(--figma-color-text-warning);
    border-radius: 3px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.2px;
    }
    
    .toggle-label:hover .slow-badge {
    opacity: 1;
    }
    
    .toggle-input {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
    }
    
    .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--figma-color-bg-disabled);
    transition: .2s;
    border-radius: 16px;
    }
    
    .toggle-slider:before {
    position: absolute;
    content: "";
    height: 12px;
    width: 12px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .2s;
    border-radius: 50%;
    }
    
    .toggle-input:checked + .toggle-slider {
    background-color: var(--figma-color-bg-brand);
    }
    
    .toggle-input:checked + .toggle-slider:before {
    transform: translateX(12px);
    }
    
    .toggle-input:disabled + .toggle-slider {
    opacity: 0.5;
    cursor: not-allowed;
    }
    
    .selection-count {
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    }
    
    /* Message styles */
    .warning-message,
    .info-message {
    margin: var(--spacing-xs);
    padding: var(--spacing-sm);
    border-radius: 6px;
    font-size: 11px;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    }
    
    .warning-message {
    background: var(--figma-color-bg-warning);
    color: white;
    border: 1px solid var(--figma-color-border-warning);
    }
    
    .info-message {
    background-color: var(--figma-color-bg-secondary);
    color: var(--figma-color-text-secondary);
    }
    

    /* icons states */
    .warning-icon,
    .info-icon {
    width: 12px;
    height: 12px;
    flex-shrink: 0;
    color: white;
    }
    
    .icon-warning {
    color: var(--figma-color-text-warning);
    }
    
    .icon-info {
    color: var(--figma-color-text-secondary);
    }
      
    /* Icon styles */
    .icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    }
    
    .icon svg {
    height: 100%;
    display: block;
    width: 100%;
    }
    
    .scan-card-icon .icon {
    opacity: 0.8;
    }
    
    .scan-card:hover .icon,
    .scan-card.selected .icon {
    opacity: 1;
    }


    /* Toggle label styles */
    .toggle-label {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    user-select: none;
    color: var(--figma-color-text);
    width: calc(100% - var(--spacing-xs) * 2);
    justify-content: space-between;
    padding: var(--spacing-2xs) 0;
    }
    

    /* Section styles */
    .section-title {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--figma-color-text);
    }
    
    .section-subtitle {
    font-size: 12px;
    font-weight: 600;
    margin: 0 0 12px 0;
    color: var(--figma-color-text);
    }
    
    /* Scan card styles */
    .scan-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    }
    
    .scan-card {
    transition: all 0.2s ease;
    cursor: pointer;
    user-select: none;
    padding: var(--spacing-md);
    border: 1px solid transparent;
    padding: 12px;
    align-items: flex-start;
    border-radius: 6px;
    gap: 12px;
    display: flex;
    background: var(--figma-color-bg-secondary);
    }
    
    .scan-card:hover:not(.selected),
    .scan-card:active:not(.selected) {
    background: var(--figma-color-bg-hover);
    border-color: var(--figma-color-border);
    }
    
    .scan-card.selected {
    background: var(--figma-color-bg-brand);
    border-color: var(--figma-color-border-brand);
    }
    
    .scan-card.selected .scan-card-icon,
    .scan-card.selected .scan-card-title,
    .scan-card.selected .scan-card-description {
    color: white;
    }
    
    .scan-card:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--figma-color-border-brand);
    border-radius: 6px;
    }
    
    .scan-card-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--figma-color-text);
    flex-shrink: 0;
    pointer-events: none;
    }
    
    .scan-card-content {
    flex: 1;
    min-width: 0;
    pointer-events: none;
    }
    
    .scan-card-text {
    display: flex;
    flex-direction: column;
    gap: 2px;
    }
    
    .scan-card-title {
    font-weight: 600;
    font-size: 13px;
    color: var(--figma-color-text);
    transition: color 0.2s ease;
    }
    
    .scan-card-description {
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    transition: color 0.2s ease;
    }
    
    .scan-card.selected .scan-card-icon {
    color: var(--figma-color-text-brand);
    }
    
    .scan-card.selected .scan-card-title {
    color: var(--figma-color-text-brand);
    }
    
    .scan-card.selected .scan-card-description {
    color: var(--figma-color-text-brand);
    }
   
    /* Divider */
    .divider {
    height: 1px;
    margin: var(--spacing-sm) 0;
    background: var(--figma-color-border);
    margin: var(--spacing-lg) 0;
    margin: 8px 0;
    background-color: var(--figma-color-border);
    }
    

    /* Watch toggle styles */
    .watch-toggle {
    background: none;
    border: none;
    padding: 4px 6px;
    margin: -2px;
    border-radius: 4px;
    cursor: pointer;
    color: var(--figma-color-text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    }
    
    .watch-toggle-content {
    display: flex;
    align-items: center;
    gap: 6px;
    }
    
    .watch-toggle-text {
    font-size: 11px;
    font-weight: 500;
    }
    
    .watch-toggle:hover:not(.disabled) {
    background: var(--figma-color-bg-hover);
    color: var(--figma-color-text);
    }
    
    .watch-toggle.active:not(.disabled) {
    color: var(--figma-color-text-brand);
    background: var(--figma-color-bg-brand-tertiary);
    }
    
    .watch-toggle.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: var(--figma-color-bg-disabled);
    color: var(--figma-color-text-disabled);
    }
    
    .watch-toggle.disabled:hover {
    background: var(--figma-color-bg-disabled);
    color: var(--figma-color-text-disabled);
    }
    
    /* Results styles */
    .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    }
    
    .results-actions {
    display: flex;
    min-width: unset;
    padding: 5px 12px;
    height: 28px;
    gap: 8px;
    }
    
    .results-badge {
    justify-content: center;
    font-weight: 500;
    border-radius: 10px;
    padding: 2px 4px;
    min-width: 20px;
    align-items: center;
    height: 20px;
    background: var(--figma-color-bg-secondary);
    display: inline-flex;
    color: white;
    color: var(--figma-color-text);
    font-size: 11px;
    padding: 0 6px;
    }
    
    /* Action buttons */
    .rescan,
    .clear-results {
    background: none;
    border: none;
    padding: 4px 6px;
    border-radius: 4px;
    cursor: pointer;
    color: var(--figma-color-text-secondary);
    font-size: 11px;
    font-weight: 500;
    }
     
    .analysis-loading {
    margin: 0;
    align-items: center;
    padding: 16px;
    gap: 8px;
    color: var(--figma-color-text-secondary);
    flex-direction: column;
    display: flex;
    }
    
    .analysis-loading {
    width: 24px;
    height: 24px;
    border-width: 2.5px;
    margin: 8px auto;
    }


    .tab-button {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 4px;
    border: none;
    background: none;
    color: var(--figma-color-text-secondary);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    }
    
    .tab-button.active {
    background: var(--figma-color-bg);
    color: var(--figma-color-text);
    font-weight: 500;
    }
    
    .tab-button.inactive:hover {
    background: var(--figma-color-bg-hover);
    color: var(--figma-color-text);
    }
    
    .tab-badge {
        background: var(--figma-color-bg-danger);
        border-radius: var(--border-radius-sm);
        color: white;
        font-size: 11px;
        margin-left: 4px;
        padding: 2px 6px;
    }
    
    .tab-icon {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.8;
    align-items: center;
    }
    
    .tab-content {
    padding: var(--spacing-sm);
    }

    .tab-label {
    display: flex;
    align-items: center;
    gap: 4px;
    }
    
    .tab-navigation {
    background: var(--figma-color-bg-secondary);
    border-radius: 6px;
    display: flex;
    gap: 2px;
    padding: var(--spacing-2xs);
    margin-bottom: var(--spacing-sm);
    }

    /* Adjust beta badge in tab */
    .beta-badge {
    font-size: 8px;
    padding: 0px 3px;
    margin-left: 2px;
    }


  
    /* Description */
    .description {
    color: var(--figma-color-text-secondary);
    margin: 8px 0 16px;
    }
    
    /* Library styles */
    .library-scan-controls {
    margin-top: 16px;
    }
    
    .library-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    }
    
    .libraries-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    }
    
    .library-item {
    padding: 8px;
    background: var(--figma-color-bg);
    border-radius: 4px;
    }
    
    .library-header {
    padding: 8px 12px;
    justify-content: space-between;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: 6px 6px 0 0;
    align-items: center;
    transition: background-color 0.2s ease;
    display: flex;
    margin-bottom: 4px;
    padding: var(--spacing-xs);
    background: var(--figma-color-bg-secondary);
    }
    
    .library-name {
    font-size: 11px;
    font-weight: 500;
    color: var(--figma-color-text-secondary);
    }
    
    .library-status {
    padding: 2px 6px;
    font-size: 10px;
    border-radius: 4px;
    }
    
    .library-status.enabled {
    color: var(--figma-color-text-onbrand);
    background: var(--figma-color-bg-success);
    }
    
    .library-status.disabled {
    background: var(--figma-color-bg-disabled);
    color: var(--figma-color-text-secondary);
    }
    
    .library-details {
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    }
    
    /* Analysis styles */
    .analysis-results {
    margin: 0;
    padding: 16px;
    background: var(--figma-color-bg-secondary);
    border-radius: 6px;
    }
    
    .analysis-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
    }
    
    .summary-item {
    display: flex;
    gap: 4px;
    flex-direction: column;
    }
    
    .summary-label {
    font-size: 11px;
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    color: var(--figma-color-text-secondary);
    }
    
    .summary-value {
    color: var(--figma-color-text);
    font-weight: 600;
    font-weight: 500;
    font-size: 16px;
    }
    
    

    
    .settings-title {
    font-size: 11px;
    margin: 0;
    font-weight: 500;
    color: var(--figma-color-text);
    }
    
    .settings-toggle {
    justify-content: center;
    cursor: pointer;
    transition: all 0.1s ease;
    padding: 8px;
    display: flex;
    background: none;
    align-items: center;
    margin: -4px;
    border: none;
    color: var(--figma-color-text-secondary);
    border-radius: 6px;
    }
    
    .settings-toggle:hover {
    color: var(--figma-color-text);
    background: var(--figma-color-bg-hover);
    }
    
    .settings-toggle:active {
    background: var(--figma-color-bg-pressed);
    color: var(--figma-color-text);
    }
    
    .settings-content {
    padding: 0 12px 12px;
    padding: 0 12px 12px; /* Keep horizontal padding consistent */
    }
    
    .setting-item {
    margin-bottom: 8px;
    }
    
    .setting-item:last-child {
    margin-bottom: 0;
    }
    
    /* Info badge */
    .info-badge {
    color: var(--figma-color-text-secondary);
    font-size: 11px;
    cursor: help;
    }
    
    /* Color preview styles */
    .color-preview {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    background: var(--figma-color-bg);
    border-radius: 2px;
    max-width: fit-content;
    border: 1px solid var(--figma-color-border);
    transition: all 0.2s ease;
    }
    
    .color-preview:hover {
    border-color: var(--figma-color-border-brand);
    transform: scale(1.02);
    }
    
    .value-group-header .color-preview {
    background: transparent;
    padding: 4px 8px;
    font-family: var(--font-stack);
    border: none;
    }
    
    .color-swatch-container {
    border-radius: 3px;
    overflow: hidden;
    width: 20px;
    height: 20px;
    padding: 0;
    border: 1px solid var(--figma-color-border);
    background: var(--figma-color-bg-secondary);
    }
    
    .color-swatch {
    height: 100%;
    border: none;
    width: 100%;
    }
    
    .color-info {
    font-family: var(--font-stack);
    align-items: center;
    display: flex;
    gap: 4px;
    font-size: 11px;
    color: var(--figma-color-text);
    }
    
    .color-hex {
    font-family: var(--font-stack);
    font-weight: 400;
    }
    
    .color-opacity {
    font-family: var(--font-stack);
    color: var(--figma-color-text-secondary);
    font-weight: 400;
    border-left: 1px solid var(--figma-color-border);
    padding-left: 4px;
    }
    
    /* Footer styles */
    .sticky-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 16px;
    background: var(--figma-color-bg);
    border-top: 1px solid var(--figma-color-border);
    height: 32px;
    z-index: 100;
    position: relative;
    }
    
    .version-info {
    align-items: center;
    color: var(--figma-color-text-secondary);
    display: flex;
    gap: 4px;
    font-size: 11px;
    }
    
    .version-number {
    color: var(--figma-color-text-tertiary);
    }
    
    /* Donate button styles */
    .donate-button {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    background: var(--figma-color-bg-secondary);
    color: var(--figma-color-text-tertiary);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    margin-right: 12px;
    }
    
    .donate-button:hover {
    color: var(--figma-color-text);
    transform: scale(1.02);
    background: var(--figma-color-bg-hover);
    }
    
    .cat-icon {
    font-size: 12px;
    transition: transform 0.2s ease;
    }
    
    .donate-button:hover .cat-icon {
    transform: scale(1.1);
    }
    
    /* Resize handle styles */
    .resize-handle {
    width: 16px;
    bottom: 0;
    right: 0;
    position: absolute;
    cursor: nwse-resize;
    touch-action: none;
    z-index: 1000;
    height: 16px;
    touch-action: none; /* Prevent touch scrolling while resizing */
    }
    
    .resize-handle::after {
    pointer-events: none; /* Ensure handle doesn't interfere with resize */
    right: 4px;
    position: absolute;
    pointer-events: none;
    border-bottom: 2px solid var(--figma-color-border);
    bottom: 4px;
    border-right: 2px solid var(--figma-color-border);
    content: '';
    width: 8px;
    height: 8px;
    }
    
    .resize-handle:hover::after {
    border-color: var(--figma-color-border-brand);
    }
    
    .typography-tag {
    transition: all 0.2s ease;
    font-weight: 500;
    border-radius: 4px;
    white-space: nowrap;
    overflow: hidden;
    padding: 2px 6px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    height: 20px;
    color: var(--figma-color-text-secondary);
    text-overflow: ellipsis;
    font-size: 11px;
    background: var(--figma-color-bg-secondary);
    }
    
    .typography-tag.font-family {
    background: var(--figma-color-bg-brand-tertiary);
    color: var(--figma-color-text-brand);
    font-weight: 600;
    }
    
    .typography-tag.weight {
    background: var(--figma-color-bg-secondary);
    }
    
    .typography-tag.size {
    min-width: 35px;
    justify-content: center;
    background: var(--figma-color-bg-secondary);
    }
        
    /* Update typography styles */
    .typography-info {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    }
    
    .typography-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    min-width: 0;
    }
    
    
    .typography-details {
    display: flex;
    flex: 1;
    gap: 8px;
    flex-direction: column;
    }
    
    .typography-preview {
    opacity: 0.8;
    white-space: nowrap;
    overflow: hidden;
    font-family: var(--font-stack);
    line-height: 16px;
    text-overflow: ellipsis;
    font-size: 11px;
    color: var(--figma-color-text);
    }
    
    .typography-specs {
    display: flex;
    gap: 4px;
    flex-direction: column;
    }
    
    /* Update reference item styles for typography */
    .reference-item {
    padding: 8px 12px;
    align-items: center;
    gap: 8px;
    border-radius: 6px;
    display: flex;
    margin-bottom: 4px;
    background: var(--figma-color-bg-secondary);
    }
    
    .reference-item:last-child {
    margin-bottom: 0;
    }
    
    .token-section {
    margin-top: 16px;
    overflow: hidden;
    background: var(--figma-color-bg-secondary);
    border-radius: 6px;
    }
    
    .section-header {
    padding: var(--spacing-md);
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--figma-color-bg);
    display: flex;
    padding: var(--spacing-xs);
    }
    
    .section-header.warning {
    color: white;
    background: var(--figma-color-bg-warning);
    }
    
    .token-count {
    font-weight: 500;
    padding: 2px 8px;
    border-radius: 12px;
    background: var(--figma-color-bg-tertiary);
    font-size: 11px;
    }
    
    .token-list {
    border-radius: 0 0 6px 6px;
    background: var(--figma-color-bg);
    overflow: hidden;
    padding: 8px;
    padding: var(--spacing-xs);
    padding: var(--spacing-sm);
    }
    
    .token-item {
    transition: all 0.2s ease;
    padding: 8px 12px;
    justify-content: space-between;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: 4px;
    align-items: center;
    margin-bottom: var(--spacing-xxs);
    border-bottom: 1px solid var(--figma-color-border);
    background: var(--figma-color-bg);
    margin-bottom: var(--spacing-xs);
    display: flex;
    margin-bottom: 4px;
    padding: var(--spacing-xs);
    }
    
    .token-item:hover {
    transform: translateX(4px);
    background: var(--figma-color-bg-hover);
    }
    
    .token-item.inactive {
    border: 1px solid var(--figma-color-border-warning);
    }
    
    .token-info {
    display: flex;
    gap: 2px;
    gap: 4px;
    flex-direction: column;
    }
    
    .token-name {
    font-weight: 500;
    }
    
    /* Library Results Styles */
    .library-results {
    margin-top: 24px;
    }
    
    .results-summary {
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-md);
    gap: 16px;
    margin-bottom: var(--spacing-sm);
    padding: 12px;
    background: var(--figma-color-bg);
    margin-bottom: 16px;
    display: flex;
    border-radius: 6px;
    padding: var(--spacing-xs);
    }
    
    .summary-item.warning .summary-value {
    color: var(--figma-color-text-danger);
    }
    
    .library-group {
    margin-bottom: 16px;
    }
    

    /* Add specific styles for analysis loading spinner */
    .analysis-loading {
    width: 24px;
    border-width: 2.5px;
    margin: 8px auto;
    height: 24px;
    }

    
    .sticky-footer {
    border-top: 1px solid var(--figma-color-border);
    bottom: 0;
    right: 0;
    justify-content: space-between;
    display: flex;
    align-items: center;
    z-index: 100;
    position: relative; /* For resize handle positioning */
    padding: 4px 16px;
    background: var(--figma-color-bg);
    height: 32px;
    position: fixed;
    left: 0;
    }
    
    .donate-button {
    margin-right: 12px; /* Adjust donate button margin */
    transition: all 0.2s ease;
    cursor: pointer;
    font-weight: 500;
    border-radius: 4px;
    align-items: center;
    gap: 6px;
    border: none;
    padding: 4px 8px;
    display: flex;
    color: var(--figma-color-text-tertiary);
    font-size: 11px;
    background: var(--figma-color-bg-secondary);
    }
    

    .info-badge {
    cursor: help;
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    }
    
    /* Add these styles */
    .color-preview {
    transition: all 0.2s ease;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 2px;
    background: var(--figma-color-bg);
    border: 1px solid var(--figma-color-border);
    display: flex;
    max-width: fit-content;
    }
    
    /* Update color preview styles for results */
    .value-group-header .color-preview {
    background: transparent;
    padding: 4px 8px;
    font-family: var(--font-stack);
    border: none;
    }
    
    /* Add visual feedback on hover */
    .resize-handle:hover::after {
    border-color: var(--figma-color-border-brand);
    }
    


    .library-header:hover {
    background: var(--figma-color-bg-hover);
    }
    
    .token-item:last-child {
    border-bottom: none;
    }
    
    .token-details {
    display: flex;
    gap: 8px;
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    }
    
    .token-type {
    padding: 2px 6px;
    background: var(--figma-color-bg-secondary);
    border-radius: 4px;
    }
    
    .scan-controls {
    display: flex;
    flex-direction: column;
    gap: 12px;
    }
    
    .button-icon {
    margin-right: 4px;
    font-size: 14px;
    }
    
    .text-button {
    padding: 4px 8px;
    color: var(--figma-color-text-secondary);
    background: none;
    }
    
    .text-button:hover {
    background: var(--figma-color-bg-hover);
    }
    

    .warning-button {
    color: white;
    background-color: var(--figma-color-bg-danger);
    background: var(--figma-color-bg-danger);
    }
    
    /* Summary Styles */
    .scan-summary {
    margin-top: 16px;
    padding: 12px;
    background: var(--figma-color-bg);
    border-radius: 6px;
    }
    
    .summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    }
    
    .timestamp {
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    }
    
    .summary-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    }
    
    .stat-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
    }
    
    .stat-label {
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    }
    
    .stat-value {
    font-size: 16px;
    font-weight: 500;
    }
    
    /* Collection Styles */
    .library-analysis {
    margin-top: 24px;
    }
    
    .analysis-section {
    background: var(--figma-color-bg);
    border-radius: 8px;
    padding: 16px;
    }
    
    .collections-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
    }
    
    .collection-item {
    background: var(--figma-color-bg-secondary);
    border-radius: 6px;
    overflow: hidden;
    }
    
    .collection-item.inactive {
    border: 1px solid var(--figma-color-border-warning);
    }
    
    .collection-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--figma-color-bg);
    }
    
    .collection-info {
    display: flex;
    align-items: center;
    gap: 8px;
    }
    
    .collection-name {
    font-weight: 500;
    }
    
    .collection-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 12px;
    background: var(--figma-color-bg-success);
    }
    
    .collection-status.warning {
    background: var(--figma-color-bg-warning);
    color: white;
    }
    
    /* Variable Styles */
    .variables-list {
    padding: 8px;
    }
    
    .variable-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    }
    
    .variable-name {
    font-weight: 500;
    }
    
    .variable-type {
    font-size: 11px;
    padding: 2px 6px;
    background: var(--figma-color-bg-secondary);
    border-radius: 4px;
    }
    
    /* Mode Styles */
    .mode-info {
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    margin-bottom: 8px;
    }
    
    /* Usage Styles */
    .usage-info {
    border-top: 1px solid var(--figma-color-border);
    padding-top: 8px;
    }
    
    .usage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 4px 0;
    color: var(--figma-color-text-secondary);
    font-size: 11px;
    }
    
    .usage-details {
    margin-top: 8px;
    }
    
    .usage-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px;
    background: var(--figma-color-bg-secondary);
    border-radius: 4px;
    margin-bottom: 4px;
    }
    
    .usage-item:hover {
    background: var(--figma-color-bg-hover);
    transform: translateX(4px);
    }
    
    .usage-node-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    }
    
    .node-name {
    font-size: 12px;
    }
    
    .property-name {
    font-size: 11px;
    color: var(--figma-color-text-secondary);
    }
    
    /* Update Scan Controls Styles */
    .scan-controls {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 16px;
    }
    
    /* Update Progress Bar Styles */
    .scan-controls {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin: 16px 0;
    }
    
    /* Update spacing for results section */
    .scan-summary {
    margin-top: 16px;
    }
    
    .library-results {
    margin-top: 24px;
    }
    
    /* Updated Progress Bar Styles */
    .scan-controls {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin: 16px 0;
    }
    
    /* Scan Section Styles */
    .scan-section {
    margin: 24px 0;
    display: flex;
    flex-direction: column;
    gap: 16px;
    }
    

    .control-buttons {
    display: flex;
    gap: 8px;
    justify-content: flex-start;
    }
    
    /* Updated Scan Section Styles */
    .scan-section {
    margin: 16px 0;
    display: flex;
    flex-direction: column;
    gap: 16px;
    }
    


    
    .primary-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-start;
    }
    
    
    .progress-status {
    color: var(--figma-color-text-secondary);
    }
    

    
    /* Scan Controls */
    .scan-controls {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    }
    


    
    /* Results Section */
    .results-section {
    padding: var(--spacing-lg);
    padding: var(--spacing-sm);
    }
    
    /* Library Results */
    .library-results {
    margin-top: var(--spacing-sm);
    margin-top: var(--spacing-xl);
    }
    
    /* Token Section */
    .token-section {
    margin-top: var(--spacing-lg);
    margin-top: var(--spacing-sm);
    }
    
    /* Library Group */
    .library-group {
    margin-bottom: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
    }
    

    
    /* Add these styles for the beta badge */
    .beta-badge {
    font-size: 9px;
    padding: 1px 4px;
    background: var(--figma-color-bg-brand-tertiary);
    color: var(--figma-color-text-brand);
    border-radius: 3px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-left: 4px;
    vertical-align: middle;
    }
    

    
  
    .step-content > * {
    margin-bottom: var(--spacing-xs);
    }
    

    /* Add loading state styles for scan cards */
    .scan-card.loading {
    pointer-events: none;
    opacity: 0.7;
    }
    
    .scan-card.loading .scan-card-content {
    position: relative;
    }
    
    .scan-card.loading {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    }
    
    .error-toast {
    position: fixed;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--figma-color-bg-danger);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 1000;
    }
    
    /* Add tooltip styles */
    [data-tooltip] {
    position: relative;
    }
    
    [data-tooltip]:before {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 4px 8px;
    background: var(--figma-color-bg);
    color: var(--figma-color-text);
    border-radius: 4px;
    font-size: 11px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    }
    
    [data-tooltip]:hover:before {
    opacity: 1;
    }
    
    /* Add focus styles for keyboard navigation */
    .scan-cards:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--figma-color-border-brand);
    border-radius: 6px;
    }
    
    /* Improve keyboard focus visibility */
    .scan-card[aria-selected="true"] {
    background: var(--figma-color-bg-brand-tertiary);
    border-color: var(--figma-color-border-brand);
    }
    
    .scan-card[aria-selected="true"]:focus {
    box-shadow: 0 0 0 2px var(--figma-color-border-brand),
          0 0 0 4px rgba(var(--figma-color-bg-brand-rgb), 0.2);
    }
    

    
    .divider {
    margin: var(--spacing-sm) 0;
    }
    
    /* Update section spacing */
    .scan-section {
    margin: var(--spacing-lg) 0;
    }
    
    .results-section {
    margin-top: var(--spacing-lg);
    }
    

    /* Results section styles */
    .results-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    /* Remove max-height limit */
    height: auto;
    overflow: visible;
    padding: 8px;
    }
    
    .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    }

    .debug-info {
        background: var(--figma-color-bg-secondary);
        border-radius: 4px;
        color: var(--figma-color-text);
        font-family: monospace;
        font-size: 11px;
        padding: 8px;
        white-space: pre-wrap;
    }

    .loading {
        color: transparent !important;
        pointer-events: none !important;
        position: relative !important;
    }

    .color-preview {
        background: transparent;
        border: none;
        font-family: var(--font-stack);
        padding: 4px 8px;
    }


    .section-title {
        color: var(--figma-color-text);
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 12px;
    }

    .typography-details {
        display: flex;
        flex-direction: column;
        flex: 1;
        gap: 8px;
    }

    .beta-badge {
        font-size: 8px;
        margin-left: 2px;
        padding: 2px 4px;
    }



    .divider {
        /* Adjust margin */
        background-color: var(--figma-color-border);
        height: 1px;
        margin: 8px 0;
        margin: var(--spacing-sm) 0;
    }

    .value-group {
        background: var(--figma-color-bg-secondary);
        border-radius: 6px;
        border: 1px solid var(--figma-color-border);
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 8px;
        overflow: hidden;
    }

    .error {
        background: var(--figma-color-bg-danger);
        color: white;
    }

    .library-group {
        margin-bottom: 16px;
    }

    .library-results {
        margin-top: 24px;
    }

    .mode-info {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
        margin-bottom: 8px;
    }


    .resize-handle {
        /* Prevent touch scrolling while resizing */
        bottom: 0;
        cursor: nwse-resize;
        height: 16px;
        position: absolute;
        right: 0;
        touch-action: none;
        width: 16px;
        z-index: 1000;
    }

    .results-container {
        height: auto;
        background: var(--figma-color-bg);
        border-radius: 6px;
        border: 1px solid var(--figma-color-border);
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
        overflow: visible;
        padding: 8px;
    }

    .scan-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin: 16px;
    }

    .scan-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin: 16px 0;
    }

    .progress-text {
        align-items: center;
        bottom: 0;
        color: white;
        display: flex;
        font-size: 12px;
        font-weight: 500;
        height: 100%;
        justify-content: center;
        left: 0;
        position: absolute;
        right: 8px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        top: 0;
        width: 100%;
        z-index: 1;
    }

    .small {
        font-size: 11px;
        min-height: 24px;
        padding: 4px 8px;
    }

    .success {
        background: var(--figma-color-bg-success-tertiary);
        border: 1px solid var(--figma-color-border-success);
        color: white;
    }

    .token-section {
        background: var(--figma-color-bg-secondary);
        border-radius: 6px;
        margin-top: 16px;
        overflow: hidden;
    }


    .content-section {
        /* Remove padding */
        flex: 1;
        overflow-y: auto;
        padding: 0;
    }

    .toggle-label {
        align-items: center;
        color: var(--figma-color-text);
        cursor: pointer;
        display: flex;
        gap: 12px;
        justify-content: space-between;
        padding: 2px 0;
        user-select: none;
        width: 100%;
    }



    .group-actions {
        align-items: center;
        display: flex;
        gap: 8px;
    }

    .reference-item {
        align-items: center;
        background: var(--figma-color-bg-secondary);
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        padding: 8px 12px;
        transition: all 0.2s ease;
    }

    .scan-cards {
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(2, 1fr);
    }



    .typography-info {
        align-items: center;
        display: flex;
        gap: 8px;
        width: 100%;
    }

    .warning-button {
        background: var(--figma-color-bg-danger);
        color: white;
    }

    .watch-toggle {
        /* Add negative margin to align better */
        border-radius: 4px;
        /* Reduce padding */
        margin: -2px;
        align-items: center;
        background: none;
        border: none;
        color: var(--figma-color-text-secondary);
        cursor: pointer;
        display: flex;
        justify-content: center;
        padding: 4px 6px;
        transition: all 0.2s ease;
    }


    .active {
        background: var(--figma-color-bg);
        color: var(--figma-color-text);
        font-weight: 500;
    }

    .disabled {
        background: var(--figma-color-bg-disabled);
        color: var(--figma-color-text-disabled);
        cursor: not-allowed;
        opacity: 0.5;
    }

    .color-swatch {
        border: none;
        height: 100%;
        width: 100%
    }

    .color-swatch-container {
        background: var(--figma-color-bg-secondary);
        border-radius: 3px;
        border: 1px solid var(--figma-color-border);
        height: 20px;
        overflow: hidden;
        padding: 0;
        width: 20px;
    }

    .donate-button {
        /* Adjust donate button margin */
        align-items: center;
        background: var(--figma-color-bg-secondary);
        border-radius: 4px;
        border: none;
        color: var(--figma-color-text-tertiary);
        cursor: pointer;
        display: flex;
        font-size: 11px;
        font-weight: 500;
        gap: 6px;
        margin-right: 12px;
        padding: 4px 8px;
        transition: all 0.2s ease;
    }

    .empty-state {
        color: var(--figma-color-text-secondary);
        padding: 16px;
        text-align: center;
    }

    .empty-state-steps {
        display: inline-block;
        line-height: 24px;
        text-align: left;
    }

    .error-toast {
        align-items: center;
        background: var(--figma-color-bg-danger);
        border-radius: 6px;
        bottom: 16px;
        color: white;
        display: flex;
        gap: 8px;
        left: 50%;
        padding: 8px 12px;
        position: fixed;
        transform: translateX(-50%);
        z-index: 1000;
    }

    .expand-icon {
        align-items: center;
        color: var(--figma-color-text-secondary);
        display: inline-flex;
        height: 16px;
        justify-content: center;
        margin: -4px;
        transition: all 0.1s ease;
        width: 16px;
    }

    .group-info {
        align-items: center;
        display: flex;
        gap: 8px;
    }

    .info-badge {
        color: var(--figma-color-text-secondary);
        cursor: help;
        font-size: 11px;
    }

    .info-message {
        align-items: center;
        border-radius: 6px;
        display: flex;
        font-size: 11px;
        gap: var(--spacing-xs);
        margin: var(--spacing-xs);
        padding: var(--spacing-sm);
    }

    .instance-count {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
    }

    .library-details {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
    }

    .library-header {
        align-items: center;
        background: var(--figma-color-bg-secondary);
        border-radius: 6px 6px 0 0;
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        padding: var(--spacing-sm) var(--spacing-md);
        transition: background-color 0.2s ease;
    }

    .library-item {
        background: var(--figma-color-bg);
        border-radius: 4px;
        padding: 8px;
    }

    .library-name {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
        font-weight: 500;
    }

    .library-status {
        border-radius: 4px;
        font-size: 10px;
        padding: 2px 6px;
    }

    .enabled {
        background: var(--figma-color-bg-success);
        color: var(--figma-color-text-onbrand);
    }

    .progress-info {
        align-items: center;
        color: var(--figma-color-text-secondary);
        display: flex;
        font-size: 11px;
        justify-content: space-between;
    }



    .property-name {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
    }

    .reference-card {
        align-items: flex-start;
        background: var(--figma-color-bg-secondary);
        border-radius: 2px;
        display: flex;
        gap: 12px;
        justify-content: space-between;
        padding: 0;
    }

    .reference-header {
        cursor: pointer;
        padding: 4px 0;
        user-select: none;
    }

    .reference-info {
        display: flex;
        flex-direction: column;
        flex: 1;
        gap: 2px;
        padding: 12px;
    }

    .reference-location {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
    }

    .reference-name {
        color: var(--figma-color-text);
        font-size: 12px;
        font-weight: 500;
    }

    .rescan {
        background: var(--figma-color-bg-brand-tertiary);
        border: 1px solid var(--figma-color-border-brand-strong);
        color: var(--figma-color-text-brand);
    }

    .results-badge {
        align-items: center;
        background: var(--figma-color-bg-secondary);
        border-radius: 10px;
        color: var(--figma-color-text);
        display: inline-flex;
        font-size: 11px;
        font-weight: 500;
        height: 20px;
        justify-content: center;
        min-width: 20px;
        padding: 0 6px;
    }
    .results-header {
        align-items: center;
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .results-summary {
        background: var(--figma-color-bg);
        border-radius: 6px;
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        padding: 12px;
    }

    .scan-card {
        align-items: flex-start;
        background: var(--figma-color-bg-secondary);
        border-radius: 6px;
        border: 1px solid transparent;
        cursor: pointer;
        display: flex;
        gap: 12px;
        padding: 12px;
        transition: all 0.2s ease;
        user-select: none;
    }

    .scan-card-description {
        color: white;
    }

    .scan-details {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
    }

    .section-header {
        align-items: center;
        background: var(--figma-color-bg);
        display: flex;
        justify-content: space-between;
        padding: 12px;
    }

    .warning {
        background: var(--figma-color-bg-warning);
        border: 1px solid var(--figma-color-border-warning);
    }

    .section-subtitle {
        color: var(--figma-color-text);
        font-size: 12px;
        font-weight: 600;
        margin: 0 0 12px 0;
    }


    .select-input {
        appearance: none;
        background: var(--figma-color-bg);
        border-radius: 2px;
        border: 1px solid var(--figma-color-border);
        color: var(--figma-color-text);
        cursor: pointer;
        font-family: var(--font-stack);
        font-size: 11px;
        height: 32px;
        line-height: 16px;
        padding: 8px 8px 8px 12px;
    }

    .selection-count {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
    }

    .settings-content {
        /* Keep horizontal padding consistent */
        padding: 0 12px 12px;
    }



    .stat-label {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
    }

    .step-content {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
    }

    .sticky-footer {
        /* For resize handle positioning */
        align-items: center;
        background: var(--figma-color-bg);
        border-top: 1px solid var(--figma-color-border);
        bottom: 0;
        display: flex;
        height: 32px;
        justify-content: space-between;
        left: 0;
        padding: 4px 16px;
        position: fixed;
        right: 0;
        z-index: 100;
        position: relative;
    }

    .summary-header {
        align-items: center;
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .summary-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .summary-value {
        color: var(--figma-color-text);
        font-size: 16px;
        font-weight: 500;
    }

    .summary-label {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
    }

    .summary-stats {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(2, 1fr);
    }


    .text-button {
        background: none;
        color: var(--figma-color-text-secondary);
        padding: 4px 8px;
    }

    .timestamp {
        color: var(--figma-color-text-secondary);
        font-size: 11px;
    }



    .toggle-container {
        align-items: center;
        display: flex;
        padding: 2px 0;
        width: 100%;
    }

    .toggle-input {
        height: 0;
        opacity: 0;
        position: absolute;
        width: 0;
    }

    .toggle-slider {
        background-color: var(--figma-color-bg-disabled);
        border-radius: 16px;
        bottom: 0;
        cursor: pointer;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        transition: .2s;
    }

    .toggle-label-content {
        align-items: center;
        display: flex;
        flex: 1;
        gap: 8px;
    }

    .toggle-wrapper {
        flex-shrink: 0;
        height: 16px;
        position: relative;
        width: 28px;
    }

    .token-count {
        background: var(--figma-color-bg-tertiary);
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        padding: 2px 8px;
    }

    .token-details {
        color: var(--figma-color-text-secondary);
        display: flex;
        font-size: 11px;
        gap: 8px;
    }

    .token-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        gap: 4px;
    }

    .token-item {
        align-items: center;
        background: var(--figma-color-bg);
        border-bottom: 1px solid var(--figma-color-border);
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        margin-bottom: var(--spacing-xs);
        padding: 8px 12px;
        padding: var(--spacing-sm) var(--spacing-md);
        padding: var(--spacing-xs);
        transition: all 0.2s ease;
    }

    .token-list {
        background: var(--figma-color-bg);
        border-radius: 0 0 6px 6px;
        overflow: hidden;
        padding: 8px;
        padding: var(--spacing-sm);
        padding: var(--spacing-xs);
    }

    .token-type {
        background: var(--figma-color-bg-secondary);
        border-radius: 4px;
        padding: 2px 6px;
    }

    .typography-preview {
        color: var(--figma-color-text);
        font-family: system-ui;
        font-family: var(--font-stack);
        font-size: 11px;
        font-style: italic;
        line-height: 16px;
        opacity: 0.8;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .typography-specs {
        color: var(--figma-color-text-secondary);
        display: grid;
        flex-direction: column;
        font-size: 12px;
        gap: 4px;
        grid-template-columns: repeat(2, 1fr);
    }

    .typography-tag {
        align-items: center;
        background: var(--figma-color-bg-secondary);
        border-radius: 4px;
        color: var(--figma-color-text-secondary);
        display: flex;
        flex-shrink: 0;
        font-size: 11px;
        font-weight: 500;
        height: 20px;
        overflow: hidden;
        padding: 2px 6px;
        text-overflow: ellipsis;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .size {
        background: var(--figma-color-bg-secondary);
        justify-content: center;
        min-width: 35px;
    }

    .usage-header {
        align-items: center;
        color: var(--figma-color-text-secondary);
        cursor: pointer;
        display: flex;
        font-size: 11px;
        justify-content: space-between;
        padding: 4px 0;
    }

    .usage-item {
        align-items: center;
        background: var(--figma-color-bg-secondary);
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
        padding: 6px;
    }

    .value-group-details {
        /* Ensure details are scrollable if needed */
        max-height: 300px;
        background: var(--figma-color-bg);
        border-top: 1px solid var(--figma-color-border);
        overflow-y: auto;
        padding: 8px;
    }

    .value-group-header {
        align-items: center;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        min-height: 40px;
        padding: 8px 12px;
        transition: background-color 0.2s ease;
        user-select: none;
    }

    .version-info {
        align-items: center;
        color: var(--figma-color-text-secondary);
        display: flex;
        font-size: 11px;
        gap: 4px;
    }

    .info-icon {
        color: white;
        flex-shrink: 0;
        height: 12px;
        width: 12px;
    }

    .warning-message {
        background: var(--figma-color-bg-warning);
        background-color: var(--figma-color-bg-warning-secondary);
        border: 1px solid var(--figma-color-border-warning);
        color: white;
    }

    .watch-toggle-content {
        align-items: center;
        display: flex;
        gap: 6px;
    }

    .typography-labels {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .label {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
    }

    .label.font-family {
      background: var(--figma-color-bg-brand-tertiary);
      color: var(--figma-color-text-brand);
      font-weight: 500;
    }

    .label.font-weight {
      background: var(--figma-color-bg-tertiary);
    }

    .label.font-size {
      min-width: 24px;
      text-align: center;
      background: var(--figma-color-bg-tertiary);
    }
    /* Add new label variants for other types */
    .label.gap {
      background: var(--figma-color-bg-tertiary);
    }

    .label.vertical-gap {
      background: var(--figma-color-bg-tertiary);
    }

    .label.horizontal-padding {
      background: var(--figma-color-bg-tertiary);
    }

    .label.vertical-padding {
      background: var(--figma-color-bg-tertiary);
    }

    .label.value {
      min-width: 24px;
      text-align: center;
      background: var(--figma-color-bg-tertiary);
    }






    /* variable styles */

    .variable-details {
        border-top: 1px solid var(--figma-color-border);
        margin-top: 8px;
        padding-top: 8px;
    }

    .variable-header {
        align-items: center;
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .variable-item {
        background: var(--figma-color-bg-tertiary);
        border-radius: 4px;
        margin-bottom: 8px;
        padding: 8px 12px;
    }

    .variable-name {
        font-weight: 500;
        font-weight: 500;
    }

    .variable-type {
        background: var(--figma-color-bg-secondary);
        background: var(--figma-color-bg-secondary);
        border-radius: 4px;
        border-radius: 4px;
        font-size: 11px;
        font-size: 11px;
        padding: 2px 6px;
        padding: 2px 6px;
    }


    </style>


  <!-- Add color preview template outside of style tag -->
  <template id="color-preview">
    <div class="color-preview">
      <div class="color-swatch-container">
        <div 
          class="color-swatch" 
          :style="{
            backgroundColor: `rgba(${color.r * 255}, ${color.g * 255}, ${color.b * 255}, ${color.a || 1})`
          }"
        ></div>
      </div>
      <div class="color-info">
        <span class="color-hex">RGB({{ Math.round(color.r * 255) }}, {{ Math.round(color.g * 255) }}, {{ Math.round(color.b * 255) }})</span>
        <span v-if="color.a !== 1" class="color-opacity">{{ Math.round(color.a * 100) }}%</span>
      </div>
    </div>
  </template>


  <script>
    function initializeApp() {
      const { createApp } = Vue;
      
      // Add the SuccessToast component definition
      const SuccessToast = {
        template: '#success-toast',
        props: {
          message: String,
          show: Boolean
        },
        methods: {
          close() {
            this.$emit('close');
          }
        }
      };

      // Create new icon components that use the imported SVGs
      const Icon = {
        props: {
          name: {
            type: String,
            required: true
          }
        },
        template: `
          <div class="icon" v-html="getIcon"></div>
        `,
        computed: {
          getIcon() {
            const icon = this.$root.icons[this.name];
            console.log('Loading icon:', this.name, icon ? 'found' : 'not found');
            console.log('Icon content:', icon);
            return icon;
          }
        }
      };

      createApp({
        components: {
          Icon,
          SuccessToast,
          ColorPreview: {
            template: '#color-preview',
            props: {
              color: {
                type: Object,
                required: true
              }
            },
            methods: {
              formatColorToHex({ r, g, b }) {
                const toHex = (n) => {
                  const hex = Math.round(n * 255).toString(16);
                  return hex.length === 1 ? '0' + hex : hex;
                };
                return `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();
              }
            }
          }
        },
        data() {
          return {
            activeTab: 'tokens',
            selectedScanType: null, // Remove default 'vertical-gap' value
            scanEntirePage: false,
            isScanning: false,
            scanProgress: 0,
            scanError: false,
            scanComplete: false,
            groupedReferences: {},
            expandedGroups: new Set(),
            hasSelection: false,
            selectedCount: 0,
            hasInstances: false,
            isWatching: false,
            tokenScanOptions: [
              {
                value: 'typography',
                label: 'Typography',
                description: 'Find text layers missing text style variables',
                icon: 'typography'
              },
              {
                value: 'vertical-gap',
                label: 'Vertical Gap',
                description: 'Find frames with unlinked vertical gap',
                icon: 'spacing'
              },
              {
                value: 'horizontal-padding',
                label: 'Horizontal Padding',
                description: 'Find frames with unlinked horizontal padding',
                icon: 'horizontal-padding'
              },
              {
                value: 'vertical-padding',
                label: 'Vertical Padding',
                description: 'Find frames with unlinked vertical padding',
                icon: 'vertical-padding'
              },
              {
                value: 'corner-radius',
                label: 'Corner Radius',
                description: 'Find shapes with unlinked corner radius',
                icon: 'radius'
              },
              {
                value: 'fill',
                label: 'Fill Colors',
                description: 'Find layers with unlinked fill colors',
                icon: 'fill'
              },
              {
                value: 'stroke',
                label: 'Stroke Colors',
                description: 'Find layers with unlinked stroke colors',
                icon: 'stroke'
              }
            ],
            showSuccessToast: false,
            successMessage: '',
            selectingNodeIds: new Set(), // Track which groups are being selected
            libraryResults: {},  // Separate results for library scan
            variableAnalysis: null,
            isAnalyzing: false,
            showSettings: false,
            ignoreHiddenLayers: false,
            icons: {
              'typography': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="type">
                  <path d="M19.9567 8.71249V9.97212H14.9434V8.71249H19.9567ZM16.4045 6.39478H17.8909V15.6153C17.8909 16.0351 17.9518 16.35 18.0735 16.56C18.1995 16.7657 18.3591 16.9043 18.5522 16.9757C18.7495 17.0428 18.9574 17.0764 19.1757 17.0764C19.3395 17.0764 19.4738 17.068 19.5788 17.0512C19.6838 17.0302 19.7677 17.0134 19.8307 17.0009L20.133 18.3361C20.0323 18.3738 19.8916 18.4116 19.7111 18.4494C19.5305 18.4914 19.3017 18.5124 19.0246 18.5124C18.6047 18.5124 18.1932 18.4221 17.7901 18.2416C17.3912 18.061 17.0595 17.786 16.795 17.4165C16.5347 17.047 16.4045 16.581 16.4045 16.0183V6.39478Z M3.8667 6.87338V5.48779H13.5406V6.87338H9.48464V18.3864H7.9227V6.87338H3.8667Z" fill="currentColor"/>
                </g>
              </svg>`,
              
              'stroke': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="stroke">
                  <path d="M17.1266 17.1267L6.87317 6.87329" stroke="currentColor" stroke-linecap="round"/>
                  <rect x="3.84668" y="3.84668" width="16.3066" height="16.3066" rx="2.5" stroke="currentColor" stroke-linecap="round"/>
                </g>
              </svg>`,
              
              'spacing': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="Gap">
                  <path d="M20.7651 3.39014H19C17.3431 3.39014 16 4.73328 16 6.39014V17.6096C16 19.2665 17.3431 20.6096 19 20.6096H20.7651" stroke="currentColor" stroke-linecap="round"/>
                  <path d="M3.23486 3.39014H4.99998C6.65683 3.39014 7.99998 4.73328 7.99998 6.39014V17.6096C7.99998 19.2665 6.65683 20.6096 4.99998 20.6096H3.23486" stroke="currentColor" stroke-linecap="round"/>
                  <path d="M12 6.92114V17.2227" stroke="currentColor" stroke-linecap="round"/>
                </g>
              </svg>`,
              
              'radius': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="corner">
                  <path d="M3.34302 20.8875V10.1124C3.34302 6.24643 6.47703 3.11243 10.343 3.11243H22.4347" stroke="currentColor"/>
                </g>
              </svg>`,
              
              'vertical-padding': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="vertical">
                  <path d="M20.7102 3.80981H3.34668" stroke="currentColor" stroke-linecap="round"/>
                  <path d="M20.7102 20.3337H3.34668" stroke="currentColor" stroke-linecap="round"/>
                  <rect x="7.87646" y="7.87646" width="8.24707" height="8.24707" rx="2.5" stroke="currentColor" stroke-linecap="round"/>
                </g>
              </svg>`,
              
              'horizontal-padding': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="horizontal">
                  <path d="M3.76648 3.39014L3.76648 20.7537" stroke="currentColor" stroke-linecap="round"/>
                  <path d="M20.2904 3.39014L20.2904 20.7537" stroke="currentColor" stroke-linecap="round"/>
                  <rect x="7.87646" y="7.87646" width="8.24707" height="8.24707" rx="2.5" stroke="currentColor" stroke-linecap="round"/>
                </g>
              </svg>`,
              
              'fill': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="fill">
                  <rect x="3.78979" y="3.78979" width="16.4204" height="16.4204" rx="2.5" stroke="currentColor" stroke-linecap="round"/>
                  <rect x="5.51733" y="5.51733" width="12.9653" height="12.9653" rx="1" fill="currentColor"/>
                </g>
              </svg>`,
              'library': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="library">
                  <path d="M17.1266 17.1267L6.87317 6.87329" stroke="currentColor" stroke-linecap="round"/>
                  <rect x="3.84668" y="3.84668" width="16.3066" height="16.3066" rx="2.5" stroke="currentColor" stroke-linecap="round"/>
                </g>
              </svg>`,
              'variable': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="variable">
                  <path d="M17.1266 17.1267L6.87317 6.87329" stroke="currentColor" stroke-linecap="round"/>
                  <rect x="3.84668" y="3.84668" width="16.3066" height="16.3066" rx="2.5" stroke="currentColor" stroke-linecap="round"/>
                </g>
              </svg>`
            },
            windowSize: {
              width: 400,
              height: 600
            },
            isResizing: false,
            selectedFrameIds: [],
            inactiveLibraryTokens: [],
            activeLibraryTokens: [],
            selectedTokenScanType: 'all',
            libraryTokenScanOptions: [
              {
                value: 'all',
                label: 'All Library Tokens',
                description: 'Find all tokens from inactive libraries',
                icon: 'tokens'
              },
              {
                value: 'colors',
                label: 'Color Tokens',
                description: 'Find color tokens from inactive libraries',
                icon: 'fill'
              },
              {
                value: 'typography',
                label: 'Typography Tokens',
                description: 'Find typography tokens from inactive libraries',
                icon: 'typography'
              },
              {
                value: 'spacing',
                label: 'Spacing Tokens',
                description: 'Find spacing tokens from inactive libraries',
                icon: 'spacing'
              }
            ],
            selectedLibraryTokenScanType: 'all', // Default to 'all' instead of empty
            isLibraryScanning: false,
            libraryScanProgress: 0,
            hasLibraryResults: false,
            isPaused: false,
            currentScanNode: null,
            scanSummary: null,
            variableCollections: [
              {
                id: 1,
                name: 'Colors',
                isActive: true,
                variablesCount: 5,
                variables: [
                  {
                    id: 1,
                    name: 'Primary Color',
                    type: 'color',
                    currentMode: 'Light Mode',
                    usages: [
                      { nodeId: 'node1', property: 'background-color' },
                      { nodeId: 'node2', property: 'border-color' },
                      { nodeId: 'node3', property: 'text-color' }
                    ]
                  },
                  {
                    id: 2,
                    name: 'Secondary Color',
                    type: 'color',
                    currentMode: 'Dark Mode',
                    usages: [
                      { nodeId: 'node4', property: 'background-color' },
                      { nodeId: 'node5', property: 'border-color' },
                      { nodeId: 'node6', property: 'text-color' }
                    ]
                  },
                  {
                    id: 3,
                    name: 'Tertiary Color',
                    type: 'color',
                    currentMode: 'Light Mode',
                    usages: [
                      { nodeId: 'node7', property: 'background-color' },
                      { nodeId: 'node8', property: 'border-color' },
                      { nodeId: 'node9', property: 'text-color' }
                    ]
                  },
                  {
                    id: 4,
                    name: 'Quaternary Color',
                    type: 'color',
                    currentMode: 'Dark Mode',
                    usages: [
                      { nodeId: 'node10', property: 'background-color' },
                      { nodeId: 'node11', property: 'border-color' },
                      { nodeId: 'node12', property: 'text-color' }
                    ]
                  },
                  {
                    id: 5,
                    name: 'Neutral Color',
                    type: 'color',
                    currentMode: 'Light Mode',
                    usages: [
                      { nodeId: 'node13', property: 'background-color' },
                      { nodeId: 'node14', property: 'border-color' },
                      { nodeId: 'node15', property: 'text-color' }
                    ]
                  }
                ]
              },
              {
                id: 2,
                name: 'Typography',
                isActive: true,
                variablesCount: 3,
                variables: [
                  {
                    id: 6,
                    name: 'Body Font',
                    type: 'typography',
                    currentMode: 'Light Mode',
                    usages: [
                      { nodeId: 'node16', property: 'font-family' },
                      { nodeId: 'node17', property: 'font-size' },
                      { nodeId: 'node18', property: 'line-height' }
                    ]
                  },
                  {
                    id: 7,
                    name: 'Heading Font',
                    type: 'typography',
                    currentMode: 'Dark Mode',
                    usages: [
                      { nodeId: 'node19', property: 'font-family' },
                      { nodeId: 'node20', property: 'font-size' },
                      { nodeId: 'node21', property: 'line-height' }
                    ]
                  },
                  {
                    id: 8,
                    name: 'Button Font',
                    type: 'typography',
                    currentMode: 'Light Mode',
                    usages: [
                      { nodeId: 'node22', property: 'font-family' },
                      { nodeId: 'node23', property: 'font-size' },
                      { nodeId: 'node24', property: 'line-height' }
                    ]
                  }
                ]
              },
              {
                id: 3,
                name: 'Spacing',
                isActive: true,
                variablesCount: 2,
                variables: [
                  {
                    id: 9,
                    name: 'Padding',
                    type: 'spacing',
                    currentMode: 'Light Mode',
                    usages: [
                      { nodeId: 'node25', property: 'padding' },
                      { nodeId: 'node26', property: 'padding' }
                    ]
                  },
                  {
                    id: 10,
                    name: 'Margin',
                    type: 'spacing',
                    currentMode: 'Dark Mode',
                    usages: [
                      { nodeId: 'node27', property: 'margin' },
                      { nodeId: 'node28', property: 'margin' }
                    ]
                  }
                ]
              }
            ],
            lastScannedType: null, // Add this to track the last scan type
          }
        },
        computed: {
          scanScope() {
            return this.scanEntirePage ? 'entire-page' : 'selected-frames';
          },
          canStartScan() {
            return (this.hasSelection || this.scanEntirePage) && this.selectedScanType !== null;
          },
          hasResults() {
            const hasRefs = Object.keys(this.groupedReferences).length > 0;
            console.log('Has results?', {
              groupedReferences: this.groupedReferences,
              count: Object.keys(this.groupedReferences).length,
              hasRefs
            });
            return hasRefs;
          },
          groupedByValue() {
            const valueGroups = {};
            
            Object.entries(this.groupedReferences).forEach(([key, refs]) => {
              try {
                // Split the key safely
                const [property, ...valueParts] = key.split(':');
                const valueStr = valueParts.join(':'); // Rejoin in case value contains colons
                
                // Parse the value safely
                let value;
                try {
                  value = JSON.parse(valueStr);
                } catch {
                  value = valueStr; // Use raw string if parsing fails
                }
                
                const groupKey = typeof value === 'object' ? JSON.stringify(value) : String(value);
                
                if (!valueGroups[groupKey]) {
                  valueGroups[groupKey] = {
                    value,
                    properties: new Set(),
                    refs: []
                  };
                }
                
                valueGroups[groupKey].properties.add(property);
                valueGroups[groupKey].refs.push(...refs);
              } catch (err) {
                console.warn('Error processing group:', key, err);
              }
            });
            
            return valueGroups;
          },
          watchButtonTitle() {
            if (!this.scanEntirePage) {
              return 'Enable "Scan Entire Page" to use watch mode';
            }
            return this.isWatching ? 'Stop watching for changes' : 'Watch for changes';
          },
          canWatch() {
            return this.scanEntirePage;
          },
          activeLibraryTokens() {
            return this.activeLibraryTokens;
          },
          inactiveLibraryTokens() {
            return this.inactiveLibraryTokens;
          },
          showScanResults() {
            const shouldShow = !this.isScanning && this.hasResults && this.scanComplete;
            console.log('Show scan results?', {
              isScanning: this.isScanning,
              hasResults: this.hasResults,
              scanComplete: this.scanComplete,
              shouldShow
            });
            return shouldShow;
          },
          showStopButton() {
            return this.isScanning && !this.scanComplete;
          },
          showRescanButton() {
            // Only show rescan if we have results AND the scan type hasn't changed
            return this.hasResults && this.selectedScanType === this.lastScannedType;
          }
        },
        methods: {
          handleScanScopeChange() {
            if (this.scanEntirePage) {
              this.successMessage = 'Scanning the entire page may take longer';
              this.showSuccessToast = true;
              setTimeout(() => {
                if (this.successMessage === 'Scanning the entire page may take longer') {
                  this.showSuccessToast = false;
                }
              }, 3000);
            } else {
              this.stopWatching();
            }
            // Store the user's preference
            this.userPrefersScanEntirePage = this.scanEntirePage;
          },
          stopWatching() {
            this.isWatching = false;
            parent.postMessage({ 
              pluginMessage: { 
                type: 'stop-watching'
              }
            }, '*');
          },
          startScan(isRescan = false) {
            if (this.isScanning) return;
            
            // Reset states
            this.isScanning = true;
            this.scanProgress = 0;
            this.scanError = false;
            this.scanComplete = false;
            
            if (!isRescan) {
              this.clearResults();
            }
            
            // Get current selection
            const selectedFrameIds = !this.scanEntirePage ? [...this.selectedFrameIds] : [];
            
            console.log('Starting scan:', {
              scanType: this.selectedScanType,
              scanEntirePage: this.scanEntirePage,
              selectedFrameIds,
              hasSelection: this.hasSelection
            });
            
            parent.postMessage({
              pluginMessage: {
                type: 'scan-for-tokens',
                scanType: this.selectedScanType,
                scanEntirePage: this.scanEntirePage,
                selectedFrameIds
              }
            }, '*');
            // Update lastScannedType
            this.lastScannedType = this.selectedScanType;
          },
          stopScan() {
            // Log stop request
            console.log('Stopping scan...');
            
            this.isScanning = false;
            this.scanComplete = true;
            
            parent.postMessage({
              pluginMessage: {
                type: 'stop-scan'
              } 
            }, '*');
          },
          handleScanComplete(msg) {
            // Log scan completion
            console.log('Scan complete:', msg);
            
            // Update states
            this.isScanning = false;
            this.scanComplete = true;
          },
          handleScanError(error) {
            this.isScanning = false;
            this.scanComplete = true;
            this.scanError = true;
            
            console.error('Scan error:', error);
            this.showError('Scan failed. Please try again.');
          },
          
          showError(message) {
            // Add error toast or notification
            console.error(message);
            // You can implement a toast notification here
          },

          switchTab(tab) {
            // Clean up previous tab state
            this.isScanning = false;
            this.scanProgress = 0;
            this.scanError = false;
            this.scanComplete = false;
            this.groupedReferences = {};
            
            this.activeTab = tab;
          },

          getProgressStatus() {
            if (this.scanError) {
              return 'Scan error';
            }
            if (!this.isScanning && this.scanProgress === 100) {
              return this.hasResults ? 'Scan complete' : 'Scan complete, no issues found';
            }
            if (this.isScanning) {
              return `Scanning... ${Math.round(this.scanProgress)}%`;
            }
            return 'Ready to scan';
          },
          
          getProgressBarColor() {
            if (this.scanError) {
              return 'var(--figma-color-bg-danger)';
            }
            if (!this.isScanning && this.scanProgress === 100) {
              return 'var(--figma-color-bg-success)';
            }
            if (this.isScanning) {
              return 'var(--figma-color-bg-brand)';
            }
            return 'var(--figma-color-bg-disabled)';
          },
          handlePluginMessage(msg) {
            if (!msg) return;
            
            console.log('Received message:', msg.type, msg);
            
            switch (msg.type) {
              case 'missing-references-result':
                this.isScanning = false;
                this.scanComplete = true;
                this.scanProgress = 100;
                if (msg.references) {
                  this.groupedReferences = msg.references;
                  console.log('Scan complete with results:', {
                    references: msg.references,
                    groupCount: Object.keys(msg.references).length
                  });
                }
                break;
                
              case 'scan-progress':
                this.scanProgress = msg.progress;
                this.isScanning = msg.isScanning ?? true;
                break;
                
              case 'selection-updated':
                this.updateSelection(msg);
                break;
                
              case 'init-icons':
                this.icons = msg.icons;
                break;
                
              // Remove duplicate handlers
              default:
                console.log('Unhandled message type:', msg.type);
            }
          },
          async getSelectedFrameIds() {
            return new Promise((resolve) => {
              parent.postMessage({ 
                pluginMessage: { type: 'get-selected-frame-ids' }
              }, '*');

              const handler = (event) => {
                const msg = event.data.pluginMessage;
                if (msg.type === 'selected-frame-ids') {
                  window.removeEventListener('message', handler);
                  resolve(msg.ids);
                }
              };
              window.addEventListener('message', handler);
            });
          },
          async selectGroup(refs, groupId) {
            this.selectingNodeIds.add(groupId);
            const nodeIds = refs.map(ref => ref.nodeId);
            parent.postMessage({ 
              pluginMessage: { 
                type: 'select-group',
                nodeIds
              }
            }, '*');
            
            setTimeout(() => {
              this.selectingNodeIds.delete(groupId);
            }, 500);
          },
          formatValue(value) {
            if (typeof value === 'object') {
              return JSON.stringify(value);
            }
            return String(value);
          },
          formatGapValue(value, ref) {
            if (ref.type === 'gap') {
              const direction = ref.isVertical ? 'Vertical' : 'Horizontal';
              return `${direction} Gap: ${value}px`;
            }
            return formatValue(value);
          },
          toggleGroup(groupKey) {
            if (this.expandedGroups.has(groupKey)) {
              this.expandedGroups.delete(groupKey);
            } else {
              this.expandedGroups.add(groupKey);
            }
          },
          isGroupExpanded(groupKey) {
            return this.expandedGroups.has(groupKey);
          },
          getPropertyName(key) {
            return key.split(':')[0];
          },
          toggleWatch() {
            if (!this.canWatch) return;
            
            this.isWatching = !this.isWatching;
            parent.postMessage({ 
              pluginMessage: { 
                type: this.isWatching ? 'start-watching' : 'stop-watching',
                scanType: this.selectedScanType,
                scanScope: this.scanScope,
                scanEntirePage: this.scanEntirePage
              }
            }, '*');
          },
          clearResults() {
            this.groupedReferences = {};
            this.expandedGroups.clear();
          },
          dismissToast() {
            this.showSuccessToast = false;
          },
          handleResize(msg) {
            if (msg.type === 'resize' && msg.width && msg.height) {
              const width = Number(msg.width);
              const height = Number(msg.height);
              
              if (!isNaN(width) && !isNaN(height)) {
                this.windowSize = { width, height };
              }
            }
          },
          updateProgress(newProgress) {
            const progress = Math.min(Math.max(0, Number(newProgress) || 0), 100);
            console.log(`Updating progress bar: ${progress}%`);
            this.scanProgress = progress;
          },
          isSelecting(id) {
            return this.selectingNodeIds.has(id);
          },
          async startLibraryScan() {
            this.isLibraryScanning = true;
            this.libraryScanProgress = 0;
            this.currentScanNode = null;
            this.scanSummary = null;
            this.isPaused = false;
            
            const selectedFrameIds = !this.scanEntirePage  // Use the same scanEntirePage state
              ? await this.getSelectedFrameIds()
              : undefined;
            
            parent.postMessage({ 
              pluginMessage: { 
                type: 'scan-for-tokens',
                scanType: 'inactive-tokens',
                scanScope: this.scanEntirePage ? 'entire-page' : 'selected-frames',
                selectedFrameIds
              }
            }, '*');
          },
          clearLibraryResults() {
            this.libraryResults = {};
          },
          async listVariables() {
            this.isAnalyzing = true;
            this.variableAnalysis = null;  // Reset previous results
            parent.postMessage({ 
              pluginMessage: { 
                type: 'list-variables'
              }
            }, '*');
          },
          openStripePayment() {
            window.open('https://buy.stripe.com/8wM7wb49NeFD5UYcMM', '_blank');
          },
          startResize(e) {
            this.isResizing = true;
            
            const startX = e.clientX;
            const startY = e.clientY;
            const startWidth = this.windowSize.width;
            const startHeight = this.windowSize.height;
            
            const onMouseMove = (e) => {
              if (!this.isResizing) return;
              
              const newWidth = startWidth + (e.clientX - startX);
              const newHeight = startHeight + (e.clientY - startY);
              
              // Set minimum sizes
              const width = Math.max(300, newWidth);
              const height = Math.max(400, newHeight);
              
              this.windowSize = { width, height };
              
              // Send resize message to plugin
              parent.postMessage({ 
                pluginMessage: { 
                  type: 'resize', 
                  width,
                  height
                }
              }, '*');
            };
            
            const onMouseUp = () => {
              this.isResizing = false;
              document.removeEventListener('mousemove', onMouseMove);
              document.removeEventListener('mouseup', onMouseUp);
            };
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
          },
          updateSelection(msg) {
            this.hasSelection = msg.hasSelection;
            this.selectedCount = msg.count;
            if (msg.selectedFrameIds) {
              this.selectedFrameIds = msg.selectedFrameIds;
            }
          },
          getStyleData(key) {
            try {
              // Extract the JSON data from the textStyleId string
              const styleMatch = key.match(/textStyleId:({.*?})/);
              if (!styleMatch) return this.getDefaultStyle();
              
              const styleData = JSON.parse(styleMatch[1]);
              
              // Clean up the font family name
              styleData.fontFamily = styleData.fontFamily.split(' ')[0];
              
              return styleData;
            } catch (err) {
              console.warn('Error parsing style data:', err);
              return this.getDefaultStyle();
            }
          },
          getDefaultStyle() {
            return {
              fontFamily: 'Unknown',
              fontWeight: 'Regular',
              fontSize: 14
            };
          },
          async scanLibraryTokens() {
            this.isLibraryScanning = true;
            this.libraryScanProgress = 0;
            this.currentScanNode = null;
            this.scanSummary = null;
            this.isPaused = false;
            this.inactiveLibraryTokens = [];
            this.activeLibraryTokens = [];
            parent.postMessage({ 
              pluginMessage: { 
                type: 'scan-library-tokens',
                scanType: this.selectedLibraryTokenScanType
              }
            }, '*');
          },
          async activateLibrary(libraryName) {
            parent.postMessage({ 
              pluginMessage: { 
                type: 'activate-library',
                libraryName 
              }
            }, '*');
          },
          stopLibraryScan() {
            console.log('Requesting scan stop...');
            parent.postMessage({ 
              pluginMessage: { type: 'stop-library-scan' }
            }, '*');
          },
          formatTokenType(type) {
            switch (type.toLowerCase()) {
              case 'color':
                return 'Color';
              case 'float':
                return 'Number';
              case 'string':
                return 'Text';
              default:
                return type;
            }
          },
          pauseLibraryScan() {
            console.log('Requesting scan pause...');
            this.isPaused = true;
            parent.postMessage({ 
              pluginMessage: { type: 'pause-library-scan' }
            }, '*');
          },
          resumeLibraryScan() {
            console.log('Requesting scan resume...');
            this.isPaused = false;
            parent.postMessage({ 
              pluginMessage: { type: 'resume-library-scan' }
            }, '*');
          },
          getUniqueLibraries(tokens) {
            return [...new Set(tokens.map(token => token.libraryName))];
          },
          getTokensByLibrary(tokens, libraryName) {
            return tokens.filter(token => token.libraryName === libraryName);
          },
          showTokenUsages(token) {
            const nodeIds = token.usages.map(usage => usage.nodeId);
            parent.postMessage({ 
              pluginMessage: { 
                type: 'select-nodes',
                nodeIds
              }
            }, '*');
          },
          toggleUsageDetails(variableId) {
            this.isUsageExpanded = { ...this.isUsageExpanded, [variableId]: !this.isUsageExpanded[variableId] };
          },
          isUsageExpanded(variableId) {
            return this.isUsageExpanded[variableId] || false;
          },
          selectNode(nodeId) {
            parent.postMessage({ 
              pluginMessage: { 
                type: 'select-node',
                nodeId
              }
            }, '*');
          },
          switchTab(tab) {
            this.activeTab = tab;
          },
          getProgressBarColor() {
            if (this.scanError) {
              return 'var(--figma-color-bg-danger)';
            }
            if (!this.isScanning && this.scanProgress === 100) {
              return 'var(--figma-color-bg-success)';
            }
            if (this.isScanning) {
              return 'var(--figma-color-bg-brand)';
            }
            return 'var(--figma-color-bg-disabled)';
          },

          getProgressStatus() {
            if (this.scanError) {
              return 'Scan error';
            }
            if (!this.isScanning && this.scanProgress === 100) {
              return this.hasResults ? 'Scan complete' : 'Scan complete, no issues found';
            }
            if (this.isScanning) {
              return `Scanning... ${Math.round(this.scanProgress)}%`;
            }
            return 'Ready to scan';
          },

          // Add new method to handle progress width
          getProgressWidth() {
            // Always return a percentage, even if 0
            return `${Math.max(0, Math.min(100, this.scanProgress))}%`;
          },
          getStartScanButtonTitle() {
            if (!this.hasSelection && !this.scanEntirePage) {
              return 'Select frames/components/sections or enable "Scan Entire Page"';
            }
            if (!this.selectedScanType) {
              return 'Select what to scan for';
            }
            return 'Start scanning';
          },
          handleScanCardKeydown(e) {
            if (e.key === 'ArrowRight') {
              this.selectNextCard();
            } else if (e.key === 'ArrowLeft') {
              this.selectPreviousCard();
            } else if (e.key === 'Enter') {
              this.selectCurrentCard();
            }
          },
          selectNextCard() {
            const currentIndex = this.tokenScanOptions.findIndex(option => option.value === this.selectedScanType);
            const nextIndex = (currentIndex + 1) % this.tokenScanOptions.length;
            this.selectedScanType = this.tokenScanOptions[nextIndex].value;
          },
          selectPreviousCard() {
            const currentIndex = this.tokenScanOptions.findIndex(option => option.value === this.selectedScanType);
            const prevIndex = (currentIndex - 1 + this.tokenScanOptions.length) % this.tokenScanOptions.length;
            this.selectedScanType = this.tokenScanOptions[prevIndex].value;
          },
          selectCurrentCard() {
            this.selectedScanType = this.selectedScanType;
          },
          handleLibraryScanCardKeydown(e) {
            if (e.key === 'ArrowRight') {
              this.selectNextLibraryCard();
            } else if (e.key === 'ArrowLeft') {
              this.selectPreviousLibraryCard();
            } else if (e.key === 'Enter') {
              this.selectCurrentLibraryCard();
            }
          },
          selectNextLibraryCard() {
            const currentIndex = this.libraryTokenScanOptions.findIndex(option => option.value === this.selectedLibraryTokenScanType);
            const nextIndex = (currentIndex + 1) % this.libraryTokenScanOptions.length;
            this.selectedLibraryTokenScanType = this.libraryTokenScanOptions[nextIndex].value;
          },
          selectPreviousLibraryCard() {
            const currentIndex = this.libraryTokenScanOptions.findIndex(option => option.value === this.selectedLibraryTokenScanType);
            const prevIndex = (currentIndex - 1 + this.libraryTokenScanOptions.length) % this.libraryTokenScanOptions.length;
            this.selectedLibraryTokenScanType = this.libraryTokenScanOptions[prevIndex].value;
          },
          selectCurrentLibraryCard() {
            this.selectedLibraryTokenScanType = this.selectedLibraryTokenScanType;
          },
          handleScanProgress(msg) {
            if (msg && typeof msg.progress === 'number') {
              this.scanProgress = Math.min(100, Math.max(0, msg.progress));
              this.isScanning = msg.isScanning !== false;
            }
          },
          selectScanType(value) {
            // Toggle selection if clicking the same card
            if (this.selectedScanType === value) {
              this.selectedScanType = null;
            } else {
              this.selectedScanType = value;
            }
            // Reset lastScannedType if selecting a different type
            if (this.lastScannedType !== value) {
              this.lastScannedType = null;
            }
          },
          getTotalResultsCount() {
            return Object.values(this.groupedByValue).reduce((sum, group) => sum + group.refs.length, 0);
          },
          formatTypographyValue(value) {
            if (typeof value === 'object') {
              return `${value.fontFamily} ${value.fontWeight} ${value.fontSize}px`;
            }
            return String(value);
          },
          debugResults() {
            console.log('Current state:', {
              isScanning: this.isScanning,
              hasResults: this.hasResults,
              groupedReferences: this.groupedReferences,
              groupedByValue: this.groupedByValue
            });
          },
          selectLibraryScanType(value) {
            // Toggle selection if clicking the same card
            if (this.selectedLibraryTokenScanType === value) {
              this.selectedLibraryTokenScanType = null;
            } else {
              this.selectedLibraryTokenScanType = value;
            }
          },
        },
        watch: {
          activeLibraryTokens(newVal) {
            this.hasLibraryResults = newVal.length > 0 || this.inactiveLibraryTokens.length > 0;
          },
          inactiveLibraryTokens(newVal) {
            this.hasLibraryResults = newVal.length > 0 || this.activeLibraryTokens.length > 0;
          }
        },
        mounted() {
          console.log('Vue app mounted');
          
          // Remove any default selection
          this.selectedScanType = null;

          // Single message handler
          window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (msg) {
              this.handlePluginMessage(msg);
            }
          };

          // Request initial selection state
          parent.postMessage({ 
            pluginMessage: { 
              type: 'get-selected-frame-ids' 
            }
          }, '*');
        },
        created() {
          // Ensure we stay on the tokens tab
          this.activeTab = 'tokens';
        }
      }).mount('#app');

      // Hide loading indicator
      document.getElementById('loading').style.display = 'none';
    }

    // Resize handling
    let isResizing = false;
    let initialWidth, initialHeight, initialX, initialY;

    const MIN_WIDTH = 320;
    const MIN_HEIGHT = 400;
    const MAX_WIDTH = 800;
    const MAX_HEIGHT = 900;

    function initResizeHandle() {
      const resizeHandle = document.querySelector('.resize-handle');
      if (!resizeHandle) return;
      
      resizeHandle.addEventListener('mousedown', startResize);
    }

    function startResize(e) {
      isResizing = true;
      initialWidth = window.innerWidth;
      initialHeight = window.innerHeight;
      initialX = e.clientX;
      initialY = e.clientY;

      document.addEventListener('mousemove', handleResize);
      document.addEventListener('mouseup', stopResize);
      e.preventDefault(); // Prevent text selection while resizing
    }

    function handleResize(e) {
      if (!isResizing) return;

      const deltaX = e.clientX - initialX;
      const deltaY = e.clientY - initialY;

      const newWidth = Math.min(Math.max(initialWidth + deltaX, MIN_WIDTH), MAX_WIDTH);
      const newHeight = Math.min(Math.max(initialHeight + deltaY, MIN_HEIGHT), MAX_HEIGHT);

      // Send resize message to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'resize',
          width: newWidth,
          height: newHeight
        }
      }, '*');
    }

    function stopResize() {
      isResizing = false;
      document.removeEventListener('mousemove', handleResize);
      document.removeEventListener('mouseup', stopResize);
    }

    // Single window.onload handler
    window.onload = () => {
      initializeApp();
      initResizeHandle();
    };
  </script>
</body>
</html>
