<!DOCTYPE html>
<html>
<head>
  <!-- Replace the mock Vue implementation with the actual Vue.js library -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
  <!-- Loading indicator -->
  <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100vh;">
    Loading...
  </div>

  <!-- Main app -->
  <div id="app">
    <div v-cloak class="plugin-container">
      <div class="first-section">
        <div class="step-container">
          <div class="step-content">
            <div class="step-header">
              <h3 class="step-title">Select frames or components</h3>
              <button 
                class="watch-toggle" 
                :class="{ 
                  active: isWatching,
                  disabled: !scanEntirePage 
                }"
                @click="toggleWatch"
                :disabled="!scanEntirePage"
                :title="watchButtonTitle"
              >
                <div class="watch-toggle-content">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path v-if="isWatching && scanEntirePage" d="M8 3.33333C11.3333 3.33333 14.1667 5.33333 15.3333 8C14.1667 10.6667 11.3333 12.6667 8 12.6667C4.66667 12.6667 1.83333 10.6667 0.666667 8C1.83333 5.33333 4.66667 3.33333 8 3.33333Z" fill="currentColor"/>
                    <g v-else>
                      <path d="M2.66667 2L13.3333 14" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M8 3.33333C11.3333 3.33333 14.1667 5.33333 15.3333 8C14.1667 10.6667 11.3333 12.6667 8 12.6667C4.66667 12.6667 1.83333 10.6667 0.666667 8C1.83333 5.33333 4.66667 3.33333 8 3.33333Z" fill="currentColor" fill-opacity="0.5"/>
                    </g>
                  </svg>
                  <span class="watch-toggle-text">{{ isWatching && scanEntirePage ? 'Watching' : 'Watch changes' }}</span>
                </div>
              </button>
            </div>

            <!-- After the scan-scope-selector div -->
            <div class="scan-settings">
              <div class="settings-header">
                <h4 class="settings-title">Scan Settings</h4>
                <button 
                  class="settings-toggle"
                  @click="showSettings = !showSettings"
                >
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path 
                      :d="showSettings 
                        ? 'M4 10L8 6L12 10' 
                        : 'M4 6L8 10L12 6'" 
                      stroke="currentColor" 
                      stroke-width="1.5" 
                      stroke-linecap="round" 
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
              </div>
              
              <div class="settings-content" v-show="showSettings">
                <!-- Move Scan Entire Page here -->
                <div class="setting-item">
                  <label class="toggle-label">
                    <div class="toggle-label-content">
                      <span>Scan Entire Page</span>
                      <span v-if="scanEntirePage" class="slow-badge">slow</span>
                      <span class="info-badge" title="Scan the entire page instead of selected frames">‚ìò</span>
                    </div>
                    <div class="toggle-wrapper">
                      <input 
                        type="checkbox" 
                        v-model="scanEntirePage"
                        class="toggle-input"
                        @change="handleScanScopeChange"
                      >
                      <div class="toggle-slider"></div>
                    </div>
                  </label>
                </div>

                <!-- Existing Ignore Hidden Layers setting -->
                <div class="setting-item">
                  <label class="toggle-label">
                    <div class="toggle-label-content">
                      <span>Ignore Hidden Layers</span>
                      <span class="info-badge" title="Hidden layers will be excluded from the scan">‚ìò</span>
                    </div>
                    <div class="toggle-wrapper">
                      <input 
                        type="checkbox" 
                        v-model="ignoreHiddenLayers"
                        class="toggle-input"
                      >
                      <div class="toggle-slider"></div>
                    </div>
                  </label>
                </div>
              </div>
            </div>

            <div class="selection-container">
              <div v-if="!hasSelection && !scanEntirePage" class="toast warning">
                <div class="toast-icon">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33337L14.6667 13.3334H1.33334L8 1.33337ZM8 4.00004L3.73334 12H12.2667L8 4.00004ZM7.33334 6.66671H8.66668V9.33337H7.33334V6.66671ZM7.33334 10.6667H8.66668V12H7.33334V10.6667Z" fill="currentColor"/>
                  </svg>
                </div>
                <span class="toast-message">Select frames or sections to start scanning</span>
              </div>
              <div v-else-if="hasSelection && !scanEntirePage" class="toast success">
                <div class="toast-icon">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33334C4.31811 1.33334 1.33334 4.31811 1.33334 8C1.33334 11.6819 4.31811 14.6667 8 14.6667C11.6819 14.6667 14.6667 11.6819 14.6667 8C14.6667 4.31811 11.6819 1.33334 8 1.33334ZM11.0607 6.27274L7.39401 9.93941L5.27274 7.81814L6.06069 7.03019L7.39401 8.36351L10.2727 5.48479L11.0607 6.27274Z" fill="currentColor"/>
                  </svg>
                </div>
                <span class="toast-message">{{ selectedCount }} {{ selectedCount === 1 ? 'item' : 'items' }} selected</span>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container">
              <div class="progress-bar">
                <div 
                  class="progress-fill" 
                  :style="{ 
                    width: isScanning ? `${scanProgress}%` : scanProgress === 100 ? '100%' : '0%',
                    opacity: isScanning ? 1 : scanProgress === 100 ? 1 : 0.3,
                    background: scanProgress === 100 && !isScanning ? 'var(--figma-color-bg-success)' : 'var(--figma-color-bg-brand)'
                  }"
                ></div>
                <div class="progress-text">
                  {{ scanProgress === 100 && !isScanning && Object.keys(groupedReferences).length === 0 ? 'Scan complete - No issues found' :
                     scanProgress === 100 && !isScanning ? 'Scan complete' :
                     isScanning ? `${Math.round(scanProgress)}%` : '0%' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="content">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
          <button 
            class="tab-button" 
            :class="{ active: activeTab === 'tokens' }"
            @click="activeTab = 'tokens'"
          >
            Unlinked Values
          </button>
          <button 
            class="tab-button tab-button-disabled"
            disabled
            @click.prevent
            style="pointer-events: none;"
          >
            <div class="tab-button-content">
              <span>Unlinked Tokens</span>
              <svg class="lock-icon" width="12" height="12" viewBox="0 0 12 12" fill="none">
                <path d="M3.5 4V3.5C3.5 2.11929 4.61929 1 6 1C7.38071 1 8.5 2.11929 8.5 3.5V4" stroke="currentColor"/>
                <rect x="2.5" y="4" width="7" height="6" rx="1" stroke="currentColor"/>
              </svg>
            </div>
          </button>
        </div>

        <!-- Design Tokens Tab -->
        <div v-if="activeTab === 'tokens'" class="tab-content">
          <!-- Scan Type Selection -->
          <div class="step-container">
            <div class="step-content">
              <h3 class="step-title">Choose what to scan for</h3>
              <div class="scan-cards">
                <div 
                  v-for="option in tokenScanOptions" 
                  :key="option.value"
                  class="scan-card"
                  :class="{ 'selected': selectedScanType === option.value }"
                  @click="selectedScanType = option.value"
                >
                  <div class="scan-card-icon">
                    <component :is="option.icon"></component>
                  </div>
                  <div class="scan-card-content">
                    <div class="scan-card-title">{{ option.label }}</div>
                    <div class="scan-card-description">{{ option.description }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Scan Controls -->
          <div class="divider"></div>

          <div class="step-container">
            <div class="step-content">
              <h3 class="step-title">Start scanning</h3>
              <div class="scan-controls">
                <button 
                  @click="(e) => startScan(false, e)" 
                  :disabled="isScanning || (!hasSelection && !scanEntirePage)" 
                  class="button primary-button"
                >
                  Start Scan
                </button>
                <button 
                  @click="(e) => startScan(true, e)"
                  :disabled="!hasResults"
                  :class="{ 
                    'button': true,
                    'secondary-button': true,
                    'button-disabled': !hasResults 
                  }"
                  class="button secondary-button"
                >
                  Rescan
                </button>
                <button 
                  v-if="isScanning" 
                  @click="stopScan" 
                  class="button secondary-button"
                >
                  Stop
                </button>
              </div>
            </div>
          </div>

          <!-- Add a new section for scan results with consistent styling -->
          <template v-if="!isScanning && Object.keys(groupedReferences).length > 0">
            <div class="divider"></div>
            
            <div class="step-container">
              <div class="step-content">
                <div class="results-header">
                  <h3 class="step-title">Scan results</h3>
                  <div class="results-actions">
                    <button 
                      class="button secondary-button"
                      @click="clearResults"
                    >
                      Clear
                    </button>
                  </div>
                </div>
                <div class="results-container">
                  <div v-for="(group, groupKey) in groupedByValue" :key="groupKey" class="value-group">
                    <!-- Value Group Header -->
                    <div class="value-group-header" @click="toggleGroup(groupKey)">
                      <div class="header-left">
                        <span class="expand-icon">{{ isGroupExpanded(groupKey) ? '‚ñº' : '‚ñ∂' }}</span>
                        <template v-if="group.refs[0]?.type === 'typography'">
                          <span class="value-label">
                            {{ group.refs[0].currentValue.fontFamily }} 
                            {{ group.refs[0].currentValue.fontWeight }} 
                            {{ group.refs[0].currentValue.fontSize }}px
                          </span>
                        </template>
                        <template v-else>
                          <span class="value-label">Value: {{ formatValue(group.value) }}</span>
                        </template>
                      </div>
                      <div class="header-right">
                        <span class="total-count">{{ group.refs.length }} instances</span>
                        <button 
                          class="select-button" 
                          :class="{ 'loading': isSelecting(groupKey) }"
                          @click.stop="selectGroup(group.refs, groupKey)"
                          :disabled="isSelecting(groupKey)"
                        >
                          <span v-if="!isSelecting(groupKey)">Select All</span>
                          <span v-else class="loading-spinner"></span>
                        </button>
                      </div>
                    </div>

                    <!-- Expanded Content -->
                    <div v-if="isGroupExpanded(groupKey)" class="reference-details">
                      <div v-for="ref in group.refs" :key="ref.nodeId" class="reference-item">
                        <!-- Special handling for typography items -->
                        <template v-if="ref.type === 'typography'">
                          <div class="typography-details">
                            <div class="typography-preview">{{ ref.currentValue.content }}...</div>
                            <div class="typography-specs">
                              <div>Font: {{ ref.currentValue.fontFamily }}</div>
                              <div>Weight: {{ ref.currentValue.fontWeight }}</div>
                              <div>Size: {{ ref.currentValue.fontSize }}px</div>
                              <div v-if="ref.currentValue.lineHeight">Line Height: {{ ref.currentValue.lineHeight }}</div>
                              <div v-if="ref.currentValue.letterSpacing">Letter Spacing: {{ ref.currentValue.letterSpacing }}</div>
                              <div v-if="ref.currentValue.paragraphSpacing">Paragraph Spacing: {{ ref.currentValue.paragraphSpacing }}</div>
                              <div v-if="ref.currentValue.textCase">Text Case: {{ ref.currentValue.textCase }}</div>
                              <div v-if="ref.currentValue.textDecoration">Text Decoration: {{ ref.currentValue.textDecoration }}</div>
                            </div>
                          </div>
                        </template>
                        <template v-else>
                          <div class="reference-name">{{ ref.nodeName }}</div>
                          <div class="reference-location">{{ ref.location }}</div>
                        </template>
                        <button 
                          class="select-button"
                          :class="{ 'loading': isSelecting(ref.nodeId) }"
                          @click="selectGroup([ref], ref.nodeId)"
                          :disabled="isSelecting(ref.nodeId)"
                        >
                          <span v-if="!isSelecting(ref.nodeId)">Select</span>
                          <span v-else class="loading-spinner"></span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </template>

          <!-- Version Info and Donate Button -->
          <div class="divider"></div>
          <div class="bottom-section">
            <div class="bottom-info">
              <div class="version-info">
                <span class="version-text">Version 1.0.0</span>
              </div>
              <button 
                class="donate-button"
                @click="openStripePayment"
              >
                <span class="cat-icon">üê±</span>
                <span>Feed my cats</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Unlinked Library Tab -->
        <div v-if="activeTab === 'libraries'" class="tab-content">
          <div class="first-section">
            <div class="step-container">
              <div class="step-content">
                <h3 class="step-title">Library Variables</h3>
                <p class="description">
                  Analyze and list all variables in the current document, including their library status.
                </p>
                <div class="library-actions">
                  <button 
                    @click="listVariables" 
                    class="button primary-button"
                    :disabled="isAnalyzing"
                  >
                    {{ isAnalyzing ? 'Analyzing...' : 'Analyze Variables' }}
                  </button>
                  <button 
                    @click="startLibraryScan"
                    :disabled="isScanning || (!hasSelection && !scanEntirePage)" 
                    class="button secondary-button"
                  >
                    Scan for Unlinked
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="content">
            <!-- Loading State -->
            <div v-if="isAnalyzing" class="analysis-loading">
              <div class="loading-spinner"></div>
              <span>Analyzing variables...</span>
            </div>
            
            <!-- Variables Analysis Results -->
            <div v-if="variableAnalysis" class="analysis-results">
              <div class="analysis-summary">
                <div class="summary-item">
                  <span class="summary-label">Total Variables:</span>
                  <span class="summary-value">{{ variableAnalysis.totalVariables }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Library Variables:</span>
                  <span class="summary-value">{{ variableAnalysis.libraryVariables }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Local Variables:</span>
                  <span class="summary-value">{{ variableAnalysis.localVariables }}</span>
                </div>
              </div>
              
              <!-- Libraries List -->
              <div class="libraries-list">
                <h4 class="section-subtitle">Libraries</h4>
                <div v-for="lib in variableAnalysis.libraries" :key="lib.key" class="library-item">
                  <div class="library-header">
                    <span class="library-name">{{ lib.name }}</span>
                    <span :class="['library-status', lib.enabled ? 'enabled' : 'disabled']">
                      {{ lib.enabled ? 'Enabled' : 'Disabled' }}
                    </span>
                  </div>
                  <div class="library-details">
                    <span class="variable-count">{{ lib.variableCount }} variables</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Library Scan Results -->
            <template v-if="!isScanning && Object.keys(libraryResults).length > 0">
              <div class="divider"></div>
              
              <div class="step-container">
                <div class="step-content">
                  <div class="results-header">
                    <h3 class="step-title">Library scan results</h3>
                    <div class="results-actions">
                      <button 
                        class="button secondary-button"
                        @click="clearLibraryResults"
                      >
                        Clear
                      </button>
                    </div>
                  </div>
                  <div class="results-container">
                    <div v-for="(group, groupKey) in libraryResults" :key="groupKey" class="value-group">
                      <!-- Value Group Header -->
                      <div class="value-group-header" @click="toggleGroup(groupKey)">
                        <div class="header-left">
                          <span class="expand-icon">{{ isGroupExpanded(groupKey) ? '‚ñº' : '‚ñ∂' }}</span>
                          <template v-if="group.refs[0]?.type === 'typography'">
                            <span class="value-label">
                              {{ group.refs[0].currentValue.fontFamily }} 
                              {{ group.refs[0].currentValue.fontWeight }} 
                              {{ group.refs[0].currentValue.fontSize }}px
                            </span>
                          </template>
                          <template v-else>
                            <span class="value-label">Value: {{ formatValue(group.value) }}</span>
                          </template>
                        </div>
                        <div class="header-right">
                          <span class="total-count">{{ group.refs.length }} instances</span>
                          <button 
                            class="select-button" 
                            :class="{ 'loading': isSelecting(groupKey) }"
                            @click.stop="selectGroup(group.refs, groupKey)"
                            :disabled="isSelecting(groupKey)"
                          >
                            <span v-if="!isSelecting(groupKey)">Select All</span>
                            <span v-else class="loading-spinner"></span>
                          </button>
                        </div>
                      </div>

                      <!-- Expanded Content -->
                      <div v-if="isGroupExpanded(groupKey)" class="reference-details">
                        <div v-for="ref in group.refs" :key="ref.nodeId" class="reference-item">
                          <!-- Special handling for typography items -->
                          <template v-if="ref.type === 'typography'">
                            <div class="typography-details">
                              <div class="typography-preview">{{ ref.currentValue.content }}...</div>
                              <div class="typography-specs">
                                <div>Font: {{ ref.currentValue.fontFamily }}</div>
                                <div>Weight: {{ ref.currentValue.fontWeight }}</div>
                                <div>Size: {{ ref.currentValue.fontSize }}px</div>
                                <div v-if="ref.currentValue.lineHeight">Line Height: {{ ref.currentValue.lineHeight }}</div>
                                <div v-if="ref.currentValue.letterSpacing">Letter Spacing: {{ ref.currentValue.letterSpacing }}</div>
                                <div v-if="ref.currentValue.paragraphSpacing">Paragraph Spacing: {{ ref.currentValue.paragraphSpacing }}</div>
                                <div v-if="ref.currentValue.textCase">Text Case: {{ ref.currentValue.textCase }}</div>
                                <div v-if="ref.currentValue.textDecoration">Text Decoration: {{ ref.currentValue.textDecoration }}</div>
                              </div>
                            </div>
                          </template>
                          <template v-else>
                            <div class="reference-name">{{ ref.nodeName }}</div>
                            <div class="reference-location">{{ ref.location }}</div>
                          </template>
                          <button 
                            class="select-button"
                            :class="{ 'loading': isSelecting(ref.nodeId) }"
                            @click="selectGroup([ref], ref.nodeId)"
                            :disabled="isSelecting(ref.nodeId)"
                          >
                            <span v-if="!isSelecting(ref.nodeId)">Select</span>
                            <span v-else class="loading-spinner"></span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Toast -->
    <div 
      class="success-toast" 
      :class="{ 
        visible: showSuccessToast,
        warning: successMessage === 'Scanning the entire page may take longer'
      }"
      v-if="showSuccessToast"
    >
      <div class="success-toast-content">
        <div class="success-toast-icon">
          <svg v-if="successMessage !== 'Scanning the entire page may take longer'" 
            width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33334C4.31811 1.33334 1.33334 4.31811 1.33334 8C1.33334 11.6819 4.31811 14.6667 8 14.6667C11.6819 14.6667 14.6667 11.6819 14.6667 8C14.6667 4.31811 11.6819 1.33334 8 1.33334ZM11.0607 6.27274L7.39401 9.93941L5.27274 7.81814L6.06069 7.03019L7.39401 8.36351L10.2727 5.48479L11.0607 6.27274Z" fill="currentColor"/>
          </svg>
          <svg v-else width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1L14.6667 13H1.33334L8 1ZM8 3.66667L3.73334 11.6667H12.2667L8 3.66667ZM7.33334 6H8.66668V8.66667H7.33334V6ZM7.33334 10H8.66668V11.3333H7.33334V10Z" fill="currentColor"/>
          </svg>
        </div>
        <span class="success-toast-message">{{ successMessage }}</span>
        <button class="success-toast-close" @click="dismissToast">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M12.6667 4.27337L11.7267 3.33337L8.00001 7.06004L4.27334 3.33337L3.33334 4.27337L7.06001 8.00004L3.33334 11.7267L4.27334 12.6667L8.00001 8.94004L12.6667 4.27337Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Version Info -->
    <div class="bottom-section">
      <div class="divider"></div>
      <div class="bottom-info">
        <div class="version-info">
          <span class="version-text">Version 1.0.0</span>
        </div>
        <button 
          class="donate-button"
          @click="openStripePayment"
        >
          <span class="cat-icon">üê±</span>
          <span>Support this plugin</span>
        </button>
      </div>
    </div>
  </div>

  <style>
    /* Add Figma's font stack at the top of your styles */
    :root {
      --font-stack: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
    }

    [v-cloak] { display: none; }
    
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #2C2C2C;
      color: #FFFFFF;
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
    }

    #app {
      height: 100%;
      overflow: hidden;
    }

    .plugin-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      background: var(--figma-color-bg);
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      padding-right: 2px;
      background: var(--figma-color-bg);
    }

    .header {
      flex-shrink: 0;
      padding: 16px;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .header h2 {
      font-family: var(--font-stack);
      font-weight: 600;
      font-size: 13px;
      line-height: 24px;
      margin: 0;
    }

    .scan-type-selector {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .scan-type-selector label {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 4px;
    }

    .select-input {
      padding: 8px 8px 8px 12px;
      height: 32px;
      border: 1px solid var(--figma-color-border);
      border-radius: 2px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      appearance: none;
      cursor: pointer;
    }

    .scan-controls {
      display: flex;
      gap: 8px;
    }

    .button {
      padding: 5px 12px;
      height: 32px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 90px;
    }

    .primary-button {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .primary-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .secondary-button {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
    }

    .secondary-button:not(.button-disabled):hover {
      background: var(--figma-color-bg-hover);
    }

    .progress-container {
      padding: 8px 0;
      position: relative;
      min-height: 20px;
    }

    .progress-bar {
      height: 20px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      transition: all 0.2s ease;
      animation: pulse 2s infinite;
      border-radius: 6px;
    }

    .progress-fill:not(.complete) {
      background: linear-gradient(
        90deg,
        var(--figma-color-bg-brand) 0%,
        var(--figma-color-bg-brand-hover) 100%
      );
    }

    .progress-text {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      margin: 0;
      font-size: 11px;
      font-weight: 500;
      color: var(--figma-color-text-onbrand);
      z-index: 1;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      padding: 0 4px;
      min-width: 40px;
      text-align: right;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.9;
      }
      100% {
        opacity: 1;
      }
    }

    .references-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }

    .reference-card {
      padding: 0;
      background: var(--figma-color-bg-secondary);
      border-radius: 2px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .reference-info {
      flex: 1;
      padding: 12px;
    }

    .reference-header {
      cursor: pointer;
      user-select: none;
      padding: 4px 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .expand-icon {
      font-size: 8px;
      color: var(--figma-color-text-secondary);
      width: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .current-value-label {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }

    .reference-header:hover {
      background: var(--figma-color-bg-hover);
    }

    .parameter-name {
      font-family: var(--font-stack);
      font-weight: 500;
      font-size: 11px;
    }

    .missing-count {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
    }

    .variable-details {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--figma-color-border);
    }

    .variable-item {
      padding: 8px 12px;
      background: var(--figma-color-bg-tertiary);
      border-radius: 2px;
    }

    .node-info,
    .location-info {
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      margin-top: 2px;
    }

    .select-button {
      padding: 5px 12px;
      height: 32px;
      min-width: 64px;
    }

    .empty-state {
      padding: 16px;
      text-align: center;
      color: var(--figma-color-text-secondary);
    }

    .empty-state p {
      margin: 0 0 16px 0;
    }

    .empty-state-steps {
      text-align: left;
      display: inline-block;
      line-height: 24px;
    }

    .value-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .value-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
      cursor: pointer;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .expand-icon {
      font-size: 8px;
      color: var(--figma-color-text-secondary);
    }

    .reference-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: var(--figma-color-bg-tertiary);
      border-radius: 4px;
      margin-top: 4px;
    }

    .select-button {
      padding: 4px 8px;
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }

    .select-button:hover {
      background: var(--figma-color-bg-brand-hover);
    }

    .scan-scope-selector {
      padding: 2px 0;
      width: 100%;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      padding: 2px 0;
      width: 100%;
    }

    .toggle-wrapper {
      position: relative;
      width: 28px;
      height: 16px;
      flex-shrink: 0;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      user-select: none;
      color: var(--figma-color-text);
      width: 100%;
      justify-content: space-between;
      padding: 2px 0;
    }

    .toggle-label-content {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .slow-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--figma-color-bg-warning);
      color: white;
      border-radius: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .toggle-input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--figma-color-bg-disabled);
      transition: .2s;
      border-radius: 16px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 12px;
      width: 12px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .2s;
      border-radius: 50%;
    }

    .toggle-input:checked + .toggle-slider {
      background-color: var(--figma-color-bg-brand);
    }

    .toggle-input:checked + .toggle-slider:before {
      transform: translateX(12px);
    }

    .toggle-input:disabled + .toggle-slider {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .selection-count {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }

    .warning-message,
    .info-message {
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .warning-message {
      background-color: var(--figma-color-bg-warning-secondary);
      color: white;
      border: 1px solid var(--figma-color-border-warning);
      background: var(--figma-color-bg-warning);
    }

    .info-message {
      background-color: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
    }

    .warning-icon,
    .info-icon {
      width: 12px;
      height: 12px;
      flex-shrink: 0;
      color: white;
    }

    /* Add icon components */
    .icon-warning {
      color: var(--figma-color-text-warning);
    }

    .icon-info {
      color: var(--figma-color-text-secondary);
    }

    /* Update existing styles */
    .toggle-label {
      width: 100%;
      justify-content: space-between;
    }

    .button.primary-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Add these styles */
    .typography-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      background: var(--figma-color-bg-secondary);
      border-radius: 4px;
    }

    .typography-preview {
      font-family: system-ui;
      color: var(--figma-color-text);
      opacity: 0.8;
      font-style: italic;
    }

    .typography-specs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 4px;
      font-size: 12px;
      color: var(--figma-color-text-secondary);
    }

    /* Add these styles */
    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--figma-color-text);
    }

    .scan-cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .scan-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }

    .scan-card:hover {
      background: var(--figma-color-bg-hover);
    }

    .scan-card.selected {
      background: var(--figma-color-bg-brand-tertiary);
      border-color: var(--figma-color-border-brand);
    }

    .scan-card-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      color: var(--figma-color-icon);
    }

    .scan-card-content {
      flex: 1;
    }

    .scan-card-title {
      font-weight: 500;
      margin-bottom: 4px;
      color: var(--figma-color-text);
    }

    .scan-card-description {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      line-height: 14px;
    }

    .scan-card.selected .scan-card-icon {
      color: var(--figma-color-icon-brand);
    }

    .scan-card.selected .scan-card-title {
      color: var(--figma-color-text-brand);
    }

    .toast {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 4px;
      background-color: var(--figma-color-bg-warning-tertiary);
      color: var(--figma-color-text-onwarning-tertiary);
      border: 1px solid var(--figma-color-border-warning);
    }

    .toast-icon {
      margin-right: 8px;
      opacity: 0.8;
      color: white;
    }

    .toast-message {
      font-size: 11px;
      font-weight: 500;
      opacity: 0.9;
      color: white;
    }

    .toast.success {
      background: var(--figma-color-bg-success-tertiary);
      color: white;
      border: 1px solid var(--figma-color-border-success);
    }

    .toast.success .toast-icon {
      margin-right: 8px;
      opacity: 1;
      color: white;
    }

    .toast.success .toast-message {
      font-size: 11px;
      font-weight: 500;
      opacity: 1;
      color: white;
    }

    .divider {
      height: 1px;
      background-color: var(--figma-color-border);
      margin: 0;
    }

    .first-section {
      background: var(--figma-color-bg);
      padding: 0;
      /* Tighter vertical spacing for first section */
      & .step-content {
        gap: 4px;  /* Reduce gap between elements */
      }
      
      & .selection-container {
        margin-bottom: 2px;  /* Reduce margin */
      }
      
      & .progress-container {
        padding: 2px 0;  /* Reduce padding */
      }
    }

    .step-container {
      padding: 16px;
      padding-top: 8px;  /* Reduce top padding to tighten spacing with tabs */
    }

    .step-content {
      display: flex;
      flex-direction: column;
      gap: 8px;  /* Reduce gap for tighter vertical spacing */
    }

    .step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .step-title {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
    }

    .watch-toggle {
      background: none;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .watch-toggle-content {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .watch-toggle-text {
      font-size: 11px;
      font-weight: 500;
    }

    .watch-toggle:hover {
      &:not(.disabled) {
        background: var(--figma-color-bg-hover);
        color: var(--figma-color-text);
      }
    }

    .watch-toggle.active {
      &:not(.disabled) {
        color: var(--figma-color-text-brand);
        background: var(--figma-color-bg-brand-tertiary);
      }
    }

    .watch-toggle.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
    }

    .watch-toggle.disabled:hover {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .results-actions {
      display: flex;
      gap: 8px;
    }

    .results-actions .button {
      min-width: unset;
      padding: 5px 12px;
      height: 28px;
    }

    .rescan {
      background: none;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      font-weight: 500;
    }

    .clear-results {
      background: none;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      font-weight: 500;
    }

    .selection-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .results-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* Add these styles to match Figma's scrollbar */
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--figma-color-bg-tertiary);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--figma-color-bg-secondary);
    }

    .select-button.loading {
      position: relative !important;
      color: transparent !important;
      pointer-events: none !important;
    }
    
    /* Update the loading spinner styles */
    .select-button.loading {
      position: relative;
      color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .select-button .loading-spinner {
      width: 12px;
      height: 12px;
      border-width: 2px;
      border-top-color: var(--figma-color-text-onbrand);
      border-right-color: var(--figma-color-text-onbrand);
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: auto;
    }

    /* Add specific styles for analysis loading spinner */
    .analysis-loading .loading-spinner {
      width: 24px;
      height: 24px;
      border-width: 2.5px;
      margin: 8px auto;
    }

    .select-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .success-toast.warning {
      background: var(--figma-color-bg-warning);
      border: 1px solid var(--figma-color-border-warning);
    }

    .success-toast.warning .success-toast-message,
    .success-toast.warning .success-toast-icon {
      color: white;
    }

    .watch-toggle.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
    }

    .watch-toggle.disabled:hover {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
    }

    .watch-toggle:hover {
      &:not(.disabled) {
        background: var(--figma-color-bg-hover);
        color: var(--figma-color-text);
      }
    }

    .watch-toggle.active {
      &:not(.disabled) {
        color: var(--figma-color-text-brand);
        background: var(--figma-color-bg-brand-tertiary);
      }
    }

    .tab-navigation {
      display: flex;
      margin: 16px 16px 8px 16px;  /* Add horizontal padding and reduce bottom margin */
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      padding: 4px;
      gap: 4px;
    }

    .tab-button {
      flex: 1;
      padding: 8px 12px;  /* Increase vertical padding slightly */
      background: var(--figma-color-bg);
      border: none;
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-radius: 4px;
      font-weight: 500;
    }

    .tab-button-disabled {
      flex: 1;
      padding: 8px 12px;  /* Match active tab padding */
      background: transparent;
      border: none;
      color: var(--figma-color-text-disabled);
      font-size: 11px;
      cursor: not-allowed;
      opacity: 0.5;
      border-radius: 4px;
      font-weight: 500;
    }

    .tab-button.active {
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      box-shadow: var(--figma-color-shadow);
    }

    .tab-button:not(.active):hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }

    .tab-button-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      opacity: 0.8;
    }

    .lock-icon {
      opacity: 0.7;
    }

    .tab-content {
      padding: 0;
    }

    .description {
      color: var(--figma-color-text-secondary);
      margin: 8px 0 16px;
    }

    .library-scan-controls {
      margin-top: 16px;
    }

    .library-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .analysis-results {
      margin: 0;
      padding: 16px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
    }

    .analysis-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-label {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }

    .summary-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--figma-color-text);
    }

    .section-subtitle {
      font-size: 12px;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: var(--figma-color-text);
    }

    .libraries-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .library-item {
      padding: 8px;
      background: var(--figma-color-bg);
      border-radius: 4px;
    }

    .library-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .library-name {
      font-weight: 500;
    }

    .library-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .library-status.enabled {
      background: var(--figma-color-bg-success);
      color: var(--figma-color-text-onbrand);
    }

    .library-status.disabled {
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-secondary);
    }

    .library-details {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }

    .analysis-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      margin: 0;
      color: var(--figma-color-text-secondary);
    }

    .loading-spinner {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: var(--figma-color-bg-brand);
      border-right-color: var(--figma-color-bg-brand);
      animation: spinner 0.6s linear infinite;
    }
    
    @keyframes spinner {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    /* Add specific styles for button loading spinner */
    .select-button .loading-spinner {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: auto;
      width: 12px;
      height: 12px;
      border-width: 2px;
      border-top-color: var(--figma-color-text-onbrand);
      border-right-color: var(--figma-color-text-onbrand);
    }

    /* Add specific styles for analysis loading spinner */
    .analysis-loading .loading-spinner {
      width: 24px;
      height: 24px;
      border-width: 2.5px;
      margin: 8px auto;
    }

    /* Container for select button spinner */
    .select-button.loading {
      position: relative;
      color: transparent;
    }

    .button.button-disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
      background: var(--figma-color-bg-disabled);
      color: var(--figma-color-text-disabled);
    }

    .bottom-section {
      margin-top: auto;  /* Push to bottom */
    }

    .bottom-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 16px;
    }

    .version-info {
      padding: 8px 0;
      text-align: center;
    }

    .version-text {
      font-size: 11px;
      color: var(--figma-color-text-tertiary);
      opacity: 0.8;
    }

    .donate-button {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-tertiary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .donate-button:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
      transform: scale(1.02);
    }

    .cat-icon {
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .donate-button:hover .cat-icon {
      transform: scale(1.1);
    }

    /* Add these styles */
    .scan-settings {
      margin-top: 8px;
      background: var(--figma-color-bg-secondary);
      border-radius: 6px;
      overflow: hidden;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
    }

    .settings-title {
      margin: 0;
      font-size: 11px;
      font-weight: 500;
      color: var(--figma-color-text);
    }

    .settings-toggle {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: var(--figma-color-text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.1s ease;
      border-radius: 6px;
      margin: -4px;
    }

    .settings-toggle:hover {
      background: var(--figma-color-bg-hover);
      color: var(--figma-color-text);
    }

    .settings-toggle:active {
      background: var(--figma-color-bg-pressed);
      color: var(--figma-color-text);
    }

    .settings-content {
      padding: 0 12px 12px;
    }

    .setting-item {
      margin-bottom: 8px;
    }

    .setting-item:last-child {
      margin-bottom: 0;
    }

    .toggle-label-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-badge {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
      cursor: help;
    }
  </style>

  <script>
    console.clear(); // Clear previous logs
    console.log('UI script started');

    // Add these icon components before createApp
    const IconWarning = {
      template: `
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M6 1L11 10H1L6 1ZM6 3L2.8 9H9.2L6 3ZM5.5 5H6.5V7H5.5V5ZM5.5 8H6.5V9H5.5V8Z" fill="currentColor"/>
        </svg>
      `
    };

    const IconInfo = {
      template: `
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M6 1C3.24 1 1 3.24 1 6C1 8.76 3.24 11 6 11C8.76 11 11 8.76 11 6C11 3.24 8.76 1 6 1ZM6 10C3.79 10 2 8.21 2 6C2 3.79 3.79 2 6 2C8.21 2 10 3.79 10 6 10ZM5 5H7V9H5V5ZM5 3H7V4H5V3Z" fill="currentColor"/>
        </svg>
      `
    };

    const IconTypography = {
      template: `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M8 4v16M16 4v16M4 12h6M14 12h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 8h2M15 8h2M7 16h2M15 16h2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      `
    };

    const IconSpacing = {
      template: `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <rect x="4" y="4" width="16" height="6" rx="1" stroke="currentColor" stroke-width="2"/>
          <rect x="4" y="14" width="16" height="6" rx="1" stroke="currentColor" stroke-width="2"/>
          <path d="M8 10v4M16 10v4" stroke="currentColor" stroke-width="2" stroke-dasharray="2 2"/>
          <path d="M12 12h0.01" stroke="currentColor" stroke-width="2"/>
        </svg>
      `
    };

    const IconRadius = {
      template: `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M4 12C4 7.58172 7.58172 4 12 4" stroke="currentColor" stroke-width="2"/>
          <path d="M12 4L12 7M12 4L9 4" stroke="currentColor" stroke-width="2"/>
          <rect x="12" y="12" width="8" height="8" rx="2" stroke="currentColor" stroke-width="2"/>
        </svg>
      `
    };

    const IconFill = {
      template: `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M16 4H8a4 4 0 00-4 4v8a4 4 0 004 4h8a4 4 0 004-4V8a4 4 0 00-4-4zM8 6h8a2 2 0 012 2v8a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2z" fill="currentColor"/>
          <rect x="8" y="8" width="8" height="8" fill="currentColor"/>
        </svg>
      `
    };

    const IconStroke = {
      template: `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <rect x="6" y="6" width="12" height="12" rx="2" stroke="currentColor" stroke-width="2"/>
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2"/>
        </svg>
      `
    };

    // Add these new icon components with the other icons
    const IconVerticalPadding = {
      template: `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
          <path d="M8 4h8M8 20h8" stroke="currentColor" stroke-width="2"/>
          <path d="M12 7v10" stroke="currentColor" stroke-width="2" stroke-dasharray="2 2"/>
        </svg>
      `
    };

    const IconHorizontalPadding = {
      template: `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
          <path d="M4 8v8M20 8v8" stroke="currentColor" stroke-width="2"/>
          <path d="M7 12h10" stroke="currentColor" stroke-width="2" stroke-dasharray="2 2"/>
        </svg>
      `
    };

    const IconInactiveLibrary = {
      template: `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M4 6.4C4 5.07452 5.07452 4 6.4 4H17.6C18.9255 4 20 5.07452 20 6.4V17.6C20 18.9255 18.9255 20 17.6 20H6.4C5.07452 20 4 18.9255 4 17.6V6.4Z" stroke="currentColor" stroke-width="2"/>
          <path d="M9 12L15 12M12 9L12 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 7L17 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      `
    };

    // Then create the Vue app
    const { createApp } = Vue;

    // Add the SuccessToast component definition
    const SuccessToast = {
      template: '#success-toast',
      props: {
        message: String,
        show: Boolean
      },
      methods: {
        close() {
          this.$emit('close');
        }
      }
    };

    createApp({
      components: {
        IconWarning,
        IconInfo,
        IconTypography,
        IconSpacing,
        IconRadius,
        IconFill,
        IconStroke,
        IconVerticalPadding,
        IconHorizontalPadding,
        IconInactiveLibrary,
        SuccessToast
      },
      data() {
        return {
          activeTab: 'tokens',
          selectedScanType: 'vertical-gap',
          scanEntirePage: false,
          isScanning: false,
          scanProgress: 0,
          groupedReferences: {},
          expandedGroups: new Set(),
          hasSelection: false,
          selectedCount: 0,
          isWatching: false,
          tokenScanOptions: [
            {
              value: 'typography',
              label: 'Typography',
              description: 'Find text layers missing text style variables',
              icon: 'IconTypography'
            },
            {
              value: 'vertical-padding',
              label: 'Vertical Padding',
              description: 'Find frames with unlinked vertical padding',
              icon: 'IconVerticalPadding'
            },
            {
              value: 'horizontal-padding',
              label: 'Horizontal Padding',
              description: 'Find frames with unlinked horizontal padding',
              icon: 'IconHorizontalPadding'
            },
            {
              value: 'vertical-gap',
              label: 'Vertical Gap',
              description: 'Find auto-layout frames with unlinked vertical gaps',
              icon: 'IconSpacing'
            },
            {
              value: 'corner-radius',
              label: 'Corner Radius',
              description: 'Find shapes with unlinked corner radius',
              icon: 'IconRadius'
            },
            {
              value: 'fill',
              label: 'Fill Colors',
              description: 'Find layers with unlinked fill colors',
              icon: 'IconFill'
            },
            {
              value: 'stroke',
              label: 'Stroke Colors',
              description: 'Find layers with unlinked stroke colors',
              icon: 'IconStroke'
            }
          ],
          showSuccessToast: false,
          successMessage: '',
          selectingNodeIds: new Set(), // Track which groups are being selected
          libraryResults: {},  // Separate results for library scan
          variableAnalysis: null,
          isAnalyzing: false,
          showSettings: false,
          ignoreHiddenLayers: false,
        }
      },
      computed: {
        scanScope() {
          return this.scanEntirePage ? 'entire-page' : 'selected-frames';
        },
        canStartScan() {
          return this.hasSelection || this.scanEntirePage;
        },
        hasResults() {
          return Object.keys(this.groupedReferences).length > 0;
        },
        groupedByValue() {
          const valueGroups = {};
          
          Object.entries(this.groupedReferences).forEach(([key, refs]) => {
            try {
              // Split the key safely
              const [property, ...valueParts] = key.split(':');
              const valueStr = valueParts.join(':'); // Rejoin in case value contains colons
              
              // Parse the value safely
              let value;
              try {
                value = JSON.parse(valueStr);
              } catch {
                value = valueStr; // Use raw string if parsing fails
              }
              
              const groupKey = typeof value === 'object' ? JSON.stringify(value) : String(value);
              
              if (!valueGroups[groupKey]) {
                valueGroups[groupKey] = {
                  value,
                  properties: new Set(),
                  refs: []
                };
              }
              
              valueGroups[groupKey].properties.add(property);
              valueGroups[groupKey].refs.push(...refs);
            } catch (err) {
              console.warn('Error processing group:', key, err);
            }
          });
          
          return valueGroups;
        },
        watchButtonTitle() {
          if (!this.scanEntirePage) {
            return 'Enable "Scan Entire Page" to use watch mode';
          }
          return this.isWatching ? 'Stop watching for changes' : 'Watch for changes';
        },
        canWatch() {
          return this.scanEntirePage;
        }
      },
      methods: {
        handleScanScopeChange() {
          if (this.scanEntirePage) {
            this.successMessage = 'Scanning the entire page may take longer';
            this.showSuccessToast = true;
            setTimeout(() => {
              if (this.successMessage === 'Scanning the entire page may take longer') {
                this.showSuccessToast = false;
              }
            }, 3000);
          } else {
            this.stopWatching();
          }
          // Store the user's preference
          this.userPrefersScanEntirePage = this.scanEntirePage;
        },
        stopWatching() {
          this.isWatching = false;
          parent.postMessage({ 
            pluginMessage: { 
              type: 'stop-watching'
            }
          }, '*');
        },
        async startScan(isRescan = false, event) {
          event?.preventDefault?.();

          if (!this.canStartScan) return;
          
          this.isScanning = true;
          this.scanProgress = 0;
          await new Promise(resolve => setTimeout(resolve, 50));
          
          if (!isRescan) {
            this.groupedReferences = {};
          }

          const selectedFrameIds = !this.scanEntirePage 
            ? await this.getSelectedFrameIds()
            : undefined;

          parent.postMessage({ 
            pluginMessage: { 
              type: 'scan-for-tokens',
              scanType: this.selectedScanType,
              scanScope: this.scanScope,
              selectedFrameIds,
              isRescan,
              ignoreHiddenLayers: this.ignoreHiddenLayers
            }
          }, '*');
        },
        async getSelectedFrameIds() {
          return new Promise((resolve) => {
            parent.postMessage({ 
              pluginMessage: { type: 'get-selected-frame-ids' }
            }, '*');

            const handler = (event) => {
              const msg = event.data.pluginMessage;
              if (msg.type === 'selected-frame-ids') {
                window.removeEventListener('message', handler);
                resolve(msg.ids);
              }
            };
            window.addEventListener('message', handler);
          });
        },
        stopScan() {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'cancel-scan' 
            }
          }, '*');
        },
        async selectGroup(refs, groupId) {
          this.selectingNodeIds.add(groupId);
          const nodeIds = refs.map(ref => ref.nodeId);
          parent.postMessage({ 
            pluginMessage: { 
              type: 'select-group',
              nodeIds
            }
          }, '*');
          
          setTimeout(() => {
            this.selectingNodeIds.delete(groupId);
          }, 500);
        },
        formatValue(value) {
          if (!value) return 'None';
          if (typeof value === 'object') {
            if ('r' in value && 'g' in value && 'b' in value) {
              return `RGB(${Math.round(value.r * 255)}, ${Math.round(value.g * 255)}, ${Math.round(value.b * 255)})`;
            }
            return JSON.stringify(value);
          }
          return String(value);
        },
        toggleGroup(key) {
          if (this.expandedGroups.has(key)) {
            this.expandedGroups.delete(key);
          } else {
            this.expandedGroups.add(key);
          }
        },
        isGroupExpanded(key) {
          return this.expandedGroups.has(key);
        },
        getPropertyName(key) {
          return key.split(':')[0];
        },
        toggleWatch() {
          if (!this.canWatch) return;
          
          this.isWatching = !this.isWatching;
          parent.postMessage({ 
            pluginMessage: { 
              type: this.isWatching ? 'start-watching' : 'stop-watching',
              scanType: this.selectedScanType,
              scanScope: this.scanScope,
              scanEntirePage: this.scanEntirePage
            }
          }, '*');
        },
        clearResults() {
          this.groupedReferences = {};
        },
        dismissToast() {
          this.showSuccessToast = false;
        },
        handleResize(msg) {
          if (msg.type === 'resize' && msg.width && msg.height) {
            const width = Number(msg.width);
            const height = Number(msg.height);
            
            if (!isNaN(width) && !isNaN(height)) {
              this.windowSize = { width, height };
            }
          }
        },
        updateProgress(newProgress) {
          const progress = Math.min(Math.max(0, Number(newProgress) || 0), 100);
          console.log(`Updating progress bar: ${progress}%`);
          this.scanProgress = progress;
        },
        isSelecting(id) {
          return this.selectingNodeIds.has(id);
        },
        async startLibraryScan() {
          this.isScanning = true;
          this.scanProgress = 0;
          
          const selectedFrameIds = !this.scanEntirePage  // Use the same scanEntirePage state
            ? await this.getSelectedFrameIds()
            : undefined;
          
          parent.postMessage({ 
            pluginMessage: { 
              type: 'scan-for-tokens',
              scanType: 'inactive-tokens',
              scanScope: this.scanEntirePage ? 'entire-page' : 'selected-frames',
              selectedFrameIds
            }
          }, '*');
        },
        clearLibraryResults() {
          this.libraryResults = {};
        },
        async listVariables() {
          this.isAnalyzing = true;
          this.variableAnalysis = null;  // Reset previous results
          parent.postMessage({ 
            pluginMessage: { 
              type: 'list-variables'
            }
          }, '*');
        },
        openStripePayment() {
          window.open('https://buy.stripe.com/8wM7wb49NeFD5UYcMM', '_blank');
        }
      },
      mounted() {
        console.log('Vue app mounted');

        window.onmessage = (event) => {
          const msg = event.data.pluginMessage;
          if (!msg) return;

          switch (msg.type) {
            case 'selection-updated':
              this.hasSelection = msg.hasSelection;
              this.selectedCount = msg.count;
              break;
            case 'watch-scan-started':
              this.isScanning = true;
              this.scanProgress = 0;
              break;
            case 'scan-progress':
              console.log('Received progress update:', msg.progress);
              this.updateProgress(msg.progress);
              break;
            case 'missing-references-result':
              // Store results in the appropriate place based on scan type
              if (msg.scanType === 'inactive-tokens') {
                this.libraryResults = msg.references;
              } else {
                this.groupedReferences = msg.references;
              }
              this.isScanning = false;
              this.updateProgress(100);
              break;
            case 'scan-cancelled':
              this.isScanning = false;
              this.scanProgress = 0;
              break;
            case 'error':
              console.error(msg.message);
              this.isScanning = false;
              this.scanProgress = 0;
              break;
            case 'scan-complete':
              this.isScanning = false;
              this.scanProgress = 100;
              if (msg.status === 'success') {
                this.successMessage = msg.message;
                this.showSuccessToast = true;
                this.groupedReferences = {};
              }
              break;
            case 'watch-status':
              this.isWatching = msg.isWatching && this.scanEntirePage;
              if (!msg.isWatching) {
                this.isScanning = false;
                this.scanProgress = 0;
              }
              break;
            case 'resize':
              this.handleResize(msg);
              break;
            case 'selection-complete':
              this.selectingNodeIds.clear();
              break;
            case 'variables-analysis':
              this.isAnalyzing = false;
              this.variableAnalysis = msg.data;
              break;
            case 'variables-analysis-error':
              this.isAnalyzing = false;
              this.successMessage = msg.message;
              this.showSuccessToast = true;
              break;
            case 'clear-results':
              this.groupedReferences = {};
              break;
          }
        };
      },
      created() {
        // Ensure we stay on the tokens tab
        this.activeTab = 'tokens';
      }
    }).mount('#app');

    document.getElementById('loading').style.display = 'none';
  </script>
</body>
</html>
