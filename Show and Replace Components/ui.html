<!DOCTYPE html>
<html>
<head>
  <!-- Replace the mock Vue implementation with the actual Vue.js library -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
  <!-- Loading indicator -->
  <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100vh;">
    Loading...
  </div>

  <!-- Main app -->
  <div id="app">
    <div v-cloak class="plugin-container">
      <header class="header">
        <h2>linkify</h2>
      </header>

      <div class="content">
        <!-- Scan Type Selection -->
        <div class="scan-type-selector">
          <label for="scan-type">Select what to scan for:</label>
          <select v-model="selectedScanType" id="scan-type" class="select-input">
            <option value="vertical-gap">Vertical Gaps</option>
            <option value="horizontal-padding">Horizontal Padding</option>
            <option value="vertical-padding">Vertical Padding</option>
            <option value="corner-radius">Corner Radius</option>
            <option value="fill">Fill Colors</option>
            <option value="stroke">Stroke Colors</option>
            <option value="typography">Typography</option>
          </select>
        </div>

        <!-- Scan Scope Selection -->
        <div class="scan-scope-selector">
          <div class="toggle-container">
            <label class="toggle-label">
              <span>Include Entire Page</span>
              <div class="toggle-wrapper">
                <input 
                  type="checkbox" 
                  v-model="scanEntirePage"
                  class="toggle-input"
                  @change="handleScanScopeChange"
                >
                <div class="toggle-slider"></div>
              </div>
            </label>
          </div>
          <!-- Warning message when scanning entire page -->
          <div v-if="scanEntirePage" class="warning-message">
            <icon-warning class="warning-icon" />
            Scanning the entire page may take longer
          </div>
          <!-- Message when no frames are selected -->
          <div v-if="!hasSelection" class="info-message">
            <icon-info class="info-icon" />
            Select frames to start scanning
          </div>
        </div>

        <!-- Scan Controls -->
        <div class="scan-controls">
          <button 
            @click="startScan" 
            :disabled="isScanning || (!hasSelection && !scanEntirePage)" 
            class="button primary-button"
          >
            Start Scan
          </button>
          <button 
            v-if="isScanning" 
            @click="cancelScan" 
            class="button secondary-button"
          >
            Cancel
          </button>
        </div>

        <!-- Progress Bar -->
        <div v-if="isScanning" class="progress-container">
          <div class="progress-bar">
            <div 
              class="progress-fill" 
              :style="{ width: `${scanProgress}%` }"
            ></div>
          </div>
          <div class="progress-text">{{ Math.round(scanProgress) }}%</div>
        </div>

        <!-- Results Section -->
        <div v-if="!isScanning && Object.keys(groupedReferences).length > 0" class="references-container">
          <div v-for="(group, groupKey) in groupedByValue" :key="groupKey" class="value-group">
            <!-- Value Group Header -->
            <div class="value-group-header">
              <span class="value-label">Value: {{ formatValue(group.value) }}</span>
              <span class="total-count">{{ group.refs.length }} instances</span>
            </div>

            <!-- Properties with this value -->
            <div class="reference-card">
              <div class="reference-info">
                <div class="reference-header" @click="toggleGroup(groupKey)">
                  <div class="header-left">
                    <span class="expand-icon">{{ isGroupExpanded(groupKey) ? '▼' : '▶' }}</span>
                    <div class="properties-list">
                      <span class="property-tag" v-for="prop in group.properties" :key="prop">
                        {{ prop }}
                      </span>
                    </div>
                  </div>
                </div>
                
                <!-- Collapsible content -->
                <div v-if="isGroupExpanded(groupKey)" class="variable-details">
                  <div v-for="ref in group.refs" :key="ref.nodeId" class="variable-item">
                    <div class="node-info">{{ ref.nodeName }}</div>
                    <div class="location-info">{{ ref.property }} in {{ ref.location }}</div>
                  </div>
                </div>
              </div>
              <button @click="selectGroup(group.refs)" class="button select-button">
                Select All
              </button>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div v-else-if="!isScanning" class="empty-state">
          <p>No missing references found.</p>
          <p class="empty-state-steps">
            1. Select frames or components in Figma<br>
            2. Choose a scan type from the dropdown<br>
            3. Click "Start Scan" to begin
          </p>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Add Figma's font stack at the top of your styles */
    :root {
      --font-stack: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
    }

    [v-cloak] { display: none; }
    
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #2C2C2C;
      color: #FFFFFF;
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
    }

    #app {
      height: 100%;
      overflow: hidden;
    }

    .plugin-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .header {
      flex-shrink: 0;
      padding: 16px;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .header h2 {
      font-family: var(--font-stack);
      font-weight: 600;
      font-size: 13px;
      line-height: 24px;
      margin: 0;
    }

    .scan-type-selector {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .scan-type-selector label {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      margin-bottom: 4px;
    }

    .select-input {
      padding: 8px 8px 8px 12px;
      height: 32px;
      border: 1px solid var(--figma-color-border);
      border-radius: 2px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      appearance: none;
      cursor: pointer;
    }

    .scan-controls {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .button {
      padding: 5px 12px;
      height: 32px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 90px;
    }

    .primary-button {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .primary-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .secondary-button {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
    }

    .progress-container {
      margin: 16px 0;
    }

    .progress-bar {
      height: 4px;
      background: var(--figma-color-bg-secondary);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--figma-color-bg-brand);
      transition: width 0.3s ease;
    }

    .progress-text {
      margin-top: 4px;
      text-align: center;
      font-size: 12px;
      color: var(--figma-color-text-secondary);
    }

    .references-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }

    .reference-card {
      padding: 0;
      background: var(--figma-color-bg-secondary);
      border-radius: 2px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .reference-info {
      flex: 1;
      padding: 12px;
    }

    .reference-header {
      cursor: pointer;
      user-select: none;
      padding: 4px 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .expand-icon {
      font-size: 8px;
      color: var(--figma-color-text-secondary);
      width: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .current-value-label {
      color: var(--figma-color-text-secondary);
      font-size: 11px;
    }

    .reference-header:hover {
      background: var(--figma-color-bg-hover);
    }

    .parameter-name {
      font-family: var(--font-stack);
      font-weight: 500;
      font-size: 11px;
    }

    .missing-count {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
    }

    .variable-details {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--figma-color-border);
    }

    .variable-item {
      padding: 8px 12px;
      background: var(--figma-color-bg-tertiary);
      border-radius: 2px;
    }

    .node-info,
    .location-info {
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      margin-top: 2px;
    }

    .select-button {
      padding: 5px 12px;
      height: 32px;
      min-width: 64px;
    }

    .empty-state {
      text-align: center;
      color: var(--figma-color-text-secondary);
      padding: 32px 16px;
    }

    .empty-state p {
      margin: 0 0 16px 0;
    }

    .empty-state-steps {
      text-align: left;
      display: inline-block;
      line-height: 24px;
    }

    .value-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .value-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      background: var(--figma-color-bg);
      border-radius: 2px;
      font-size: 11px;
    }

    .value-label {
      font-weight: 500;
    }

    .total-count {
      color: var(--figma-color-text-secondary);
    }

    .properties-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .property-tag {
      background: var(--figma-color-bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
    }

    .scan-scope-selector {
      margin: 8px 0;
    }

    .toggle-container {
      display: flex;
      align-items: center;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      color: var(--figma-color-text);
    }

    .toggle-label:has(input:disabled) {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .toggle-wrapper {
      position: relative;
      width: 28px;
      height: 16px;
    }

    .toggle-input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--figma-color-bg-disabled);
      transition: .2s;
      border-radius: 16px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 12px;
      width: 12px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .2s;
      border-radius: 50%;
    }

    .toggle-input:checked + .toggle-slider {
      background-color: var(--figma-color-bg-brand);
    }

    .toggle-input:checked + .toggle-slider:before {
      transform: translateX(12px);
    }

    .toggle-input:disabled + .toggle-slider {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .selection-count {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }

    .warning-message,
    .info-message {
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .warning-message {
      background-color: var(--figma-color-bg-warning);
      color: var(--figma-color-text-warning);
    }

    .info-message {
      background-color: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
    }

    .warning-icon,
    .info-icon {
      width: 12px;
      height: 12px;
      flex-shrink: 0;
    }

    /* Add icon components */
    .icon-warning {
      color: var(--figma-color-text-warning);
    }

    .icon-info {
      color: var(--figma-color-text-secondary);
    }

    /* Update existing styles */
    .toggle-label {
      width: 100%;
      justify-content: space-between;
    }

    .button.primary-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
  </style>

  <script>
    console.clear(); // Clear previous logs
    console.log('UI script started');

    // First define the icon components
    const IconWarning = {
      template: `
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M6 1L11 10H1L6 1ZM6 3L2.8 9H9.2L6 3ZM5.5 5H6.5V7H5.5V5ZM5.5 8H6.5V9H5.5V8Z" fill="currentColor"/>
        </svg>
      `
    };

    const IconInfo = {
      template: `
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M6 1C3.24 1 1 3.24 1 6C1 8.76 3.24 11 6 11C8.76 11 11 8.76 11 6C11 3.24 8.76 1 6 1ZM6 10C3.79 10 2 8.21 2 6C2 3.79 3.79 2 6 2C8.21 2 10 3.79 10 6C10 8.21 8.21 10 6 10ZM5 5H7V9H5V5ZM5 3H7V4H5V3Z" fill="currentColor"/>
        </svg>
      `
    };

    // Then create the Vue app
    const { createApp } = Vue;

    createApp({
      components: {
        IconWarning,
        IconInfo
      },
      data() {
        return {
          selectedScanType: 'vertical-gap',
          scanEntirePage: false,
          isScanning: false,
          scanProgress: 0,
          groupedReferences: {},
          expandedGroups: new Set(),
          hasSelection: false,
          selectedCount: 0,
        }
      },
      computed: {
        scanScope() {
          return this.scanEntirePage ? 'entire-page' : 'selected-frames';
        },
        canStartScan() {
          return this.hasSelection || this.scanEntirePage;
        },
        groupedByValue() {
          const valueGroups = {};
          
          Object.entries(this.groupedReferences).forEach(([key, refs]) => {
            try {
              // Split the key safely
              const [property, ...valueParts] = key.split(':');
              const valueStr = valueParts.join(':'); // Rejoin in case value contains colons
              
              // Parse the value safely
              let value;
              try {
                value = JSON.parse(valueStr);
              } catch {
                value = valueStr; // Use raw string if parsing fails
              }
              
              const groupKey = typeof value === 'object' ? JSON.stringify(value) : String(value);
              
              if (!valueGroups[groupKey]) {
                valueGroups[groupKey] = {
                  value,
                  properties: new Set(),
                  refs: []
                };
              }
              
              valueGroups[groupKey].properties.add(property);
              valueGroups[groupKey].refs.push(...refs);
            } catch (err) {
              console.warn('Error processing group:', key, err);
            }
          });
          
          return valueGroups;
        }
      },
      methods: {
        handleScanScopeChange() {
          if (this.scanEntirePage) {
            // Optional: Show a confirmation dialog for large pages
            if (confirm('Scanning the entire page may take a long time. Continue?')) {
              return;
            }
            this.scanEntirePage = false;
          }
        },
        async startScan() {
          if (!this.canStartScan) return;
          
          this.isScanning = true;
          this.scanProgress = 0;
          this.groupedReferences = {};

          const selectedFrameIds = !this.scanEntirePage 
            ? await this.getSelectedFrameIds()
            : undefined;

          parent.postMessage({ 
            pluginMessage: { 
              type: 'scan-for-tokens',
              scanType: this.selectedScanType,
              scanScope: this.scanScope,
              selectedFrameIds
            }
          }, '*');
        },
        async getSelectedFrameIds() {
          return new Promise((resolve) => {
            parent.postMessage({ 
              pluginMessage: { type: 'get-selected-frame-ids' }
            }, '*');

            const handler = (event) => {
              const msg = event.data.pluginMessage;
              if (msg.type === 'selected-frame-ids') {
                window.removeEventListener('message', handler);
                resolve(msg.ids);
              }
            };
            window.addEventListener('message', handler);
          });
        },
        cancelScan() {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'cancel-scan' 
            }
          }, '*');
        },
        selectGroup(refs) {
          const nodeIds = refs.map(ref => ref.nodeId);
          parent.postMessage({ 
            pluginMessage: { 
              type: 'select-group',
              nodeIds
            }
          }, '*');
        },
        formatValue(value) {
          if (!value) return 'None';
          if (typeof value === 'object') {
            if ('r' in value && 'g' in value && 'b' in value) {
              return `RGB(${Math.round(value.r * 255)}, ${Math.round(value.g * 255)}, ${Math.round(value.b * 255)})`;
            }
            return JSON.stringify(value);
          }
          return String(value);
        },
        toggleGroup(key) {
          if (this.expandedGroups.has(key)) {
            this.expandedGroups.delete(key);
          } else {
            this.expandedGroups.add(key);
          }
        },
        isGroupExpanded(key) {
          return this.expandedGroups.has(key);
        },
        getPropertyName(key) {
          return key.split(':')[0];
        }
      },
      mounted() {
        console.log('Vue app mounted');
        window.onmessage = (event) => {
          const msg = event.data.pluginMessage;
          if (!msg) return;

          switch (msg.type) {
            case 'selection-updated':
              this.hasSelection = msg.hasSelection;
              this.selectedCount = msg.count;
              if (!this.hasSelection) {
                this.scanEntirePage = false;
              }
              break;
            case 'scan-progress':
              this.scanProgress = msg.progress;
              break;
            case 'missing-references-result':
              this.groupedReferences = msg.references;
              this.isScanning = false;
              break;
            case 'scan-cancelled':
              this.isScanning = false;
              break;
            case 'error':
              console.error(msg.message);
              this.isScanning = false;
              break;
          }
        };
      }
    }).mount('#app');

    // Add this at the end of your Vue initialization
    document.getElementById('loading').style.display = 'none';
  </script>
</body>
</html>
