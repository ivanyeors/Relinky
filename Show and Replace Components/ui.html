<!DOCTYPE html>
<html>
<head>
  <!-- Replace the mock Vue implementation with the actual Vue.js library -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
  <!-- Loading indicator -->
  <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100vh;">
    Loading...
  </div>

  <!-- Main app -->
  <div id="app">
    <div v-cloak class="plugin-container">
      <header class="header">
        <h2>Missing References Finder</h2>
      </header>

      <div class="content">
        <!-- Scan Type Selection -->
        <div class="scan-type-selector">
          <label for="scan-type">Select what to scan for:</label>
          <select v-model="selectedScanType" id="scan-type" class="select-input">
            <option value="vertical-gap">Vertical Gaps</option>
            <option value="horizontal-padding">Horizontal Padding</option>
            <option value="vertical-padding">Vertical Padding</option>
            <option value="corner-radius">Corner Radius</option>
            <option value="fill">Fill Colors</option>
            <option value="stroke">Stroke Colors</option>
            <option value="typography">Typography</option>
          </select>
        </div>

        <!-- Scan Controls -->
        <div class="scan-controls">
          <button 
            @click="startScan" 
            :disabled="isScanning" 
            class="button primary-button"
          >
            Start Scan
          </button>
          <button 
            v-if="isScanning" 
            @click="cancelScan" 
            class="button secondary-button"
          >
            Cancel
          </button>
        </div>

        <!-- Progress Bar -->
        <div v-if="isScanning" class="progress-container">
          <div class="progress-bar">
            <div 
              class="progress-fill" 
              :style="{ width: `${scanProgress}%` }"
            ></div>
          </div>
          <div class="progress-text">{{ Math.round(scanProgress) }}%</div>
        </div>

        <!-- Results Section -->
        <div v-if="!isScanning && Object.keys(groupedReferences).length > 0" class="references-container">
          <div v-for="(refs, property) in groupedReferences" :key="property" class="reference-group">
            <div class="reference-card">
              <div class="reference-info">
                <div class="reference-header">
                  <span class="parameter-name">{{ property }}</span>
                  <span class="missing-count">{{ refs.length }} missing</span>
                </div>
                <!-- Add variable details -->
                <div class="variable-details">
                  <div v-for="ref in refs" :key="ref.nodeId" class="variable-item">
                    <div class="variable-name">{{ ref.variableName || 'Unnamed Variable' }}</div>
                    <div class="variable-value" v-if="ref.variableValue">
                      Value: {{ formatValue(ref.variableValue) }}
                    </div>
                    <div class="node-info">
                      Used in: {{ ref.nodeName }}
                    </div>
                    <div class="location-info">
                      Location: {{ ref.location }}
                    </div>
                    <div class="current-value">
                      Current Value: {{ formatValue(ref.currentValue) }}
                    </div>
                  </div>
                </div>
              </div>
              <button @click="selectGroup(refs)" class="button select-button">Select</button>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div v-else-if="!isScanning" class="empty-state">
          <p>No missing references found.</p>
          <p>Select a scan type and click "Start Scan" to begin.</p>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Add Figma's font stack at the top of your styles */
    :root {
      --font-stack: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
    }

    [v-cloak] { display: none; }
    
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #2C2C2C;
      color: #FFFFFF;
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
    }

    #app {
      height: 100%;
      overflow: hidden;
    }

    .plugin-container {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100vh;
    }

    .header {
      padding-bottom: 16px;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .header h2 {
      font-family: var(--font-stack);
      font-weight: 600;
      font-size: 13px;
      line-height: 24px;
      margin: 0;
    }

    .scan-type-selector {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .select-input {
      padding: 8px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
    }

    .scan-controls {
      display: flex;
      gap: 8px;
    }

    .button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      font-weight: 500;
    }

    .primary-button {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .secondary-button {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text);
    }

    .progress-container {
      margin: 16px 0;
    }

    .progress-bar {
      height: 4px;
      background: var(--figma-color-bg-secondary);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--figma-color-bg-brand);
      transition: width 0.3s ease;
    }

    .progress-text {
      margin-top: 4px;
      text-align: center;
      font-size: 12px;
      color: var(--figma-color-text-secondary);
    }

    .references-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }

    .reference-card {
      padding: 16px;
      background: var(--figma-color-bg-secondary);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    .reference-info {
      flex: 1;
    }

    .reference-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .parameter-name {
      font-family: var(--font-stack);
      font-weight: 500;
      font-size: 11px;
    }

    .missing-count {
      font-size: 12px;
      color: var(--figma-color-text-secondary);
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
    }

    .variable-details {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .variable-item {
      padding: 8px;
      background: var(--figma-color-bg-tertiary);
      border-radius: 4px;
    }

    .variable-name {
      font-family: var(--font-stack);
      font-weight: 500;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .variable-value,
    .node-info,
    .location-info,
    .current-value {
      font-family: var(--font-stack);
      font-size: 11px;
      line-height: 16px;
      margin-top: 2px;
    }

    .select-button {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .empty-state {
      text-align: center;
      color: var(--figma-color-text-secondary);
      padding: 32px 16px;
    }
  </style>

  <script>
    console.clear(); // Clear previous logs
    console.log('UI script started');

    const { createApp } = Vue;
    
    createApp({
      data() {
        return {
          selectedScanType: 'vertical-gap',
          isScanning: false,
          scanProgress: 0,
          groupedReferences: {},
        }
      },
      methods: {
        async startScan() {
          this.isScanning = true;
          this.scanProgress = 0;
          this.groupedReferences = {};

          parent.postMessage({ 
            pluginMessage: { 
              type: 'scan-for-tokens',
              scanType: this.selectedScanType
            }
          }, '*');
        },
        cancelScan() {
          parent.postMessage({ 
            pluginMessage: { 
              type: 'cancel-scan' 
            }
          }, '*');
        },
        selectGroup(refs) {
          const nodeIds = refs.map(ref => ref.nodeId);
          parent.postMessage({ 
            pluginMessage: { 
              type: 'select-group',
              nodeIds
            }
          }, '*');
        },
        formatValue(value) {
          if (!value) return 'None';
          if (typeof value === 'object') {
            if ('r' in value && 'g' in value && 'b' in value) {
              return `RGB(${Math.round(value.r * 255)}, ${Math.round(value.g * 255)}, ${Math.round(value.b * 255)})`;
            }
            return JSON.stringify(value);
          }
          return String(value);
        }
      },
      mounted() {
        console.log('Vue app mounted');
        window.onmessage = (event) => {
          const msg = event.data.pluginMessage;
          if (!msg) return;

          switch (msg.type) {
            case 'scan-progress':
              this.scanProgress = msg.progress;
              break;
            case 'missing-references-result':
              this.groupedReferences = msg.references;
              this.isScanning = false;
              break;
            case 'scan-cancelled':
              this.isScanning = false;
              break;
            case 'error':
              console.error(msg.message);
              this.isScanning = false;
              break;
          }
        };
      }
    }).mount('#app');

    // Add this at the end of your Vue initialization
    document.getElementById('loading').style.display = 'none';
  </script>
</body>
</html>
